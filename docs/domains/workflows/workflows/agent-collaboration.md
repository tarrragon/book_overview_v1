# 🤖 Agent 協作規範

根據 Claude Code sub-agent 最佳實踐，本專案採用**文件先行的研究規劃模式**，所有 sub-agent 均為純研究員和規劃者，主線程負責所有實際實作工作。

## 📋 核心設計原則

**Sub-agent 最佳實踐應用**:

- **純研究規劃角色**: Sub-agent 專注於分析現有程式碼庫，提出實作計劃，絕不執行實際實作
- **上下文優化**: 透過檔案系統管理上下文，避免大量 token 消耗和上下文壓縮問題
- **主線程實作**: 所有程式碼修改、測試執行、檔案建立均由主線程執行，確保完整上下文

**工作流程模式**:

1. **主線程建立專案上下文檔案** (`docs/context/session_contexts/`)
2. **委派任務給專業 sub-agent 進行研究規劃**
3. **Sub-agent 閱讀上下文，產出詳細實作計劃** (`docs/context/agent_plans/`)
4. **主線程閱讀計劃並執行所有實際實作工作**
5. **更新上下文檔案，記錄進度和決策**

**工作流程控管**
無論是從主線程交接給Sub-agent或者從Sub-agent交付回主線程，都要做commit，不應該累積還沒commit的程式或者文件就把任務交付出去

## 🎯 Sub-agent 角色定位

### 🧠 知識管理層級 (新增知識捕獲層)

- **memory-network-builder** (🧠): 記憶網路架構師
  - 負責知識原子化捕獲、洞察連結建立、決策記錄管理
  - **觸發時機**: 每個TDD Phase完成後 + 專家審查發現重要洞察時
  - **核心職責**: 將洞察轉化為可連結的記憶單元、建立知識圖譜

### 🔍 專家審查層級 (品質把關層)

- **linux** (🔨): Linus Torvalds 程式碼品質專家
  - 負責設計合理性審查、複雜度評估、"Good Taste"品質把關
  - **觸發時機**: Phase 1設計完成後 + Phase 4重構完成後
  - **核心職責**: 拒絕過度設計、消除特殊情況、確保實用主義
  - **知識協作**: 與memory-network-builder協作記錄"Good Taste"設計模式

- **john-carmack** (⚡): John Carmack 效能系統架構師
  - 負責架構效能審查、熱路徑優化、確定性設計評估
  - **觸發時機**: Phase 2測試完成後 + Phase 3實作完成後
  - **核心職責**: 熱路徑識別、控制流程簡化、狀態管理純度
  - **知識協作**: 與memory-network-builder協作記錄效能優化洞察和架構模式

### 🔄 TDD協作流程導向層級

- **lavender-interface-designer** (🎨): 功能設計師專家 - 對應TDD Phase 1
  - 負責功能規劃和需求分析，建立清楚的功能需求和設計規範
  - 建立工作日誌：`docs/work-logs/vX.X.X-feature-design.md`
  - 交接標準：功能需求清楚、API介面定義完整、驗收標準明確

- **sage-test-architect** (🧪): 測試工程師專家 - 對應TDD Phase 2
  - 根據功能設計，設計並實作完整的測試案例
  - 更新工作日誌：新增測試設計章節到既有工作日誌
  - 交接標準：測試案例實作為程式碼、測試覆蓋率達標、測試程式碼品質良好

- **pepper-test-implementer** (💻): TDD實作規劃師專家 - 對應TDD Phase 3
  - 負責實作策略規劃、權宜方案識別、技術債務記錄，提供詳細實作指引
  - 更新工作日誌：新增實作記錄章節到既有工作日誌
  - 交接標準：實作策略完整規劃、程式碼範例提供、開發過程設計完整記錄

- **cinnamon-refactor-owl** (🏗️): 重構設計師專家 - 對應TDD Phase 4
  - 執行「🧠 TDD 驅動重構方法論」完整流程，改善程式碼品質和架構
  - 建立重構工作日誌：按照重構方法論要求建立獨立工作日誌
  - 交接標準：重構方法論完整執行、技術債務已解決、重構經驗記錄完整

### 🎯 專業支援層級

- **rosemary-project-manager** (📋): 敏捷專案管理專家
  - 文件先行策略監督，最小任務分派，跨Agent協調
  - 確保嚴格遵循敏捷開發原則，維護高頻工作日誌更新

- **project-compliance-agent**: 執行層級合規專家
  - 完成小功能或TDD循環後立即執行合規檢查，版本控制標準驗證
  - 操作合規驗證，在rosemary-project-manager策略指導下工作

### 🔧 架構與技術專家層級

- **basil-event-architect**: 事件驅動架構專家
  - 設計和維護事件驅動架構模式、事件命名規範、模組通訊協議
  - **必須主動使用**於架構設計和事件系統開發

- **oregano-data-miner**: 資料提取專家
  - 網頁抓取、DOM操作、資料處理專家
  - **必須主動使用**於資料提取策略、資料清理和驗證

- **ginger-performance-tuner**: 效能優化專家
  - 效能分析、記憶體優化、載入速度改善專家
  - **必須主動使用**於效能分析和Chrome Extension效能優化

- **coriander-integration-tester**: 系統整合測試專家
  - 端到端測試、跨元件整合測試、系統級測試專家
  - **必須主動使用**於測試元件互動和完整使用者工作流程

## 📁 上下文管理機制

**檔案系統上下文管理**:

- **上下文檔案**: `docs/context/session_contexts/context_session_X.md`
- **Agent 規劃**: `docs/context/agent_plans/[類別]/[檔案名稱].md`
- **標準模板**: `docs/context/templates/` 提供統一格式

**🔄 TDD流程Agent專用路徑**:

- **功能設計規劃**: `docs/context/agent_plans/feature-design/[功能名稱]-design.md`
- **測試策略規劃**: `docs/context/agent_plans/test-architecture/[功能名稱]-tests.md`
- **實作策略規劃**: `docs/context/agent_plans/implementation/[功能名稱]-impl.md`
- **重構策略規劃**: `docs/context/agent_plans/refactoring/[功能名稱]-refactor.md`

**🔍 專家審查專用路徑**:

- **Linux設計審查**: `docs/context/expert_reviews/linux/[功能名稱]-design-review.md`
- **雙專家測試審查**: `docs/context/expert_reviews/combined/[功能名稱]-test-review.md`
- **John Carmack架構審查**: `docs/context/expert_reviews/john-carmack/[功能名稱]-arch-review.md`
- **Linux最終審查**: `docs/context/expert_reviews/linux/[功能名稱]-final-review.md`

**🧠 知識管理專用路徑**:

- **Memory儲存目錄**: `memory/` (專案根目錄)
- **Memory檔案命名**: 使用結論導向的中文標題作為檔名
- **Memory連結圖譜**: 透過 `[[memory-id]]` 格式建立知識連結
- **Memory分類索引**: 依據type (decision/implementation/learning/concept/issue) 自動分類

**📚 文件責任合規要求**:
所有Agent輸出必須嚴格遵循 [📚 專案文件責任明確區分](../guidelines/document-responsibilities.md) 章節的標準，特別是工作日誌品質要求。

**🏗️ 重構Agent特殊要求**:
cinnamon-refactor-owl必須按照「🧠 TDD 驅動重構方法論」執行：

- 輸出預期管理計劃，包含測試結果預期
- 記錄預期偏差分析和調整決策
- 提供完整的重構學習總結

**標準輸出格式**:

```
我已經完成 [任務名稱] 的 [TDD階段] 規劃工作。

📋 **規劃檔案**: `docs/context/agent_plans/[類別]/[檔案名稱].md`
🔄 **上下文更新**: 已更新專案上下文檔案
🔍 **主要發現**: [重要發現簡要總結]
🎯 **建議行動**: [對主線程的具體建議]
📚 **文件合規**: 規劃內容符合工作日誌品質標準

**下一階段準備**:
- [ ] [列出為下一TDD階段準備的交接檢查點]

請在繼續實作前先閱讀規劃檔案並確認交接標準。
```

## 🔄 實作反饋與協作機制

**主線程實作過程支援**:

- **即時諮詢機制**: 實作過程中遇到規劃外問題，主線程可建立新的上下文檔案快速諮詢專業Agent
- **實作驗證回饋**: 完成關鍵實作步驟後，可請Agent檢視實作結果與規劃的一致性
- **問題解決支援**: 遇到技術難題時，Agent提供深度分析和替代方案建議

**反饋檔案標準格式**: `docs/context/implementation_feedback/[功能名稱]-[問題類型].md`

- **問題描述**: 遇到的具體技術問題或與規劃的偏差
- **當前狀況**: 已嘗試的解決方法和結果
- **諮詢需求**: 希望Agent提供的具體協助類型

**Agent學習改進機制**:

- **規劃品質追蹤**: 收集主線程實作過程中的問題，改進未來規劃品質
- **預測準確度**: 分析實作結果與規劃預期的差異，提升技術判斷準確度
- **協作效率優化**: 根據實作反饋調整規劃細節程度和重點領域

## ⚠️ 嚴格禁止事項

### Sub-agent 絕對禁止行為

- ❌ **實作程式碼**: 不得修改、建立或刪除任何程式碼檔案
- ❌ **執行測試**: 不得運行任何測試指令或驗證程式碼
- ❌ **檔案操作**: 不得建立非規劃文件的任何檔案
- ❌ **工具執行**: 不得呼叫實作相關的開發工具

### 📚 文件責任違規行為

- ❌ **違反文件責任區分**: 不得產出使用者導向CHANGELOG內容
- ❌ **混淆文件用途**: 不得將技術分析寫成TODO.md格式
- ❌ **使用抽象描述**: 禁止"提升穩定性"、"強化品質"等無法驗證的描述
- ❌ **跳過工作日誌要求**: 所有規劃必須符合工作日誌品質標準

### 🔄 TDD流程違規行為

- ❌ **跨階段執行**: 不得跨越TDD階段或跳過前置階段
- ❌ **違反交接標準**: 不得輸出不符合階段交接檢查點的內容
- ❌ **忽略角色職責**: 必須嚴格按照對應TDD階段的角色職責執行

### 🏗️ 重構Agent特殊禁止事項

- ❌ **跳過預期管理**: 不得直接提供實作步驟，必須先建立預期管理計劃
- ❌ **忽略偏差分析**: 必須記錄預期與實際結果的對比分析

### 🔍 專家審查特殊要求

- ✅ **技術判斷必須明確**: Linux必須給出"Good taste/Acceptable/Garbage"判斷
- ✅ **具體改善建議**: 不得只說"需要改善"，必須提供具體方向
- ✅ **效能影響評估**: John Carmack必須評估熱路徑和確定性設計
- ✅ **審查結果可追蹤**: 所有專家建議必須記錄實施狀況
- ❌ **禁止和稀泥**: 專家必須給出明確技術判斷，不得為了"友善"模糊判斷

### 🧠 Memory Network Builder特殊要求

- ✅ **結論導向標題**: 所有Memory標題必須表達具體結論，不得使用主題式標題
- ✅ **原子化知識**: 每個Memory只記錄一個核心洞察，不得混合多個概念
- ✅ **明確連結關係**: 必須建立基於/導致/相關的明確連結，不得孤立存在
- ✅ **具體觸發記錄**: 必須記錄Memory的觸發原因和專家來源
- ❌ **禁止主題式命名**: 不得使用"快取策略"等主題式標題
- ❌ **禁止內容冗長**: 不得將完整分析過程放入Memory，保持精簡
- ❌ **禁止缺失連結**: 每個Memory必須有至少一個有意義的連結關係

### 主線程必須負責

- ✅ **所有程式碼實作**: 包括測試、功能、重構
- ✅ **檔案系統操作**: 建立、修改、刪除程式碼檔案
- ✅ **測試執行**: 運行測試套件、驗證功能
- ✅ **工具執行**: 使用 linter、builder、部署工具
- ✅ **除錯和問題解決**: 處理所有技術問題
- ✅ **文件責任執行**: 按照「📚 專案文件責任明確區分」更新CHANGELOG、TODO、工作日誌

## 🔄 Agent與TDD流程整合

**TDD流程執行方式**: Agent 嚴格按照 [🤝 TDD 協作開發流程](tdd-collaboration-flow.md) 章節定義的四個階段執行，每個 Agent 對應一個 TDD Phase。

**Agent 與 TDD Phase 對應關係**:

- **lavender-interface-designer** → TDD Phase 1 (功能設計)
- **sage-test-architect** → TDD Phase 2 (測試設計)
- **pepper-test-implementer** → TDD Phase 3 (實作規劃)
- **cinnamon-refactor-owl** → TDD Phase 4 (重構設計)

**Agent 特殊要求**:

- **工作日誌格式**: 必須符合 [📚 專案文件責任明確區分](../guidelines/document-responsibilities.md) 章節的工作日誌標準
- **交接標準**: 嚴格遵循 TDD 協作流程中定義的各階段交接檢查點
- **品質要求**: 輸出內容必須達到詳細、分析性、教學性標準

### Agent協作品質驗證

**品質檢查標準**: 參考 [🤝 TDD 協作開發流程](tdd-collaboration-flow.md) 章節的「完整協作檢查清單」和 [📚 專案文件責任明確區分](../guidelines/document-responsibilities.md) 章節的品質標準。

## 🔍 專家審查標準格式與輸出要求

### 📋 專家審查通用格式標準

**所有專家審查必須包含的核心要素**:

1. **明確技術判斷**: 不得模糊或和稀泥，必須給出清楚的評級
2. **具體改善建議**: 提供可執行的具體改善方向
3. **風險點識別**: 指出潛在的技術和架構風險
4. **實施優先級**: 建議的實施順序和重要性評級

### 🔨 Linux專家審查標準格式

**適用階段**: Phase 1 (設計審查) + Phase 4 (最終審查)

**必要輸出格式**:

```markdown
# Linux專家審查報告

## 技術判斷評級

**Taste Score**: Good taste / Acceptable / Garbage
**實用性評估**: Pragmatic / Acceptable / Over-engineered  
**複雜度評估**: Simple / Reasonable / Too Complex

## 核心分析 (Linus三層思考)

**第一層 - 資料結構分析**:

- 核心資料關係: [最關鍵的資料結構設計]
- 資料流動: [資料擁有權和修改權分析]
- 優化機會: [不必要的資料複製或轉換]

**第二層 - 特殊情況識別**:

- 發現的if/else分支: [列出主要條件分支]
- 真正業務邏輯 vs 設計補丁: [區分必要和不必要的複雜度]
- 消除建議: [如何重新設計資料結構來消除分支]

**第三層 - 複雜度檢查**:

- 功能本質: [用一句話說明功能核心]
- 概念數量: [當前解決方案使用的概念數]
- 簡化路徑: [減半複雜度的具體方法]

## 關鍵問題與建議

**致命問題** (如有): [直接指出最差的設計部分]

**改善方向**:

- [消除特殊情況的具體方法]
- [程式碼行數減少的具體建議]
- [資料結構改善的具體方向]

## 實施建議

**優先級**: Critical / High / Medium / Low
**預估影響**: [對整體架構的影響評估]
**實施複雜度**: [修改的預估工作量]
```

### ⚡ John Carmack專家審查標準格式

**適用階段**: Phase 2 (測試審查) + Phase 3 (架構審查)

**必要輸出格式**:

```markdown
# John Carmack效能架構審查報告

## 效能系統評估

**熱路徑評估**: Clear / Acceptable / Obfuscated
**確定性設計**: Strong / Moderate / Weak
**控制流程**: Flat / Acceptable / Too Deep
**狀態管理**: Pure / Acceptable / Side-effect Heavy

## 關鍵路徑分析

**熱路徑識別**:

- 主要執行路徑: [關鍵效能路徑描述]
- 瓶頸點: [潛在效能瓶頸識別]
- 最壞情況: [最壞情況效能分析]

**控制流程分析**:

- 條件分支深度: [當前巢狀層次]
- 扁平化機會: [可簡化的控制邏輯]
- 狀態流動: [狀態變化的可預測性]

**架構邊界評估**:

- 抽象層次: [當前抽象是否合理]
- 職責分離: [組件間職責劃分清晰度]
- 耦合度: [組件間依賴複雜度]

## 函數式設計機會

**純函數機會**: [可轉為純函數的代碼識別]
**副作用最小化**: [全域狀態和副作用減少建議]
**資料不可變性**: [不可變資料結構的應用機會]

## 效能優化建議

**立即改善**:

- [熱路徑優化的具體方向]
- [控制流程扁平化方法]
- [狀態管理改善策略]

**架構改善**:

- [架構邊界調整建議]
- [函數式設計導入方向]
- [確定性行為強化方法]

## 風險評估

**效能風險**: [潛在的效能瓶頸風險]
**維護風險**: [複雜度累積的維護風險]
**擴展風險**: [架構擴展性的限制風險]
```

### 👥 雙專家聯合審查格式

**適用階段**: Phase 2 (測試品質審查) + 重大架構決策

**必要輸出格式**:

```markdown
# 雙專家聯合審查報告

## Linux專家觀點

[按照Linux專家標準格式輸出]

## John Carmack專家觀點

[按照John Carmack專家標準格式輸出]

## 聯合結論

**技術判斷一致性**:

- 共識點: [兩位專家一致認同的判斷]
- 分歧點: [兩位專家觀點不同的部分]
- 最終建議: [基於雙專家討論的最終建議]

**優先級排序**:

1. [最高優先級改善項目]
2. [次優先級改善項目]
3. [建議改善項目]

**實施路徑**:

- 第一階段: [立即必須處理的項目]
- 第二階段: [中期改善項目]
- 第三階段: [長期優化項目]
```

### ✅ 專家審查品質驗收標準

**Linux專家審查驗收**:

- [ ] 提供明確的"Good taste/Acceptable/Garbage"判斷
- [ ] 具體分析資料結構設計合理性
- [ ] 識別並提供特殊情況消除方法
- [ ] 給出具體的複雜度簡化建議
- [ ] 評估向後相容性影響

**John Carmack專家審查驗收**:

- [ ] 明確識別熱路徑和效能關鍵點
- [ ] 評估控制流程的扁平化程度
- [ ] 分析狀態管理的純度和副作用
- [ ] 提供確定性設計改善建議
- [ ] 評估架構邊界的合理性

**雙專家聯合審查驗收**:

- [ ] 兩位專家觀點完整呈現
- [ ] 對分歧點有明確討論和結論
- [ ] 提供明確的實施優先級排序
- [ ] 給出階段性實施路徑建議

---

**🔗 相關文件連結**:
- [返回主指導文件](../../CLAUDE.md)
- [TDD 協作開發流程](tdd-collaboration-flow.md)
- [專案文件責任明確區分](../guidelines/document-responsibilities.md)
- [事件驅動架構規範](../architecture/event-driven-architecture.md)