# 上下文管理機制

根據 Claude Code sub-agent 最佳實踐，本目錄用於管理 agent 與主線程之間的上下文資訊交換。

## 📋 核心原則

### Agent 角色定位

- **Sub-agent**: 純研究員和規劃者，絕不執行實際實作
- **主線程**: 負責所有實際程式碼實作和修改
- **檔案系統**: 作為上下文管理的載體

### 工作流程

1. **主線程建立專案上下文檔案**
2. **委派任務給專業 sub-agent**
3. **Sub-agent 讀取上下文，進行研究和規劃**
4. **Sub-agent 將計劃儲存為獨立檔案並更新上下文**
5. **主線程讀取計劃並執行實際實作**

## 📁 目錄結構

```
docs/context/
├── README.md                    # 上下文管理機制說明
├── session_contexts/            # 專案階段上下文檔案
│   ├── context_session_1.md     # 第一階段專案上下文
│   └── context_session_X.md     # 後續階段上下文
├── agent_plans/                # Agent 規劃輸出檔案
│   ├── architecture/           # 架構設計規劃
│   ├── testing/               # 測試策略規劃
│   ├── performance/           # 效能優化規劃
│   ├── ui_design/             # UI/UX 設計規劃
│   └── data_extraction/       # 資料提取規劃
└── templates/                  # 標準檔案模板
    ├── context_template.md    # 上下文檔案模板
    └── agent_plan_template.md # Agent 計劃檔案模板
```

## 📝 檔案格式規範

### 上下文檔案格式 (`context_session_X.md`)

```markdown
# 專案上下文 Session X

## 專案狀態

- **當前版本**: vX.X.X
- **主要目標**: [描述當前階段目標]
- **進度狀態**: [進度描述]

## 架構資訊

- **核心架構**: [架構描述]
- **技術棧**: [技術棧清單]
- **重要約束**: [技術限制和約束]

## 當前任務

- **任務清單**: [具體任務列表]
- **優先級**: [任務優先級]
- **依賴關係**: [任務間依賴]

## Agent 工作記錄

- **已完成 Agent 工作**: [Agent 完成的規劃清單]
- **待執行計劃**: [等待主線程執行的計劃清單]
- **阻礙點**: [遇到的問題和阻礙]

## 決策記錄

- **架構決策**: [重要的架構決策]
- **技術選擇**: [技術選擇的理由]
- **變更記錄**: [重要變更和影響]
```

### Agent 計劃檔案格式

```markdown
# [Agent 名稱] 規劃報告

## 任務概述

- **任務目標**: [明確的任務目標]
- **分析範圍**: [分析的範圍和邊界]
- **預期成果**: [期望的輸出成果]

## 分析結果

- **現狀分析**: [對當前狀況的分析]
- **問題識別**: [發現的問題和挑戰]
- **機會點**: [可以改善的機會]

## 實作計劃

- **設計方案**: [詳細的設計方案]
- **實作步驟**: [具體的實作步驟]
- **技術選擇**: [技術方案的選擇和理由]
- **風險評估**: [潛在風險和緩解策略]

## 資源需求

- **技術資源**: [需要的技術資源]
- **依賴項目**: [依賴的其他組件或服務]
- **時程估算**: [預估的實作時間]

## 驗收標準

- **功能需求**: [功能驗收標準]
- **品質需求**: [品質驗收標準]
- **測試策略**: [測試和驗證方法]

## 後續建議

- **優化方向**: [後續可以優化的方向]
- **監控指標**: [需要監控的指標]
- **維護考量**: [維護和更新的考量]
```

## 🔄 Agent 輸出標準格式

每個 sub-agent 完成工作後，必須以以下格式回報主線程：

```
我已經完成 [任務名稱] 的分析和規劃工作。

📋 **輸出檔案**: `docs/context/agent_plans/[類別]/[檔案名稱].md`
🔄 **上下文更新**: 已更新 `docs/context/session_contexts/context_session_X.md`
📊 **主要發現**: [重要發現的簡要總結]
🎯 **建議行動**: [對主線程的建議行動]

請在繼續實作前先閱讀規劃檔案。
```

## ⚠ 重要注意事項

1. **Sub-agent 絕對禁止**：
   - 直接修改程式碼
   - 執行測試
   - 建立新檔案（除了規劃文件）
   - 呼叫實作相關的工具

2. **主線程責任**：
   - 閱讀所有 agent 規劃文件
   - 執行所有實際實作工作
   - 更新專案上下文檔案
   - 處理所有技術問題和除錯

3. **品質保證**：
   - 所有 agent 規劃必須詳細且可執行
   - 主線程實作必須嚴格按照規劃執行
   - 上下文檔案必須即時更新
