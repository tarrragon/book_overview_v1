# 主線程自主合規框架

## 🎯 核心原則

基於 Claude Code 最佳實踐，主線程擁有完整的實作上下文，是執行合規檢查和文件更新的最佳人選。

### 設計理念
- **第一手資訊**：基於實際實作過程進行檢查
- **即時同步**：開發過程中即時更新文件
- **完整上下文**：了解所有技術決策和問題解決過程
- **自我負責**：開發者對自己的工作品質負完全責任

## 🔄 TDD 循環整合合規檢查

### 🔴 Red 階段合規檢查

**測試品質檢查**：
- [ ] 測試命名清晰，描述測試場景
- [ ] 測試程式碼語法正確
- [ ] 測試確實失敗（紅燈狀態）
- [ ] 失敗原因符合預期（功能尚未實作）
- [ ] 測試涵蓋主要使用場景

**文件更新**：
- [ ] 記錄測試設計的思考過程
- [ ] 更新技術決策記錄（如有重要決策）

### 🟢 Green 階段合規檢查

**實作品質檢查**：
- [ ] 所有測試通過（綠燈狀態）
- [ ] 實作符合最小實作原則
- [ ] 暫時實作已標註 `//todo:` 註記
- [ ] 程式碼可以正常執行
- [ ] 沒有引入不必要的複雜性

**安全性檢查**：
- [ ] 沒有硬編碼的敏感資訊
- [ ] 輸入驗證適當
- [ ] 錯誤處理不洩漏系統資訊

**文件更新**：
- [ ] 記錄實作過程中的重要決策
- [ ] 更新已知的技術債務清單
- [ ] 記錄遇到的問題和解決方案

### 🔵 Refactor 階段合規檢查

**程式碼品質檢查**：
- [ ] 所有測試仍然通過
- [ ] 消除了所有 `//todo:` 標註的問題
- [ ] 程式碼符合專案編碼規範
- [ ] 沒有明顯的設計問題
- [ ] 效能沒有明顯退化
- [ ] 符合 SOLID 原則

**架構一致性檢查**：
- [ ] 與專案其他部分設計模式一致
- [ ] 模組職責清晰且單一
- [ ] 依賴關係合理且可測試

**文件更新**：
- [ ] 記錄重構的原因和效果
- [ ] 更新架構決策記錄
- [ ] 記錄效能改善或其他收益

## 📋 循環完成後完整合規檢查

### 版本控制合規

**Git 操作檢查**：
- [ ] 執行 `git status` 確認變更狀態
- [ ] 執行 `git diff` 檢查變更內容
- [ ] Commit 訊息符合 Conventional Commits 格式
- [ ] 變更範圍與功能描述一致

**程式碼檢查**：
```bash
npm run lint        # 程式碼風格檢查
npm run test        # 測試套件執行
npm run build       # 建置驗證
```

### 文件同步更新

**必須更新的文件**：
1. **todolist.md**: 任務進度狀態
2. **work-logs/vX.X.X-work-log.md**: 詳細工作記錄
3. **CHANGELOG.md**: 版本變更記錄

**文件品質檢查**：
- [ ] 工作日誌反映真實開發過程
- [ ] 技術決策有清楚的理由說明
- [ ] 問題發現和解決過程詳細記錄
- [ ] 重構思路和效果有具體描述

### 測試覆蓋驗證

**覆蓋率檢查**：
```bash
npm run test:coverage
```

**品質標準**：
- [ ] 單元測試覆蓋率 100%
- [ ] 整合測試覆蓋主要流程
- [ ] E2E 測試涵蓋核心場景

## 📊 品質度量自檢

### 程式碼度量
- [ ] 函數長度不超過 30 行
- [ ] 圈複雜度不超過 10
- [ ] 重複程式碼不超過 3 次
- [ ] 技術債已適當標註或解決

### 效能度量
- [ ] 測試執行時間在 30 秒內
- [ ] 建置時間在 2 分鐘內
- [ ] 沒有 linter 警告

### 安全度量
- [ ] 沒有已知的安全漏洞
- [ ] 權限請求符合最小權限原則
- [ ] 資料處理符合隱私保護要求

## 🔧 自動化檢查工具

### 建議的檢查腳本

**快速檢查**：
```bash
#!/bin/bash
# quick-check.sh - TDD 階段間快速檢查
npm test && npm run lint
```

**完整檢查**：
```bash
#!/bin/bash
# full-check.sh - 循環完成後完整檢查
npm test && \
npm run test:coverage && \
npm run lint && \
npm run build && \
echo "✅ 所有檢查通過，可以提交"
```

### Git Hooks 整合
建議在 `.git/hooks/pre-commit` 中整合基本檢查：
```bash
#!/bin/bash
npm test && npm run lint
```

## 📝 文件更新模板

### 工作日誌更新模板
```markdown
## [日期] TDD 循環：[功能描述]

### 🔴 Red 階段
- **測試設計思路**：[測試設計的考量]
- **測試場景**：[涵蓋的測試場景]
- **技術決策**：[重要的技術選擇]

### 🟢 Green 階段
- **實作策略**：[選擇的實作方法]
- **遇到問題**：[實作過程中遇到的問題]
- **解決方案**：[問題的解決方法]
- **權宜措施**：[標註 //todo: 的暫時實作]

### 🔵 Refactor 階段
- **重構目標**：[重構的目標和原因]
- **改善項目**：[具體的改善內容]
- **效果驗證**：[重構效果的驗證]
- **架構決策**：[重要的架構調整]

### 📊 品質檢查
- **測試覆蓋率**：[覆蓋率數據]
- **程式碼品質**：[linter 檢查結果]
- **效能影響**：[效能變化評估]

### 🎯 下一步計劃
- **後續工作**：[下個循環的計劃]
- **技術債處理**：[需要處理的技術債]
```

## ⚠️ 常見合規陷阱

### 避免的行為
- ❌ **跳過檢查**：因為趕時間而省略合規檢查
- ❌ **事後補文件**：完成多個循環後才更新文件
- ❌ **簡化記錄**：工作日誌過於簡略，缺乏重要資訊
- ❌ **忽略警告**：忽略 linter 或測試的警告訊息

### 品質保證
- ✅ **即時記錄**：開發過程中即時記錄重要資訊
- ✅ **詳細描述**：記錄決策的原因和考量
- ✅ **完整檢查**：不省略任何檢查步驟
- ✅ **持續改進**：定期回顧和優化檢查流程

## 🎯 成功指標

### 短期指標
- 每個 TDD 循環都完成完整的合規檢查
- 文件與實作保持 100% 同步
- 所有自動化檢查通過

### 長期指標
- 技術債務得到有效控制
- 程式碼品質持續提升
- 開發效率穩定或改善