# APP版書庫管理系統用例文件

## 概述

本文件詳細描述APP版書庫管理系統的各項功能用例，採用**簡潔優先、功能可選**的設計理念。系統提供簡潔模式和管理模式雙介面，讓一般使用者能輕鬆瀏覽書庫，進階使用者可使用完整分類功能。

### 核心設計原則

- **異步優先**：資料立即呈現，詳細資訊背景補充
- **雙模式設計**：簡潔模式（預設）+ 管理模式（進階）
- **可選功能**：分類、標籤、筆記等為選用功能，不強制使用
- **平台整合**：統一管理數位和實體書籍
- **場景驅動錯誤處理**：基於實際使用場景分析錯誤情況，提供明確的恢復策略

### 錯誤處理設計參照

本文件中的所有用例都遵循統一的錯誤處理設計原則。詳細的錯誤處理流程、策略和實作指引請參考：
**[APP 錯誤處理系統設計文件](./app-error-handling-design.md)**

該設計文件說明了：
- 如何從具體用例分析可能的錯誤情況
- 錯誤分類、處理流程和恢復策略
- 使用者溝通和體驗設計原則
- 測試驅動的錯誤驗證方法

---

## UC-01: 匯入Chrome Extension書庫資料

### 基本資訊
- **用例ID**: UC-01
- **用例名稱**: 匯入Chrome Extension書庫資料  
- **主要行為者**: 使用者
- **利益關係人**: 使用者（獲得統一書庫管理）
- **前置條件**: 
  - 使用者已安裝APP版書庫管理系統
  - 使用者擁有Chrome Extension匯出的JSON檔案
- **成功保證**: 所有書籍立即可在簡潔模式書庫中瀏覽，詳細資訊背景補充

### 主要成功場景

1. **選擇檔案**
   - 使用者點擊「匯入資料」按鈕
   - 系統開啟檔案選擇器
   - 使用者選擇JSON檔案並確認

2. **檔案驗證與立即匯入**
   - 系統讀取並驗證JSON檔案格式
   - 檢查必要欄位：id, title, cover
   - **立即批量插入資料庫**：設定source_type為`digital`，platform_id為Readmoo
   - 顯示匯入成功訊息：「成功匯入 X 本書籍」

3. **背景資料補充**
   - **異步啟動**：為每本書籍查詢Google Books API
   - 補充作者、出版社、ISBN、描述等詳細資訊
   - 更新封面圖片URL（如果Google Books有更高解析度版本）
   - 使用者在簡潔模式下可看到載入指示器

4. **進入簡潔模式書庫**
   - 自動跳轉到簡潔模式書庫檢視
   - 顯示：封面、書名、Readmoo平台圖標
   - 背景補充資訊時顯示載入動畫
   - 使用者可立即開始瀏覽，無需等待API完成

### 替代流程

**3a. JSON格式錯誤**
- 3a1. 系統偵測到格式不符（觸發 DATA_ERROR 分類）
- 3a2. 自動分析錯誤類型：檔案編碼問題、JSON 語法錯誤、或結構不符合預期
- 3a3. 顯示具體錯誤訊息：「檔案格式不正確，請確認為Chrome Extension匯出的JSON檔案」
- 3a4. **恢復策略**：提供檔案格式檢查工具或示範正確格式
- 3a5. **錯誤學習**：記錄格式錯誤模式以改善未來檔案驗證（參照 UC-08 錯誤學習機制）
- 3a6. 返回檔案選擇步驟，保持使用者資料完整性

**3b. 重複書籍處理**
- 3b1. 系統偵測到重複ID的書籍（觸發 DATA_ERROR 但嚴重程度為 MINOR）
- 3b2. **智慧判斷**：自動分析書籍資訊是否有更新（時間戳、內容完整性）
- 3b3. 詢問使用者處理策略：「跳過重複」、「覆蓋現有」、「合併資訊」、「取消匯入」
- 3b4. 根據使用者選擇執行對應動作，保持資料一致性
- 3b5. **預防性措施**：記錄重複模式，在未來匯入中提前預警

**3c. 匯入中斷**
- 3c1. 使用者點擊取消或APP被中斷（觸發 SYSTEM_ERROR）
- 3c2. **事務完整性保護**：系統立即執行完整回滾操作，確保資料庫一致性
- 3c3. **恢復狀態檢查**：驗證所有已插入的資料完全移除
- 3c4. 顯示「匯入已取消，資料已恢復到原始狀態」訊息
- 3c5. **中斷原因分析**：記錄中斷發生的階段和原因（參照錯誤處理設計的中斷恢復策略）

### 特殊需求
- **效能**: 1000本書籍的匯入時間應少於10秒
- **相容性**: 100%相容Chrome Extension v0.9.x匯出格式
- **錯誤恢復**: 支援匯入失敗自動回滾

---

## UC-02: 匯出書庫資料

### 基本資訊
- **用例ID**: UC-02
- **用例名稱**: 匯出書庫資料為JSON格式
- **主要行為者**: 使用者
- **前置條件**: 書庫中存在至少一本書籍
- **成功保證**: 產生與Chrome Extension相容的JSON檔案

### 主要成功場景

1. **啟動匯出**
   - 使用者進入「資料管理」頁面
   - 點擊「匯出資料」按鈕
   - 選擇匯出範圍：「全部書籍」或「指定來源」

2. **匯出設定**
   - 選擇匯出格式：JSON（預設）
   - 設定檔案名稱：「我的書庫_YYYYMMDD.json」
   - 選擇儲存位置

3. **資料處理**
   - 系統查詢符合條件的書籍
   - 轉換為Chrome Extension相容格式
   - 產生JSON檔案

4. **完成匯出**
   - 顯示匯出成功訊息
   - 提供「分享檔案」和「查看位置」選項
   - 記錄匯出歷史

### 替代流程

**1a. 空書庫**
- 1a1. 系統偵測書庫為空（觸發 DATA_ERROR，嚴重程度 MINOR）
- 1a2. **狀態確認**：額外檢查是否有隱藏或軟刪除的書籍記錄
- 1a3. 顯示提示：「書庫中沒有書籍，無法匯出」
- 1a4. **建設性引導**：提供「匯入資料」快速連結和「開始新增書籍」引導
- 1a5. **使用者體驗考量**：記錄空書庫匯出嘗試，用於改善新使用者引導流程

**3a. 儲存空間不足**
- 3a1. 系統檢測到儲存空間不足（觸發 SYSTEM_ERROR，嚴重程度 MODERATE）
- 3a2. **智慧分析**：計算所需空間大小，與可用空間對比，提供具體數據
- 3a3. **多重解決方案**：
  - 提示使用者清理空間（顯示可清理的快取大小）
  - 建議選擇其他儲存位置（雲端、外部儲存）
  - 提供分批匯出選項（減少單次檔案大小）
- 3a4. **恢復策略**：暫時壓縮匯出格式或移除非必要的中繼資料
- 3a5. 使用者確認後重新執行匯出，並記錄儲存問題發生頻率

---

## UC-03: ISBN條碼掃描新增書籍

### 基本資訊
- **用例ID**: UC-03
- **用例名稱**: 使用相機掃描ISBN條碼新增實體書籍
- **主要行為者**: 使用者
- **前置條件**: 
  - 裝置具備相機功能
  - 使用者已授權相機權限
- **成功保證**: 實體書籍立即新增到書庫，可在簡潔模式中瀏覽

### 主要成功場景

1. **啟動掃描**
   - 使用者點擊主畫面「掃描新增」按鈕
   - 系統檢查相機權限狀態
   - 開啟相機掃描介面

2. **掃描條碼與立即新增**
   - 畫面顯示相機預覽和掃描框
   - 使用者將ISBN條碼對準掃描框
   - 系統自動識別ISBN號碼並**立即新增書籍**
   - 顯示：「書籍已新增，正在查詢詳細資訊...」

3. **書籍立即可用**
   - 書籍以ISBN號碼作為暫時書名出現在書庫
   - 顯示「實體書」圖標和載入動畫
   - 設定source_type為`physical`
   - 使用者可立即在簡潔模式中看到新增的書籍

4. **背景資料補充**
   - **異步查詢**：系統調用Google Books API查詢詳細資訊
   - **自動更新**：查詢完成後更新書名、作者、封面、描述
   - **後續功能**：查詢失敗時使用Amazon API備用
   - **後續功能**：台灣出版品資料庫查詢

5. **無縫使用體驗**
   - 使用者無需等待API查詢完成
   - 書籍在背景更新時自動刷新顯示
   - 查詢失敗不影響書籍在書庫中的存在
   - 可隨時在管理模式中手動編輯資訊

### 替代流程

**1a. 相機權限未授權**
- 1a1. 系統檢測到權限未授權（觸發 PLATFORM_ERROR，嚴重程度 MODERATE）
- 1a2. **情境分析**：判斷是首次請求還是使用者曾拒絕權限
- 1a3. **階段式處理**：
  - 首次：顯示友善的權限請求說明和用途
  - 重複拒絕：直接引導到系統設定，並提供步驟截圖
- 1a4. **立即替代方案**：同時提供「手動輸入 ISBN」按鈕，避免阻塞使用者流程
- 1a5. 使用者授權後返回掃描介面，並記錄權限授予時間（參照 UC-08 使用者行為學習）

**2a. 無法識別條碼**
- 2a1. 系統無法識別條碼內容（觸發 DATA_ERROR，嚴重程度 MINOR）
- 2a2. **智慧診斷**：分析識別失敗原因（光線不足、角度不佳、條碼損壞、非 ISBN 條碼）
- 2a3. **動態提示**：根據診斷結果提供具體改善建議：
  - 「光線不足，請移至光線較佳處」
  - 「請調整角度，保持條碼水平」
  - 「條碼可能損壞，建議手動輸入」
- 2a4. **智慧重試**：自動調整相機設定（對焦、曝光）後重新嘗試
- 2a5. 提供「手動輸入ISBN」選項，支援 10 位或 13 位格式自動驗證
- 2a6. **學習改善**：記錄識別失敗模式，改善未來的條碼識別演算法

**3a. API查詢失敗**
- 3a1. Google Books API查詢無結果（觸發 NETWORK_ERROR 或 DATA_ERROR）
- 3a2. **多層級回退策略**：
  - 嘗試備用 API（Amazon、台灣出版品資料庫）
  - 使用不同的 ISBN 格式進行查詢（10位轉13位等）
  - 搜尋本地快取是否有相似條目
- 3a3. 顯示：「找不到該ISBN的書籍資訊，正在嘗試其他資料來源...」
- 3a4. **使用者選擇**：
  - 「手動填寫資訊」選項
  - 「稍後補充」選項（以 ISBN 作為暫時書名）
  - 「重新掃描」選項（可能是條碼識別錯誤）
- 3a5. **資料補強**：記錄無法查詢的 ISBN，定期批次重新查詢
- 3a6. 使用者可手動輸入書籍基本資訊，系統保存自動補充的提醒

**3b. 網路連接問題**
- 3b1. 系統偵測到網路不可用（觸發 NETWORK_ERROR，嚴重程度 MODERATE）
- 3b2. **連線診斷**：判斷是否為暫時性斷線、WiFi問題或行動數據限制
- 3b3. **智慧重試機制**：實施指數退避重試（2s, 4s, 8s），顯示重試進度
- 3b4. 顯示具體狀況：「網路連接異常，正在重試連線...（2/3 次嘗試）」
- 3b5. **多重選擇**：
  - 「繼續重試」（顯示預估等待時間）
  - 「離線新增」（說明後續自動補充機制）
  - 「檢查網路設定」（提供診斷工具）
- 3b6. **離線策略**：離線新增僅保存ISBN和時間戳，背景監控網路狀態自動觸發補充
- 3b7. **使用者通知**：網路恢復時主動通知並顯示補充進度（參照 UC-08 自動恢復機制）

**4a. 重複書籍**
- 4a1. 系統檢查到ISBN已存在（觸發 DATA_ERROR，嚴重程度 MINOR）
- 4a2. **智慧分析**：比較現有書籍資訊完整度與來源可信度
- 4a3. **詳細展示**：顯示現有與新資訊的對比差異表
- 4a4. **情境化建議**：
  - 現有資訊較完整：「該書籍已存在，資訊看起來很完整」
  - 新來源更可靠：「發現更完整的資訊，建議更新」
  - 存在衝突：「資訊有差異，請確認正確版本」
- 4a5. 使用者選擇：「保持現有」、「更新資訊」、「合併最佳資訊」或「取消操作」
- 4a6. **學習機制**：記錄重複處理偏好，未來類似情況提供智慧建議

### 特殊需求
- **掃描效能**: 條碼識別時間應少於2秒
- **離線支援**: 支援離線記錄ISBN，線上時補充資訊
- **手動輸入**: 提供備用的手動ISBN輸入方式

---

## UC-04: 關鍵字搜尋補充書籍資訊

### 基本資訊
- **用例ID**: UC-04
- **用例名稱**: 使用關鍵字搜尋補充現有書籍詳細資訊
- **主要行為者**: 使用者  
- **前置條件**: 
  - 書庫中存在資訊不完整的書籍
  - 網路連接可用
- **成功保證**: 現有書籍資訊更新完成，原始來源標記保持不變

### 主要成功場景

1. **選擇書籍**
   - 使用者在書庫列表中瀏覽書籍
   - 識別資訊不完整的書籍（缺少作者、出版社等）
   - 點擊書籍右上角的「補充資訊」按鈕

2. **啟動搜尋**
   - 系統以現有書名作為關鍵字
   - 顯示搜尋確認：「將搜尋：《原書名》」
   - 使用者可修改搜尋關鍵字
   - 點擊「開始搜尋」

3. **API查詢處理**
   - 調用Google Books API進行關鍵字搜尋
   - 設定maxResults=10取得候選清單
   - 顯示載入狀態：「正在搜尋相關書籍...」

4. **展示候選清單**
   - 以卡片方式展示搜尋結果：
     - 書名匹配度高的優先顯示
     - 每個候選項顯示：標題、作者、出版社、封面
     - 相似度指標（書名匹配百分比）
   - 提供「這是正確的書」按鈕

5. **確認並更新**
   - 使用者選擇正確的書籍
   - 顯示更新預覽：新舊資訊對比
   - 確認後系統更新資料庫記錄
   - 保持原始source標記不變
   - 更新updated_at時間戳

6. **完成更新**
   - 顯示成功訊息：「書籍資訊已更新」
   - 返回更新後的書籍詳細頁面
   - 高亮顯示新增/修改的資訊欄位

### 替代流程

**2a. 書名過於簡短或模糊**
- 2a1. 系統提醒：「書名過短可能影響搜尋精度」（觸發 DATA_ERROR，嚴重程度 MINOR）
- 2a2. **智慧擴展**：分析現有書籍資訊，自動組合可能的搜尋關鍵字（書名 + 已知作者）
- 2a3. **搜尋策略建議**：
  - 建議使用者手動輸入更完整的搜尋關鍵字
  - 提供作者名字輔助搜尋選項
  - 建議加入出版年份或出版社資訊
- 2a4. **預防性提示**：顯示搜尋技巧說明，提升未來搜尋成功率
- 2a5. **記錄改善**：記錄短書名的搜尋效果，優化未來的最小長度建議

**4a. 無相關搜尋結果**
- 4a1. Google Books API返回空結果（觸發 DATA_ERROR，嚴重程度 MODERATE）
- 4a2. **多層級搜尋策略**：
  - 自動嘗試移除特殊字符和標點符號重新搜尋
  - 使用模糊搜尋和相似度匹配算法
  - 嘗試使用書籍的其他已知資訊（作者、ISBN部分）
- 4a3. 顯示：「找不到相關書籍，正在嘗試其他搜尋策略...」
- 4a4. **建設性選項**：
  - 「調整搜尋關鍵字」（提供搜尋建議和技巧）
  - 「手動編輯資訊」（直接編輯書籍資訊）
  - 「稍後再試」（加入待補充清單）
  - 「使用其他資料源」（如果有備用API）
- 4a5. **學習機制**：記錄無結果的搜尋模式，改善搜尋算法和建議系統

**4b. 搜尋結果過多但相關性低**
- 4b1. 系統分析返回結果的相關性（觸發 DATA_ERROR，嚴重程度 MINOR）
- 4b2. **智慧過濾**：使用機器學習模型評估書名、作者、出版社的相似度
- 4b3. 若前3個結果匹配度都低於30%，觸發低相關性警告
- 4b4. **動態提示**：「搜尋結果可能不準確，建議調整關鍵字提升精確度」
- 4b5. **智慧建議**：
  - 分析現有書籍資訊，提供具體的精確搜尋建議（加入作者、出版年、ISBN部分等）
  - 顯示「為什麼推薦這些搜尋詞」的說明
  - 提供「搜尋技巧」教學連結
- 4b6. **使用者選擇**：「接受最佳匹配」、「調整搜尋」、「手動編輯」
- 4b7. **演算法改善**：記錄低相關性案例，訓練改善相關性評估模型

**5a. 使用者不確定正確書籍**
- 5a1. 使用者點擊「都不是我要的書」（觸發 DATA_ERROR，嚴重程度 MINOR）
- 5a2. **情境分析**：記錄使用者拒絕原因模式，改善未來搜尋準確度
- 5a3. **引導式幫助**：
  - 詢問：「沒有找到您要的書是因為：書名不符、作者不符、還是出版社不符？」
  - 根據回答調整搜尋策略和關鍵字權重
- 5a4. **多重選項**：
  - 「修改搜尋條件」（提供搜尋建議和技巧）
  - 「手動編輯」書籍資訊功能
  - 「跳過補充」（維持原有資訊，加入改善提醒）
  - 「查看更多結果」（擴展搜尋範圍）
- 5a5. **學習改善**：分析使用者拒絕的搜尋結果特徵，優化相關性算法

**5b. 選擇的書籍資訊有衝突**
- 5b1. 新資訊與現有資訊差異很大（觸發 DATA_ERROR，嚴重程度 MODERATE）
- 5b2. **智慧衝突分析**：
  - 計算各欄位的差異程度（書名相似度、作者一致性、出版年差距等）
  - 評估資料來源可信度（Google Books vs 使用者輸入 vs Chrome Extension）
  - 識別可能的同書不同版本情況
- 5b3. **視覺化衝突展示**：系統顯示衝突警告並以表格形式列出差異項目，高亮重大差異
- 5b4. **智慧建議**：
  - 對於可信度高的差異：「建議採用新資訊（來源：Google Books 官方資料）」
  - 對於版本差異：「可能為不同版本，建議保留現有並標註版本資訊」
  - 對於矛盾資訊：「資訊有矛盾，建議手動確認」
- 5b5. **靈活選擇**：
  - 使用者可選擇性接受部分更新（欄位級別選擇）
  - 選擇「保持原始資訊」並記錄拒絕原因
  - 選擇「手動合併」進行逐欄位編輯
- 5b6. **資料品質學習**：記錄衝突處理偏好，改善未來衝突預測和解決建議

### 批次補充場景

**UC-04b: 批次補充多本書籍資訊**

1. **選擇批次模式**
   - 使用者在書庫管理頁面選擇「批次補充」
   - 系統自動篩選資訊不完整的書籍
   - 顯示候選清單供使用者勾選

2. **批次處理**
   - 使用者選擇要處理的書籍（最多20本）
   - 系統逐一進行API搜尋
   - 顯示整體進度：「正在處理：5/12」

3. **逐一確認**
   - 對每本書顯示搜尋結果
   - 使用者可選擇「自動選擇最佳匹配」
   - 或者手動確認每本書的候選選項

4. **批次更新**
   - 完成所有確認後執行批次更新
   - 顯示更新統計：「已更新12本書籍資訊」
   - 提供詳細更新報告

### 特殊需求
- **搜尋精度**: 書名相似度計算算法
- **API限制**: 實作Google Books API請求頻率控制
- **離線準備**: 將搜尋需求加入待辦清單，線上時處理

---

## UC-05: 雙模式書庫展示系統

### 基本資訊
- **用例ID**: UC-05
- **用例名稱**: 簡潔模式與管理模式書庫展示
- **主要行為者**: 使用者
- **前置條件**: 書庫中存在書籍資料
- **成功保證**: 提供適合不同使用者需求的雙模式介面

## 5A. 簡潔模式（預設模式）

### 設計目標
- **快速瀏覽**：專注於書籍發現和基本資訊
- **零學習成本**：直觀的介面，無需學習複雜功能
- **效能優先**：載入速度快，滑動流暢

### 展示內容
1. **書籍卡片**
   - **封面圖片**：Google Books API獲取的高解析度封面
   - **書名**：清晰易讀的字體
   - **來源標示**：平台圖標（Readmoo/Kindle/實體書等）
   - **載入狀態**：背景補充資料時的載入動畫

2. **基本功能**
   - **搜尋**：頂部搜尋框，支援書名搜尋
   - **篩選**：按來源平台快速篩選
   - **排序**：按新增時間或書名排序
   - **模式切換**：右上角「管理模式」按鈕

### 互動行為
- 點擊書籍：顯示基本資訊彈窗（書名、作者、簡介）
- 長按書籍：快速操作選單（刪除、查看詳細資訊）
- 下拉重新整理：同步最新資料
- 無限滾動：流暢的書籍載入

## 5B. 管理模式（進階功能）

### 設計目標
- **完整功能**：提供所有分類和管理功能
- **批次操作**：高效的批量處理能力
- **個人化管理**：支援複雜的分類和標籤系統

### 展示內容
1. **詳細書籍卡片**
   - 完整書籍資訊（作者、出版社、ISBN等）
   - **重要程度顯示**：7級重要性標記
   - **閱讀進度**：狀態和進度條
   - **標籤系統**：彩色標籤顯示
   - **個人筆記**：筆記摘要預覽
   - **借閱資訊**：borrower_name等詳細資訊

2. **進階功能**
   - **多維度篩選**：組合重要程度、閱讀狀態、標籤等
   - **批次選擇**：多選書籍進行批量操作
   - **統計分析**：書庫統計和閱讀分析
   - **匯出功能**：選擇性資料匯出

### 管理操作
- **分類設定**：重要程度、閱讀狀態設定
- **標籤管理**：新增/編輯/刪除標籤
- **筆記編輯**：個人心得和筆記記錄
- **借閱管理**：記錄借書和還書資訊
- **批次操作**：批量修改分類或標籤

## 5C. 模式切換與記憶

### 切換機制
- **入口點**：右上角顯著的模式切換按鈕
- **即時切換**：無需重新載入，即時切換檢視
- **狀態保持**：切換時保持當前篩選和排序狀態

### 使用者偏好
- **預設模式記憶**：記住使用者偏好的預設模式
- **情境化建議**：新使用者推薦簡潔模式，進階使用者自動提供管理模式
- **功能引導**：在簡潔模式中適時提示管理模式功能

### 替代流程

**1a. 空書庫狀態**
- 1a1. 系統偵測到書庫為空（觸發 DATA_ERROR，嚴重程度 MINOR）
- 1a2. **新使用者體驗最佳化**：
  - 顯示友善的空狀態插圖和歡迎訊息
  - 自動判斷使用者類型（全新使用者 vs 資料遺失）
- 1a3. **情境化引導**：
  - 新使用者：提供功能介紹和入門教學
  - 可能的資料遺失：提供「恢復資料」和「檢查備份」選項
- 1a4. **明確行動指引**：
  - 「匯入 Chrome Extension 資料」（主要推薦）
  - 「掃描第一本書」（立即體驗）
  - 「查看功能介紹」（了解更多）
- 1a5. **預防性提醒**：記錄空書庫查看行為，用於改善使用者引導和保留策略

**3a. 搜尋無結果**
- 3a1. 使用者搜尋關鍵字無匹配結果（觸發 DATA_ERROR，嚴重程度 MINOR）
- 3a2. **智慧搜尋分析**：
  - 檢查是否因為篩選條件過於嚴格
  - 分析搜尋詞是否包含錯字或特殊字符
  - 確認是否有相似但不完全匹配的結果
- 3a3. **動態建議系統**：
  - 顯示「沒有找到完全匹配的書籍」
  - 提供相似搜尋建議：「您是否想搜尋：[相似詞建議]」
  - 顯示「也許您想找的是：[模糊匹配結果]」
- 3a4. **多重恢復選項**：
  - 「檢查拼寫並重新搜尋」
  - 「重置所有篩選條件」（如果有啟用篩選）
  - 「展開搜尋範圍」（包含作者、出版社等欄位）
  - 「查看最近新增的書籍」
- 3a5. **搜尋優化學習**：記錄無結果搜尋詞，改善搜尋建議和模糊匹配算法

**4a. 書籍資訊不完整**
- 4a1. 某些欄位為空（如作者、出版社）（觸發 DATA_ERROR，嚴重程度 MINOR）
- 4a2. **完整性智慧評估**：
  - 計算書籍資訊完整度百分比
  - 識別影響使用者體驗的關鍵缺失欄位（作者 > 出版社 > 描述）
  - 判斷資訊補充的優先級和急迫性
- 4a3. **視覺化提示策略**：
  - 顯示「資訊完整度：60%」等具體指標
  - 使用漸層色彩顯示資訊豐富程度
  - 優先顯示關鍵缺失：「缺少作者資訊」
- 4a4. **主動補充機制**：
  - 提供「一鍵補充資訊」快速連結（直接跳轉 UC-04）
  - 「批次補充」選項（如果有多本不完整書籍）
  - 「稍後提醒」選項（加入待辦清單）
- 4a5. **背景自動改善**：定期自動嘗試補充空白欄位，減少使用者手動操作負擔

### 特殊需求
- **效能**: 1000本書籍列表載入時間<3秒
- **記憶體**: 圖片懶載入避免記憶體問題
- **無障礙**: 支援螢幕閱讀器和高對比模式

---

## UC-06: 借閱管理系統

### 基本資訊
- **用例ID**: UC-06  
- **用例名稱**: 管理圖書館借書和個人借書記錄
- **主要行為者**: 使用者（管理模式）
- **前置條件**: 
  - 書籍已存在於書庫中
  - 使用者在管理模式
  - 書籍source_type為`borrowed`
- **成功保證**: 借閱記錄完整追蹤，支援到期提醒和歸還管理

## 6A. 圖書館借書管理

### 主要成功場景

1. **新增圖書館借書記錄**
   - 使用者在管理模式中選擇書籍
   - 點擊「設定為借閱書籍」
   - 選擇借閱類型：「從圖書館借閱」
   - 填寫借閱資訊：
     - 圖書館名稱（如：台北市立圖書館總館）
     - 借閱日期（預設今日）
     - 到期日期（必填）
     - 借閱備註（可選）

2. **借閱狀態顯示**
   - 簡潔模式：顯示「圖書館」圖標
   - 管理模式：完整借閱資訊卡片
   - 到期提醒：
     - 綠色：7天以上
     - 黃色：3-7天  
     - 紅色：3天內或已逾期

3. **歸還記錄**
   - 使用者點擊「標記為已歸還」
   - 系統記錄歸還日期
   - 更新書籍狀態為已歸還
   - 借閱記錄保留作為歷史

## 6B. 個人借書管理

### 主要成功場景

1. **記錄借給朋友的書**
   - 選擇書籍並設定為「借給他人」
   - 填寫借閱者姓名
   - 設定預期歸還日期
   - 可新增聯絡方式和備註

2. **借書追蹤**
   - 在管理模式中顯示借出清單
   - 支援按借閱者篩選
   - 提供到期提醒功能
   - 可發送歸還提醒（後續功能）

3. **收回記錄**
   - 朋友歸還後標記為已收回
   - 記錄實際歸還日期
   - 書籍重新回到個人書庫

### 替代流程

**6A.1a. 圖書館借閱資訊不完整**
- 6A.1a1. 使用者填寫借閱資訊時缺少必要欄位（觸發 DATA_ERROR，嚴重程度 MINOR）
- 6A.1a2. **智慧預填**：根據使用者歷史借閱記錄自動建議常用圖書館
- 6A.1a3. **欄位驗證**：即時檢查到期日期合理性（不能早於借閱日期，不能超過一般借閱期限）
- 6A.1a4. **引導式填寫**：對於首次使用者，提供借閱資訊填寫說明和範例
- 6A.1a5. 系統阻止不完整記錄的儲存，要求補齊關鍵資訊

**6A.2a. 借閱逾期處理**
- 6A.2a1. 系統偵測到借閱已逾期（觸發 SYSTEM_ERROR，嚴重程度 MODERATE）
- 6A.2a2. **多級提醒機制**：
  - 到期前3天：溫和提醒「即將到期」
  - 到期當天：明確提醒「今日到期」
  - 逾期後：每日提醒並顯示逾期天數
- 6A.2a3. **行動建議**：
  - 提供「聯絡圖書館續借」按鈕（包含圖書館聯絡資訊）
  - 「標記為已歸還」選項
  - 「延長到期日」選項（適用於可續借情況）
- 6A.2a4. **統計追蹤**：記錄逾期模式，改善個人借閱管理習慣

**6B.1a. 借閱者資訊不完整**
- 6B.1a1. 缺少借閱者姓名或聯絡方式（觸發 DATA_ERROR，嚴重程度 MINOR）
- 6B.1a2. **智慧建議**：根據以往借閱記錄自動建議常見借閱者
- 6B.1a3. **資訊最小化原則**：允許僅填寫姓名，聯絡方式設為可選
- 6B.1a4. **隱私保護提醒**：說明個人資訊僅用於借閱追蹤，不會外洩

**6B.2a. 借閱者逾期未還**
- 6B.2a1. 個人借出書籍逾期未歸還（觸發 SYSTEM_ERROR，嚴重程度 MODERATE）
- 6B.2a2. **友善提醒機制**：
  - 提供禮貌的提醒訊息範本
  - 建議提醒時機和頻率（避免過度催促）
- 6B.2a3. **聯絡方式整合**：如有聯絡資訊，提供一鍵撥打或傳訊功能
- 6B.2a4. **後備處理**：提供「標記為遺失」或「不再追討」選項

### 特殊處理

#### 已賣出書籍
- 借閱類型：特殊標記為「已賣出」
- 不設定到期日期，記錄出售日期
- 在管理模式中可查看出售歷史
- 支援出售價格和購買者資訊記錄

#### 錯誤恢復機制
**6c. 借閱記錄資料損壞**
- 6c1. 系統偵測到借閱記錄不一致（觸發 DATA_ERROR，嚴重程度 SEVERE）
- 6c2. **資料完整性檢查**：驗證借閱狀態與歸還記錄的邏輯一致性
- 6c3. **自動修復**：嘗試從備份或歷史記錄恢復正確狀態
- 6c4. **使用者確認**：無法自動修復時，請使用者確認正確的借閱狀態
- 6c5. **預防措施**：強化資料庫約束條件，防止未來類似錯誤

---

## UC-07: 跨平台資料同步準備

### 基本資訊
- **用例ID**: UC-07  
- **用例名稱**: 準備跨裝置資料同步機制
- **主要行為者**: 系統（自動）
- **利益關係人**: 使用者（未來獲得多裝置同步）
- **前置條件**: 本地資料庫已建立且包含書籍和借閱資料
- **成功保證**: 資料同步準備就緒，包含借閱記錄同步

### 主要成功場景

1. **資料同步狀態管理**
   - 每本書籍記錄同步狀態：`local`, `synced`, `conflict`
   - 自動維護時間戳：`created_at`, `updated_at`, `last_sync_at`
   - 追蹤本地變更，標記需要同步的記錄

2. **增量變更追蹤**
   - 資料庫觸發器自動更新`updated_at`
   - 識別自上次同步後的變更記錄
   - 生成變更摘要供同步使用

3. **衝突預防機制**
   - 本地優先策略：離線變更優先於雲端
   - 時間戳比較確定數據新舊
   - 為複雜衝突預留手動解決介面

4. **同步準備檢查**
   - 系統定期檢查資料一致性
   - 驗證關鍵欄位完整性
   - 預先標記可能的同步問題

### 設計考量

**資料一致性保證**
- 使用UUID作為跨裝置唯一識別
- 保留原始Chrome Extension的ID映射
- 變更日誌記錄所有修改操作

**網路適應性**
- 支援間歇性網路連接
- 批次同步減少API呼叫
- 智慧重試機制處理網路失敗

**隱私和安全**
- 本地資料加密存儲
- 為未來端到端加密預留架構
- 使用者可控制同步範圍和頻率

### 未來擴展準備

**雲端同步API介面設計**
```
POST /api/sync/books
GET /api/sync/books?since={timestamp}
PUT /api/sync/books/{id}
```

**衝突解決策略**
- Last-Write-Wins（簡單場景）
- User-Choose（複雜場景）
- Field-Level-Merge（進階功能）

### 替代流程

**7a. 本地資料不一致**
- 7a1. 系統在準備同步時發現資料不一致（觸發 DATA_ERROR，嚴重程度 SEVERE）
- 7a2. **完整性檢查機制**：
  - 驗證關鍵欄位的邏輯一致性（如借閱狀態與日期）
  - 檢查外鍵約束和關聯資料完整性
  - 識別孤立記錄或重複資料
- 7a3. **自動修復策略**：
  - 嘗試從備份或歷史記錄重建缺失資料
  - 使用啟發式規則修復明顯的邏輯錯誤
  - 標記無法自動修復的問題記錄
- 7a4. **使用者介入**：對於無法自動修復的問題，提供詳細的錯誤報告和建議修復方案
- 7a5. **預防機制**：強化資料驗證規則，防止未來出現類似不一致問題

**7b. 同步狀態衝突**
- 7b1. 多個裝置同時修改同一記錄（觸發 DATA_ERROR，嚴重程度 MODERATE）
- 7b2. **衝突偵測算法**：
  - 比較時間戳確定修改順序
  - 分析變更內容的重疊程度
  - 評估衝突的嚴重性和影響範圍
- 7b3. **智慧合併策略**：
  - 非衝突欄位：自動合併最新變更
  - 輕微衝突：使用預設規則（如最新優先）
  - 重大衝突：保留所有版本，等待使用者決策
- 7b4. **衝突解決介面**：提供視覺化的版本比較和選擇工具
- 7b5. **學習機制**：記錄使用者的衝突解決偏好，改善未來自動合併策略

**7c. 網路連接不穩定**
- 7c1. 同步過程中網路中斷或不穩定（觸發 NETWORK_ERROR，嚴重程度 MODERATE）
- 7c2. **斷點續傳機制**：
  - 記錄同步進度，支援從中斷點繼續
  - 使用增量同步減少重複傳輸
  - 實施智慧重試和指數退避策略
- 7c3. **網路狀態監控**：
  - 持續監控網路品質和穩定性
  - 根據網路狀態調整同步策略（批次大小、頻率）
  - 在網路條件改善時自動恢復同步
- 7c4. **離線優先設計**：確保所有功能在離線狀態下正常運作，待網路恢復時自動同步
- 7c5. **使用者通知**：提供清楚的同步狀態指示和預估完成時間

**7d. 儲存空間不足**
- 7d1. 同步資料超過裝置可用空間（觸發 SYSTEM_ERROR，嚴重程度 SEVERE）
- 7d2. **空間需求預估**：
  - 計算同步所需的最小空間
  - 分析可清理的快取和暫存檔案
  - 提供詳細的空間使用分析
- 7d3. **智慧清理機制**：
  - 自動清理過期的快取檔案
  - 壓縮非關鍵資料（如縮略圖）
  - 提供選擇性同步選項（僅同步重要資料）
- 7d4. **使用者引導**：提供具體的空間清理建議和操作指引
- 7d5. **降級方案**：當空間嚴重不足時，提供最小化同步選項保持核心功能

**7e. 同步服務不可用**
- 7e1. 雲端同步服務暫時無法使用（觸發 NETWORK_ERROR，嚴重程度 MODERATE）
- 7e2. **服務狀態監控**：
  - 定期檢測同步服務的可用性
  - 區分暫時性故障和長期維護
  - 記錄服務中斷的模式和頻率
- 7e3. **優雅降級**：
  - 繼續本地功能的正常運作
  - 將待同步變更加入本地佇列
  - 提供明確的服務狀態說明
- 7e4. **自動恢復**：服務恢復後自動重新啟動同步程序
- 7e5. **備用策略**：在長期服務中斷時，提供手動匯出入選項作為暫時解決方案

---

## UC-08: 系統錯誤處理與恢復

### 基本資訊
- **用例ID**: UC-08
- **用例名稱**: 系統級錯誤處理與自動恢復機制
- **主要行為者**: 系統（自動）+ 使用者（必要時介入）
- **利益關係人**: 使用者（獲得穩定可靠的應用體驗）
- **前置條件**:
  - 應用程式正在運行
  - 錯誤處理系統已初始化
- **成功保證**: 系統能從各種錯誤狀態自動恢復，或提供明確的使用者引導

### 主要成功場景

#### 8A. 自動錯誤偵測與分類

1. **錯誤捕獲**
   - 系統持續監控各項操作的執行狀態
   - 自動捕獲異常、超時、資源不足等錯誤
   - 收集完整的錯誤上下文資訊（操作類型、使用者狀態、系統環境）

2. **即時錯誤分析**
   - 根據錯誤類型自動分類：網路、檔案、相機、系統、資料錯誤
   - 評估錯誤嚴重程度：MINOR, MODERATE, SEVERE, CRITICAL
   - 判斷恢復可能性：自動恢復、需使用者介入、無法恢復

3. **錯誤記錄與學習**
   - 記錄錯誤資訊到本地資料庫
   - 分析錯誤模式和頻率
   - 動態調整處理策略

#### 8B. 自動恢復機制

1. **網路錯誤自動恢復**
   - **場景**: Google Books API 請求失敗
   - **策略**: 指數退避重試（2s, 4s, 8s）
   - **降級**: 使用本地快取或離線模式
   - **使用者通知**: 「正在重試網路請求...」

2. **檔案操作錯誤恢復**
   - **場景**: 匯入檔案損壞或格式錯誤
   - **策略**: 回滾事務，保護資料完整性
   - **替代方案**: 提供分批匯入或格式修正建議
   - **使用者通知**: 「檔案格式有問題，已提供修正建議」

3. **相機功能錯誤恢復**
   - **場景**: 相機權限被拒絕或硬體故障
   - **策略**: 立即提供手動輸入 ISBN 選項
   - **使用者引導**: 顯示權限設定步驟或替代操作方法
   - **使用者通知**: 「無法使用相機，您可以手動輸入 ISBN」

4. **系統資源錯誤恢復**
   - **場景**: 記憶體不足或儲存空間滿
   - **策略**: 清理快取、降級服務、延遲非關鍵操作
   - **使用者引導**: 提供具體的清理建議
   - **使用者通知**: 「記憶體不足，已自動最佳化」

#### 8C. 使用者溝通與引導

1. **情境感知通知**
   - 根據使用者當前操作調整通知內容
   - 首次使用者：提供詳細說明和教學
   - 熟練使用者：簡潔通知和快速操作選項

2. **動作建議優先級**
   - **高優先級**: 立即可執行的解決方案
   - **中優先級**: 需要使用者設定或確認的操作
   - **低優先級**: 替代方案或進階選項

3. **視覺化錯誤指示**
   - 使用顏色和圖標區分錯誤嚴重程度
   - 提供進度指示器顯示恢復進度
   - 清楚的操作按鈕和說明文字

### 替代流程

**8a. 自動恢復失敗**
- 8a1. 系統嘗試自動恢復但失敗
- 8a2. 升級為需要使用者介入的錯誤
- 8a3. 提供詳細的問題說明和解決步驟
- 8a4. 記錄恢復失敗原因供後續改善

**8b. 使用者選擇忽略錯誤**
- 8b1. 使用者選擇「暫不處理」
- 8b2. 系統將錯誤加入待處理清單
- 8b3. 適時提醒使用者處理未解決的問題
- 8b4. 避免重複通知同類型錯誤

**8c. 錯誤處理系統本身故障**
- 8c1. 錯誤處理機制發生異常
- 8c2. 啟動最小化安全模式
- 8c3. 記錄系統級問題到緊急日誌
- 8c4. 下次啟動時嘗試修復錯誤處理系統

### 特殊需求

**效能要求**:
- 錯誤偵測響應時間 < 100ms
- 錯誤分類處理時間 < 5ms
- 自動恢復決策時間 < 1s

**可靠性要求**:
- 錯誤處理系統本身的可用性 > 99.9%
- 自動恢復成功率 > 80%（可恢復錯誤）
- 資料完整性保護 100%（所有事務性操作）

**使用者體驗要求**:
- 非關鍵錯誤不中斷使用者操作
- 錯誤訊息避免技術術語
- 提供預估解決時間

---

## 系統整體工作流程

### 典型使用者旅程

1. **首次使用**
   - 下載並安裝APP
   - 匯入Chrome Extension資料（UC-01）
   - 瀏覽書庫確認資料正確（UC-05）

2. **日常使用**
   - 購買實體書後掃描ISBN新增（UC-03）
   - 定期補充書籍詳細資訊（UC-04）
   - 瀏覽和管理個人書庫（UC-05）

3. **資料管理**
   - 定期匯出備份（UC-02）
   - 清理重複或錯誤資料
   - 準備跨裝置同步（UC-06）

### 跨用例交互

#### 正常交互流程
- **UC-01 → UC-05**: 匯入完成後自動跳轉書庫頁面
- **UC-03 → UC-04**: 掃描新增後可立即補充詳細資訊
- **UC-05 → UC-04**: 書庫瀏覽時發現並補充不完整資訊
- **UC-05 → UC-02**: 書庫管理中觸發匯出操作
- **UC-06 → UC-05**: 借閱狀態變更後更新書庫顯示
- **UC-07 → UC-08**: 同步準備過程中觸發錯誤恢復機制

#### 錯誤處理的跨用例整合

**UC-01 錯誤對其他用例的影響**
- **匯入失敗 → UC-05**: 書庫保持原狀，提供「重新匯入」按鈕直接返回 UC-01
- **部分匯入成功 → UC-04**: 已匯入書籍自動標記為「資訊待補充」，一鍵跳轉 UC-04 批次補充
- **資料損壞 → UC-08**: 觸發系統級錯誤處理，記錄錯誤模式並提供資料修復建議

**UC-03 錯誤的連鎖處理**
- **相機權限拒絕 → UC-01**: 提供「從檔案匯入」替代方案
- **ISBN 識別失敗 → UC-04**: 切換到手動搜尋模式
- **網路失敗 → UC-05**: 書籍以 ISBN 暫時顯示，背景自動重試補充資訊

**UC-04 錯誤的使用者引導**
- **搜尋無結果 → UC-05**: 返回書庫時保持「待補充」狀態，提供批次處理選項
- **API 限制觸發 → UC-08**: 啟動速率控制機制，安排稍後自動重試
- **資訊衝突 → UC-06**: 如果是借閱書籍，優先保護借閱狀態資訊

**UC-05 錯誤的系統回應**
- **載入效能問題 → UC-08**: 啟動效能最佳化模式（分頁載入、圖片懶載入）
- **搜尋失敗 → UC-04**: 提供「改用補充資訊功能」的智慧建議
- **顯示錯誤 → UC-02**: 提供「匯出備份以備修復」的預防性建議

**UC-06 錯誤的資料保護**
- **借閱記錄衝突 → UC-07**: 借閱資訊在同步衝突中具有最高優先級
- **到期計算錯誤 → UC-08**: 啟動時間校正機制，防止錯誤提醒
- **聯絡資訊遺失 → UC-05**: 在書庫中標示「聯絡資訊待補充」，提供快速編輯

**UC-07 錯誤的系統協調**
- **同步失敗 → UC-02**: 自動建立本地備份，作為同步恢復的保險
- **資料衝突 → UC-08**: 觸發完整的衝突解決流程，包括使用者介入機制
- **網路中斷 → 所有用例**: 啟動離線模式，確保所有基本功能繼續運作

### 錯誤處理和恢復

#### 統一錯誤處理機制
**依據 [APP 錯誤處理系統設計文件](./app-error-handling-design.md) 的完整實作**

**網路相關錯誤（NETWORK_ERROR）**
- **自動恢復策略**: 指數退避重試（2s, 4s, 8s），最多3次嘗試
- **降級處理**: 自動切換離線模式，背景監控網路狀態
- **使用者通知**: 顯示具體重試進度和預估恢復時間
- **連鎖影響**: 網路恢復後自動觸發所有待處理的背景補充任務
- **參考實作**: UC-03 網路連接問題、UC-04 API查詢失敗、UC-07 同步服務不可用

**資料相關錯誤（DATA_ERROR）**
- **智慧分析**: 自動判斷錯誤嚴重程度（MINOR/MODERATE/SEVERE）
- **格式修復**: 提供具體修正建議和自動修復選項
- **衝突解決**: 視覺化比較界面，支援欄位級別選擇
- **完整性保護**: 事務性操作確保資料一致性
- **學習機制**: 記錄錯誤模式，改善未來預防和處理策略
- **參考實作**: UC-01 JSON格式錯誤、UC-04 資訊衝突、UC-07 資料不一致

**系統相關錯誤（SYSTEM_ERROR）**
- **資源監控**: 即時檢測記憶體、儲存空間、CPU使用狀況
- **優雅降級**: 自動調整功能複雜度以維持核心服務
- **預防措施**: 主動清理快取、壓縮非關鍵資料
- **使用者引導**: 提供具體的系統最佳化建議和操作步驟
- **參考實作**: UC-02 儲存空間不足、UC-07 同步空間問題、UC-06 資料損壞

**平台相關錯誤（PLATFORM_ERROR）**
- **權限管理**: 階段式權限請求，提供清楚的用途說明
- **硬體適配**: 智慧檢測設備能力，提供替代方案
- **相容性處理**: 跨平台一致的錯誤表現和恢復方式
- **使用者教育**: 提供平台特定的設定指引和截圖
- **參考實作**: UC-03 相機權限未授權、相機硬體故障

**DOM相關錯誤（DOM_ERROR）**
- **介面修復**: 自動重繪損壞的UI元素
- **狀態同步**: 確保介面狀態與資料狀態一致
- **互動保護**: 防止在載入或處理過程中的誤操作
- **視覺回饋**: 明確的載入指示器和進度顯示
- **參考實作**: UC-05 載入效能問題、介面渲染失敗

#### 錯誤恢復的優先級策略
1. **資料完整性**: 優先保護使用者資料，防止資料遺失
2. **核心功能**: 確保基本瀏覽和管理功能持續可用
3. **使用者體驗**: 最小化錯誤對使用者操作流程的干擾
4. **系統穩定**: 防止錯誤擴散和系統崩潰
5. **學習改善**: 從錯誤中學習，持續最佳化系統穩定性

---

## 非功能需求

### 效能要求
- 應用程式啟動時間：<3秒
- 書庫列表載入：1000本書<5秒
- ISBN掃描識別：<2秒
- API回應時間：Google Books API<5秒

### 可用性要求
- 離線功能：核心瀏覽功能離線可用
- 多語言：支援繁體中文、英文
- 無障礙：符合WCAG 2.1 AA級標準
- 響應式：適應不同螢幕尺寸

### 安全性要求
- 資料加密：SQLite資料庫加密存儲
- 網路安全：HTTPS通訊，憑證驗證
- 隱私保護：不收集使用者個人資料
- 權限最小化：僅申請必要系統權限

### 相容性要求
- 平台支援：iOS 12+, Android 8+, Windows 10+, macOS 10.15+
- 資料格式：100%相容Chrome Extension JSON格式
- API版本：Google Books API v1穩定支援
- 資料庫：SQLite 3.x跨平台相容性

---

## 總結

本用例文件涵蓋了APP版書庫管理系統的完整功能場景，從基本的資料匯入匯出，到進階的智慧搜尋和跨平台準備。每個用例都經過詳細的場景分析和替代流程設計，確保系統在各種情況下都能提供良好的使用者體驗。

配合需求規格書的TDD開發方法，這些用例將指導具體的測試案例撰寫和功能實現，確保最終產品符合使用者需求並具備高品質的使用者體驗。