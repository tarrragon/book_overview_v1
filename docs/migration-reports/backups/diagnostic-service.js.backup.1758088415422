/**
 * è¨ºæ–·æœå‹™
 *
 * è² è²¬åŠŸèƒ½ï¼š
 * - ç³»çµ±è¨ºæ–·å’Œæ•…éšœæ’é™¤
 * - æ—¥èªŒæ”¶é›†å’Œåˆ†æ
 * - è¨ºæ–·å ±å‘Šç”Ÿæˆå’ŒåŒ¯å‡º
 * - æ•…éšœæ¢å¾©å»ºè­°
 *
 * è¨­è¨ˆè€ƒé‡ï¼š
 * - æ·±åº¦è¨ºæ–·åˆ†æèƒ½åŠ›
 * - æ™ºèƒ½æ•…éšœè­˜åˆ¥å’Œåˆ†é¡
 * - å¯æ“´å±•çš„è¨ºæ–·è¦å‰‡å¼•æ“
 * - éš±ç§ä¿è­·çš„è³‡æ–™æ”¶é›†
 *
 * ä½¿ç”¨æƒ…å¢ƒï¼š
 * - ç³»çµ±æ•…éšœè¨ºæ–·å’Œåˆ†æ
 * - æ•ˆèƒ½å•é¡Œæ ¹å› åˆ†æ
 * - è¨ºæ–·å ±å‘Šç”Ÿæˆå’Œæ”¯æ´
 */

const {
  SYSTEM_EVENTS,
  EVENT_PRIORITIES
} = require('src/background/constants/module-constants')
const { StandardError } = require('src/core/errors/StandardError')

class DiagnosticService {
  constructor (dependencies = {}) {
    // ä¾è³´æ³¨å…¥
    this.eventBus = dependencies.eventBus || null
    this.logger = dependencies.logger || console
    this.i18nManager = dependencies.i18nManager || null

    // æœå‹™ç‹€æ…‹
    this.state = {
      initialized: false,
      active: false,
      collecting: false
    }

    // è¨ºæ–·é…ç½®
    this.config = {
      logRetentionDays: 7,
      maxLogEntries: 1000,
      diagnosticLevels: ['error', 'warn', 'info', 'debug'],
      anonymizeData: true,
      enableAutoAnalysis: true
    }

    // è¨ºæ–·è³‡æ–™
    this.diagnosticData = {
      logs: [],
      systemInfo: {},
      errorPatterns: new Map(),
      performanceMetrics: [],
      userActions: [],
      diagnosticSessions: []
    }

    // è¨ºæ–·è¦å‰‡å’Œåˆ†æå™¨
    this.diagnosticRules = new Map()
    this.analyzers = new Map()
    this.registeredListeners = new Map()

    // çµ±è¨ˆè³‡æ–™
    this.stats = {
      logsCollected: 0,
      diagnosticsPerformed: 0,
      patternsDetected: 0,
      reportsGenerated: 0
    }

    // åˆå§‹åŒ–é è¨­è¨ºæ–·è¦å‰‡
    this.initializeDefaultRules()
  }

  /**
   * åˆå§‹åŒ–è¨ºæ–·æœå‹™
   */
  async initialize () {
    if (this.state.initialized) {
      this.logger.warn('âš ï¸ è¨ºæ–·æœå‹™å·²åˆå§‹åŒ–')
      return
    }

    try {
      this.logger.log('ğŸ” åˆå§‹åŒ–è¨ºæ–·æœå‹™')

      // æ”¶é›†ç³»çµ±åŸºæœ¬è³‡è¨Š
      await this.collectSystemInfo()

      // åˆå§‹åŒ–åˆ†æå™¨
      await this.initializeAnalyzers()

      // è¨»å†Šäº‹ä»¶ç›£è½å™¨
      await this.registerEventListeners()

      this.state.initialized = true
      this.logger.log('âœ… è¨ºæ–·æœå‹™åˆå§‹åŒ–å®Œæˆ')

      // ç™¼é€åˆå§‹åŒ–å®Œæˆäº‹ä»¶
      if (this.eventBus) {
        await this.eventBus.emit('SYSTEM.DIAGNOSTIC.INITIALIZED', {
          serviceName: 'DiagnosticService',
          config: this.config
        })
      }
    } catch (error) {
      this.logger.error('âŒ åˆå§‹åŒ–è¨ºæ–·æœå‹™å¤±æ•—:', error)
      throw error
    }
  }

  /**
   * å•Ÿå‹•è¨ºæ–·æœå‹™
   */
  async start () {
    if (!this.state.initialized) {
      throw new StandardErrorWrapper('UNKNOWN_ERROR', 'æœå‹™å°šæœªåˆå§‹åŒ–', {
        category: 'general'
      })
    }

    if (this.state.active) {
      this.logger.warn('âš ï¸ è¨ºæ–·æœå‹™å·²å•Ÿå‹•')
      return
    }

    try {
      this.logger.log('ğŸš€ å•Ÿå‹•è¨ºæ–·æœå‹™')

      // é–‹å§‹è³‡æ–™æ”¶é›†
      this.startDataCollection()

      this.state.active = true
      this.state.collecting = true

      this.logger.log('âœ… è¨ºæ–·æœå‹™å•Ÿå‹•å®Œæˆ')

      // ç™¼é€å•Ÿå‹•å®Œæˆäº‹ä»¶
      if (this.eventBus) {
        await this.eventBus.emit('SYSTEM.DIAGNOSTIC.STARTED', {
          serviceName: 'DiagnosticService'
        })
      }
    } catch (error) {
      this.logger.error('âŒ å•Ÿå‹•è¨ºæ–·æœå‹™å¤±æ•—:', error)
      throw error
    }
  }

  /**
   * åœæ­¢è¨ºæ–·æœå‹™
   */
  async stop () {
    if (!this.state.active) {
      this.logger.warn('âš ï¸ è¨ºæ–·æœå‹™æœªå•Ÿå‹•')
      return
    }

    try {
      this.logger.log('ğŸ›‘ åœæ­¢è¨ºæ–·æœå‹™')

      // åœæ­¢è³‡æ–™æ”¶é›†
      this.stopDataCollection()

      // ç”Ÿæˆæœ€çµ‚è¨ºæ–·å ±å‘Š
      const finalReport = await this.generateDiagnosticReport()

      // æ¸…ç†æ•æ„Ÿè³‡æ–™
      this.cleanupSensitiveData()

      // å–æ¶ˆè¨»å†Šäº‹ä»¶ç›£è½å™¨
      await this.unregisterEventListeners()

      this.state.active = false
      this.state.collecting = false

      this.logger.log('âœ… è¨ºæ–·æœå‹™åœæ­¢å®Œæˆ')

      // ç™¼é€åœæ­¢å®Œæˆäº‹ä»¶
      if (this.eventBus) {
        await this.eventBus.emit('SYSTEM.DIAGNOSTIC.STOPPED', {
          serviceName: 'DiagnosticService',
          finalReport: this.anonymizeReport(finalReport)
        })
      }
    } catch (error) {
      this.logger.error('âŒ åœæ­¢è¨ºæ–·æœå‹™å¤±æ•—:', error)
      throw error
    }
  }

  /**
   * æ”¶é›†ç³»çµ±åŸºæœ¬è³‡è¨Š
   */
  async collectSystemInfo () {
    try {
      this.diagnosticData.systemInfo = {
        userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'Unknown',
        platform: typeof navigator !== 'undefined' ? navigator.platform : 'Unknown',
        language: typeof navigator !== 'undefined' ? navigator.language : 'Unknown',
        timestamp: Date.now(),
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        memory: this.getMemoryInfo(),
        storage: await this.getStorageInfo(),
        extensions: await this.getExtensionInfo()
      }

      this.logger.log('âœ… ç³»çµ±è³‡è¨Šæ”¶é›†å®Œæˆ')
    } catch (error) {
      this.logger.error('âŒ æ”¶é›†ç³»çµ±è³‡è¨Šå¤±æ•—:', error)
    }
  }

  /**
   * ç²å–è¨˜æ†¶é«”è³‡è¨Š
   */
  getMemoryInfo () {
    if (typeof performance !== 'undefined' && performance.memory) {
      return {
        used: performance.memory.usedJSHeapSize,
        total: performance.memory.totalJSHeapSize,
        limit: performance.memory.jsHeapSizeLimit
      }
    }
    return { used: 0, total: 0, limit: 0 }
  }

  /**
   * ç²å–å„²å­˜è³‡è¨Š
   */
  async getStorageInfo () {
    try {
      if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local) {
        const usage = await chrome.storage.local.getBytesInUse()
        return {
          used: usage,
          quota: chrome.storage.local.QUOTA_BYTES || 5242880 // 5MB é è¨­
        }
      }
    } catch (error) {
      this.logger.warn('ç„¡æ³•ç²å–å„²å­˜è³‡è¨Š:', error)
    }
    return { used: 0, quota: 0 }
  }

  /**
   * ç²å–æ“´å±•è³‡è¨Š
   */
  async getExtensionInfo () {
    try {
      if (typeof chrome !== 'undefined' && chrome.runtime) {
        return {
          id: chrome.runtime.id,
          version: chrome.runtime.getManifest()?.version || 'Unknown'
        }
      }
    } catch (error) {
      this.logger.warn('ç„¡æ³•ç²å–æ“´å±•è³‡è¨Š:', error)
    }
    return { id: 'Unknown', version: 'Unknown' }
  }

  /**
   * åˆå§‹åŒ–åˆ†æå™¨
   */
  async initializeAnalyzers () {
    // éŒ¯èª¤æ¨¡å¼åˆ†æå™¨
    this.analyzers.set('errorPatterns', (logs) => {
      const patterns = new Map()

      logs.filter(log => log.level === 'error').forEach(log => {
        const pattern = this.extractErrorPattern(log.message)
        if (pattern) {
          patterns.set(pattern, (patterns.get(pattern) || 0) + 1)
        }
      })

      return Array.from(patterns.entries())
        .filter(([pattern, count]) => count > 1)
        .map(([pattern, count]) => ({ pattern, count, severity: this.calculateSeverity(count) }))
    })

    // æ•ˆèƒ½å•é¡Œåˆ†æå™¨
    this.analyzers.set('performance', (metrics) => {
      const issues = []

      // åˆ†æéŸ¿æ‡‰æ™‚é–“
      const slowResponses = metrics.filter(m => m.responseTime > 1000)
      if (slowResponses.length > 0) {
        issues.push({
          type: 'slow_response',
          count: slowResponses.length,
          avgTime: slowResponses.reduce((sum, m) => sum + m.responseTime, 0) / slowResponses.length
        })
      }

      return issues
    })

    // è¨˜æ†¶é«”ä½¿ç”¨åˆ†æå™¨
    this.analyzers.set('memory', (systemInfo) => {
      const issues = []
      const memory = systemInfo.memory

      if (memory && memory.used > memory.limit * 0.8) {
        issues.push({
          type: 'high_memory_usage',
          percentage: (memory.used / memory.limit) * 100,
          severity: 'high'
        })
      }

      return issues
    })

    this.logger.log(`âœ… åˆå§‹åŒ–äº† ${this.analyzers.size} å€‹åˆ†æå™¨`)
  }

  /**
   * åˆå§‹åŒ–é è¨­è¨ºæ–·è¦å‰‡
   */
  initializeDefaultRules () {
    // é »ç¹éŒ¯èª¤è¦å‰‡
    this.diagnosticRules.set('frequent_errors', {
      condition: (data) => {
        const recentErrors = data.logs.filter(log =>
          log.level === 'error' && Date.now() - log.timestamp < 300000 // 5åˆ†é˜å…§
        )
        return recentErrors.length > 5
      },
      action: () => ({
        issue: 'frequent_errors',
        description: 'æª¢æ¸¬åˆ°é »ç¹éŒ¯èª¤',
        recommendation: 'æª¢æŸ¥ç³»çµ±æ—¥èªŒï¼Œè­˜åˆ¥éŒ¯èª¤æ ¹å› ä¸¦ä¿®å¾©'
      })
    })

    // è¨˜æ†¶é«”æ´©æ¼è¦å‰‡
    this.diagnosticRules.set('memory_leak', {
      condition: (data) => {
        const memory = data.systemInfo.memory
        return memory && memory.used > memory.limit * 0.9
      },
      action: () => ({
        issue: 'potential_memory_leak',
        description: 'è¨˜æ†¶é«”ä½¿ç”¨éé«˜ï¼Œå¯èƒ½å­˜åœ¨è¨˜æ†¶é«”æ´©æ¼',
        recommendation: 'é‡å•Ÿæ“´å±•æˆ–æª¢æŸ¥è¨˜æ†¶é«”ä½¿ç”¨æ¨¡å¼'
      })
    })

    // æ•ˆèƒ½é™ç´šè¦å‰‡
    this.diagnosticRules.set('performance_degradation', {
      condition: (data) => {
        const slowMetrics = data.performanceMetrics.filter(m => m.responseTime > 2000)
        return slowMetrics.length > 3
      },
      action: () => ({
        issue: 'performance_degradation',
        description: 'ç³»çµ±æ•ˆèƒ½é™ç´š',
        recommendation: 'æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œç³»çµ±è² è¼‰'
      })
    })
  }

  /**
   * é–‹å§‹è³‡æ–™æ”¶é›†
   */
  startDataCollection () {
    // æ””æˆªå’Œè¨˜éŒ„æ—¥èªŒ
    this.interceptLogs()

    this.logger.log('ğŸ“Š é–‹å§‹è¨ºæ–·è³‡æ–™æ”¶é›†')
  }

  /**
   * åœæ­¢è³‡æ–™æ”¶é›†
   */
  stopDataCollection () {
    // æ¸…ç†æ—¥èªŒæ””æˆª
    this.cleanupLogInterception()

    this.logger.log('â¹ï¸ åœæ­¢è¨ºæ–·è³‡æ–™æ”¶é›†')
  }

  /**
   * æ””æˆªæ—¥èªŒ
   */
  interceptLogs () {
    // é€™è£¡å¯ä»¥å¯¦ç¾æ—¥èªŒæ””æˆªé‚è¼¯
    // ä¾‹å¦‚é‡å¯« console æ–¹æ³•æˆ–ç›£è½ç‰¹å®šäº‹ä»¶
  }

  /**
   * æ¸…ç†æ—¥èªŒæ””æˆª
   */
  cleanupLogInterception () {
    // æ¸…ç†æ—¥èªŒæ””æˆªè¨­ç½®
  }

  /**
   * è¨˜éŒ„æ—¥èªŒæ¢ç›®
   */
  recordLogEntry (level, message, context = {}) {
    if (!this.state.collecting) return

    const logEntry = {
      id: `log_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
      level,
      message,
      context: this.config.anonymizeData ? this.anonymizeContext(context) : context,
      timestamp: Date.now()
    }

    this.diagnosticData.logs.push(logEntry)
    this.stats.logsCollected++

    // é™åˆ¶æ—¥èªŒæ•¸é‡
    if (this.diagnosticData.logs.length > this.config.maxLogEntries) {
      this.diagnosticData.logs = this.diagnosticData.logs.slice(-this.config.maxLogEntries / 2)
    }

    // å³æ™‚åˆ†æéŒ¯èª¤æ¨¡å¼
    if (level === 'error') {
      this.analyzeErrorPattern(message)
    }
  }

  /**
   * åˆ†æéŒ¯èª¤æ¨¡å¼
   */
  analyzeErrorPattern (errorMessage) {
    const pattern = this.extractErrorPattern(errorMessage)
    if (pattern) {
      const count = (this.diagnosticData.errorPatterns.get(pattern) || 0) + 1
      this.diagnosticData.errorPatterns.set(pattern, count)

      if (count > 3) {
        this.stats.patternsDetected++
        this.logger.warn(`ğŸ” æª¢æ¸¬åˆ°é‡è¤‡éŒ¯èª¤æ¨¡å¼: ${pattern} (${count} æ¬¡)`)
      }
    }
  }

  /**
   * æå–éŒ¯èª¤æ¨¡å¼
   */
  extractErrorPattern (errorMessage) {
    // ç°¡åŒ–éŒ¯èª¤è¨Šæ¯ï¼Œæå–æ¨¡å¼
    return errorMessage
      .replace(/\d+/g, 'NUMBER')
      .replace(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/gi, 'UUID')
      .replace(/https?:\/\/[^\s]+/g, 'URL')
      .substring(0, 100)
  }

  /**
   * è¨ˆç®—åš´é‡ç¨‹åº¦
   */
  calculateSeverity (count) {
    if (count > 10) return 'high'
    if (count > 5) return 'medium'
    return 'low'
  }

  /**
   * åŸ·è¡Œè¨ºæ–·åˆ†æ
   */
  async performDiagnosticAnalysis () {
    this.stats.diagnosticsPerformed++

    const analysisResults = {
      timestamp: Date.now(),
      issues: [],
      recommendations: [],
      analysisDetails: {}
    }

    try {
      // åŸ·è¡Œè¨ºæ–·è¦å‰‡
      for (const [ruleName, rule] of this.diagnosticRules) {
        try {
          if (rule.condition(this.diagnosticData)) {
            const result = rule.action()
            analysisResults.issues.push({
              rule: ruleName,
              ...result
            })
          }
        } catch (error) {
          this.logger.error(`è¨ºæ–·è¦å‰‡åŸ·è¡Œå¤±æ•— (${ruleName}):`, error)
        }
      }

      // åŸ·è¡Œåˆ†æå™¨
      for (const [analyzerName, analyzer] of this.analyzers) {
        try {
          let analysisData
          switch (analyzerName) {
            case 'errorPatterns':
              analysisData = this.diagnosticData.logs
              break
            case 'performance':
              analysisData = this.diagnosticData.performanceMetrics
              break
            case 'memory':
              analysisData = this.diagnosticData.systemInfo
              break
            default:
              analysisData = this.diagnosticData
          }

          const results = analyzer(analysisData)
          analysisResults.analysisDetails[analyzerName] = results
        } catch (error) {
          this.logger.error(`åˆ†æå™¨åŸ·è¡Œå¤±æ•— (${analyzerName}):`, error)
        }
      }

      this.logger.log(`âœ… è¨ºæ–·åˆ†æå®Œæˆï¼Œç™¼ç¾ ${analysisResults.issues.length} å€‹å•é¡Œ`)
      return analysisResults
    } catch (error) {
      this.logger.error('âŒ è¨ºæ–·åˆ†æå¤±æ•—:', error)
      throw error
    }
  }

  /**
   * ç”Ÿæˆè¨ºæ–·å ±å‘Š
   */
  async generateDiagnosticReport () {
    this.stats.reportsGenerated++

    try {
      const analysis = await this.performDiagnosticAnalysis()

      const report = {
        metadata: {
          reportId: `diag_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`,
          generatedAt: Date.now(),
          version: '1.0.0',
          anonymized: this.config.anonymizeData
        },
        systemInfo: this.config.anonymizeData
          ? this.anonymizeSystemInfo(this.diagnosticData.systemInfo)
          : this.diagnosticData.systemInfo,
        summary: {
          totalLogs: this.diagnosticData.logs.length,
          errorCount: this.diagnosticData.logs.filter(l => l.level === 'error').length,
          warningCount: this.diagnosticData.logs.filter(l => l.level === 'warn').length,
          issuesFound: analysis.issues.length,
          errorPatterns: this.diagnosticData.errorPatterns.size
        },
        analysis,
        recommendations: this.generateRecommendations(analysis),
        stats: { ...this.stats }
      }

      return report
    } catch (error) {
      this.logger.error('âŒ ç”Ÿæˆè¨ºæ–·å ±å‘Šå¤±æ•—:', error)
      throw error
    }
  }

  /**
   * ç”Ÿæˆå»ºè­°
   */
  generateRecommendations (analysis) {
    const recommendations = []

    // åŸºæ–¼åˆ†æçµæœç”Ÿæˆå»ºè­°
    analysis.issues.forEach(issue => {
      if (issue.recommendation) {
        recommendations.push(issue.recommendation)
      }
    })

    // é€šç”¨å»ºè­°
    if (this.diagnosticData.logs.filter(l => l.level === 'error').length > 10) {
      recommendations.push('è€ƒæ…®é‡å•Ÿæ“´å±•ä»¥æ¸…é™¤ç´¯ç©çš„éŒ¯èª¤ç‹€æ…‹')
    }

    return recommendations
  }

  /**
   * åŒ¿ååŒ–è³‡æ–™
   */
  anonymizeContext (context) {
    if (!context || typeof context !== 'object') return context

    const anonymized = {}
    for (const [key, value] of Object.entries(context)) {
      if (typeof value === 'string') {
        anonymized[key] = value.replace(/\b\d{4,}\b/g, 'XXXX')
      } else {
        anonymized[key] = value
      }
    }
    return anonymized
  }

  /**
   * åŒ¿ååŒ–ç³»çµ±è³‡è¨Š
   */
  anonymizeSystemInfo (systemInfo) {
    return {
      ...systemInfo,
      userAgent: 'ANONYMIZED',
      timezone: 'ANONYMIZED'
    }
  }

  /**
   * åŒ¿ååŒ–å ±å‘Š
   */
  anonymizeReport (report) {
    if (!this.config.anonymizeData) return report

    return {
      ...report,
      systemInfo: this.anonymizeSystemInfo(report.systemInfo)
    }
  }

  /**
   * æ¸…ç†æ•æ„Ÿè³‡æ–™
   */
  cleanupSensitiveData () {
    if (this.config.anonymizeData) {
      // æ¸…ç†å¯èƒ½åŒ…å«æ•æ„Ÿè³‡è¨Šçš„æ—¥èªŒ
      this.diagnosticData.logs = this.diagnosticData.logs.map(log => ({
        ...log,
        context: this.anonymizeContext(log.context)
      }))
    }
  }

  /**
   * è¨»å†Šäº‹ä»¶ç›£è½å™¨
   */
  async registerEventListeners () {
    if (!this.eventBus) {
      this.logger.warn('âš ï¸ EventBus ä¸å¯ç”¨ï¼Œè·³éäº‹ä»¶ç›£è½å™¨è¨»å†Š')
      return
    }

    const listeners = [
      {
        event: SYSTEM_EVENTS.DIAGNOSTIC_REQUEST,
        handler: this.handleDiagnosticRequest.bind(this),
        priority: EVENT_PRIORITIES.NORMAL
      },
      {
        event: SYSTEM_EVENTS.ERROR_OCCURRED,
        handler: this.handleErrorOccurred.bind(this),
        priority: EVENT_PRIORITIES.HIGH
      }
    ]

    for (const { event, handler, priority } of listeners) {
      const listenerId = await this.eventBus.on(event, handler, { priority })
      this.registeredListeners.set(event, listenerId)
    }

    this.logger.log(`âœ… è¨»å†Šäº† ${listeners.length} å€‹äº‹ä»¶ç›£è½å™¨`)
  }

  /**
   * å–æ¶ˆè¨»å†Šäº‹ä»¶ç›£è½å™¨
   */
  async unregisterEventListeners () {
    if (!this.eventBus) return

    for (const [event, listenerId] of this.registeredListeners) {
      try {
        await this.eventBus.off(event, listenerId)
      } catch (error) {
        this.logger.error(`âŒ å–æ¶ˆè¨»å†Šäº‹ä»¶ç›£è½å™¨å¤±æ•— (${event}):`, error)
      }
    }

    this.registeredListeners.clear()
    this.logger.log('âœ… æ‰€æœ‰äº‹ä»¶ç›£è½å™¨å·²å–æ¶ˆè¨»å†Š')
  }

  /**
   * è™•ç†è¨ºæ–·è«‹æ±‚
   */
  async handleDiagnosticRequest (event) {
    try {
      const { type } = event.data || {}

      let result
      switch (type) {
        case 'full_report':
          result = await this.generateDiagnosticReport()
          break
        case 'analysis_only':
          result = await this.performDiagnosticAnalysis()
          break
        default:
          result = this.getStatus()
      }

      if (this.eventBus) {
        await this.eventBus.emit('SYSTEM.DIAGNOSTIC.RESULT', {
          requestId: event.data?.requestId,
          type,
          result: this.config.anonymizeData ? this.anonymizeReport(result) : result
        })
      }
    } catch (error) {
      this.logger.error('âŒ è™•ç†è¨ºæ–·è«‹æ±‚å¤±æ•—:', error)
    }
  }

  /**
   * è™•ç†éŒ¯èª¤ç™¼ç”Ÿäº‹ä»¶
   */
  async handleErrorOccurred (event) {
    const { error, context } = event.data || {}
    this.recordLogEntry('error', error?.message || 'æœªçŸ¥éŒ¯èª¤', context)
  }

  /**
   * ç²å–æœå‹™ç‹€æ…‹
   */
  getStatus () {
    return {
      initialized: this.state.initialized,
      active: this.state.active,
      collecting: this.state.collecting,
      config: this.config,
      dataSize: {
        logs: this.diagnosticData.logs.length,
        errorPatterns: this.diagnosticData.errorPatterns.size,
        performanceMetrics: this.diagnosticData.performanceMetrics.length
      },
      stats: { ...this.stats }
    }
  }

  /**
   * ç²å–å¥åº·ç‹€æ…‹
   */
  getHealthStatus () {
    const isHealthy = this.state.initialized &&
                     this.diagnosticData.logs.length < this.config.maxLogEntries

    return {
      service: 'DiagnosticService',
      healthy: isHealthy,
      status: this.state.active ? 'active' : 'inactive',
      collecting: this.state.collecting,
      metrics: {
        logsCollected: this.stats.logsCollected,
        diagnosticsPerformed: this.stats.diagnosticsPerformed,
        patternsDetected: this.stats.patternsDetected,
        reportsGenerated: this.stats.reportsGenerated
      }
    }
  }
}

module.exports = DiagnosticService
