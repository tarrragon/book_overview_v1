/**
 * Service Worker å•Ÿå‹•è™•ç†å™¨
 *
 * è² è²¬åŠŸèƒ½ï¼š
 * - è™•ç† Service Worker çš„å•Ÿå‹•å’Œé‡å•Ÿäº‹ä»¶
 * - å”èª¿ç³»çµ±æ¨¡çµ„çš„å•Ÿå‹•é †åº
 * - é‡æ–°åˆå§‹åŒ–é—œéµæœå‹™å’Œç›£è½å™¨
 * - æ¢å¾©ç³»çµ±ç‹€æ…‹å’Œé€£æ¥
 *
 * è¨­è¨ˆè€ƒé‡ï¼š
 * - åŸºæ–¼ BaseModule å¯¦ç¾æ¨™æº–ç”Ÿå‘½é€±æœŸç®¡ç†
 * - æ”¯æ´æ¨¡çµ„é–“çš„ä¾è³´é †åºç®¡ç†
 * - å¯¦ç¾å•Ÿå‹•å¤±æ•—çš„æ¢å¾©æ©Ÿåˆ¶
 * - æä¾›å•Ÿå‹•æ€§èƒ½ç›£æ§å’Œå„ªåŒ–
 */

const BaseModule = require('./base-module')
const { StandardError } = require('src/core/errors/StandardError')

class StartupHandler extends BaseModule {
  constructor (dependencies = {}) {
    super(dependencies)

    // å•Ÿå‹•ç›¸é—œæœå‹™
    this.eventCoordinator = dependencies.eventCoordinator || null
    this.messageRouter = dependencies.messageRouter || null
    this.pageMonitor = dependencies.pageMonitor || null
    this.errorHandler = dependencies.errorHandler || null

    // å•Ÿå‹•ç‹€æ…‹è¿½è¹¤
    this.startupInProgress = false
    this.startupStartTime = null
    this.startupDuration = null
    this.lastStartupSuccess = null
    this.startupAttempts = 0
    this.startupErrors = []

    // æ¨¡çµ„å•Ÿå‹•é †åºï¼ˆä¾è³´é—œä¿‚ï¼‰
    this.startupSequence = [
      'eventCoordinator', // äº‹ä»¶ç³»çµ±å„ªå…ˆ
      'errorHandler', // éŒ¯èª¤è™•ç†æ¬¡ä¹‹
      'messageRouter', // é€šè¨Šç³»çµ±
      'pageMonitor' // é é¢ç›£æ§æœ€å¾Œ
    ]
  }

  /**
   * åˆå§‹åŒ–å•Ÿå‹•è™•ç†å™¨
   * @returns {Promise<void>}
   * @protected
   */
  async _doInitialize () {
    this.logger.log('ğŸš€ åˆå§‹åŒ–å•Ÿå‹•è™•ç†å™¨')

    // åˆå§‹åŒ–ç›¸é—œæ¨¡çµ„ï¼ˆä½†ä¸å•Ÿå‹•ï¼‰
    const modules = [
      this.eventCoordinator,
      this.messageRouter,
      this.pageMonitor,
      this.errorHandler
    ]

    for (const module of modules) {
      if (module && typeof module.initialize === 'function') {
        try {
          await module.initialize()
        } catch (error) {
          this.logger.error(`âŒ æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—: ${module.constructor?.name}`, error)
          // è¨˜éŒ„éŒ¯èª¤ä½†ç¹¼çºŒåˆå§‹åŒ–å…¶ä»–æ¨¡çµ„
        }
      }
    }

    this.logger.log('âœ… å•Ÿå‹•è™•ç†å™¨åˆå§‹åŒ–å®Œæˆ')
  }

  /**
   * è™•ç† Service Worker å•Ÿå‹•äº‹ä»¶
   * @returns {Promise<void>}
   */
  async handleStartup () {
    if (this.startupInProgress) {
      this.logger.warn('âš ï¸ å•Ÿå‹•è™•ç†å·²åœ¨é€²è¡Œä¸­ï¼Œè·³éé‡è¤‡è™•ç†')
      return
    }

    try {
      this.startupInProgress = true
      this.startupStartTime = Date.now()
      this.startupAttempts++

      this.logger.log(`ğŸš€ é–‹å§‹è™•ç† Service Worker å•Ÿå‹• (å˜—è©¦ #${this.startupAttempts})`)

      // æ¸…ç†ä¸Šæ¬¡å•Ÿå‹•çš„ç‹€æ…‹
      await this.cleanupPreviousState()

      // æŒ‰é †åºå•Ÿå‹•æ¨¡çµ„
      await this.startupModulesInSequence()

      // æ¢å¾©ç³»çµ±ç‹€æ…‹
      await this.restoreSystemState()

      // è§¸ç™¼ç³»çµ±å°±ç·’äº‹ä»¶
      await this.emitSystemReadyEvent()

      // è¨˜éŒ„å•Ÿå‹•æˆåŠŸ
      this.startupDuration = Date.now() - this.startupStartTime
      this.lastStartupSuccess = Date.now()

      this.logger.log(`âœ… Service Worker å•Ÿå‹•å®Œæˆ (è€—æ™‚: ${this.startupDuration}ms)`)
    } catch (error) {
      this.startupErrors.push({
        error: error.message,
        timestamp: Date.now(),
        attempt: this.startupAttempts
      })

      this.logger.error('âŒ Service Worker å•Ÿå‹•å¤±æ•—:', error)

      // è§¸ç™¼å•Ÿå‹•å¤±æ•—äº‹ä»¶
      if (this.eventBus) {
        await this.eventBus.emit('SYSTEM.STARTUP.FAILED', {
          error: error.message,
          attempt: this.startupAttempts,
          timestamp: Date.now()
        })
      }

      // å˜—è©¦æ¢å¾©
      await this.attemptRecovery()

      throw error
    } finally {
      this.startupInProgress = false
      this.startupStartTime = null
    }
  }

  /**
   * æ¸…ç†ä¸Šæ¬¡å•Ÿå‹•çš„ç‹€æ…‹
   * @returns {Promise<void>}
   * @private
   */
  async cleanupPreviousState () {
    try {
      this.logger.log('ğŸ§¹ æ¸…ç†ä¸Šæ¬¡å•Ÿå‹•ç‹€æ…‹')

      // æ¸…ç†å¯èƒ½æ®˜ç•™çš„å…¨åŸŸè®Šæ•¸
      if (globalThis.backgroundStartTime) {
        delete globalThis.backgroundStartTime
      }

      if (globalThis.__bgInitPromise) {
        delete globalThis.__bgInitPromise
      }

      // é‡ç½®äº‹ä»¶ç³»çµ±å¼•ç”¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (globalThis.eventBus) {
        globalThis.eventBus = null
      }

      if (globalThis.chromeBridge) {
        globalThis.chromeBridge = null
      }

      this.logger.log('âœ… ä¸Šæ¬¡å•Ÿå‹•ç‹€æ…‹æ¸…ç†å®Œæˆ')
    } catch (error) {
      this.logger.error('âŒ æ¸…ç†ä¸Šæ¬¡å•Ÿå‹•ç‹€æ…‹å¤±æ•—:', error)
      // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œç¹¼çºŒå•Ÿå‹•æµç¨‹
    }
  }

  /**
   * æŒ‰é †åºå•Ÿå‹•æ¨¡çµ„
   * @returns {Promise<void>}
   * @private
   */
  async startupModulesInSequence () {
    this.logger.log('ğŸ”„ æŒ‰é †åºå•Ÿå‹•æ¨¡çµ„')

    for (const moduleName of this.startupSequence) {
      const module = this[moduleName]

      if (!module) {
        this.logger.warn(`âš ï¸ æ¨¡çµ„ä¸å­˜åœ¨: ${moduleName}`)
        continue
      }

      try {
        this.logger.log(`â–¶ï¸ å•Ÿå‹•æ¨¡çµ„: ${moduleName}`)

        if (typeof module.start === 'function') {
          await module.start()
        } else if (typeof module.initialize === 'function') {
          await module.initialize()
        }

        this.logger.log(`âœ… æ¨¡çµ„å•Ÿå‹•æˆåŠŸ: ${moduleName}`)

        // è§¸ç™¼æ¨¡çµ„å•Ÿå‹•äº‹ä»¶
        if (this.eventBus) {
          await this.eventBus.emit('MODULE.STARTUP.SUCCESS', {
            moduleName,
            timestamp: Date.now()
          })
        }
      } catch (error) {
        this.logger.error(`âŒ æ¨¡çµ„å•Ÿå‹•å¤±æ•—: ${moduleName}`, error)

        // è§¸ç™¼æ¨¡çµ„å•Ÿå‹•å¤±æ•—äº‹ä»¶
        if (this.eventBus) {
          await this.eventBus.emit('MODULE.STARTUP.FAILED', {
            moduleName,
            error: error.message,
            timestamp: Date.now()
          })
        }

        // æ ¹æ“šæ¨¡çµ„çš„é‡è¦æ€§æ±ºå®šæ˜¯å¦ç¹¼çºŒ
        if (this.isCriticalModule(moduleName)) {
          throw new StandardErrorWrapper('UNKNOWN_ERROR', 'é—œéµæ¨¡çµ„å•Ÿå‹•å¤±æ•—: ${moduleName}', {
            category: 'general'
          })
        }
      }
    }

    this.logger.log('âœ… æ¨¡çµ„åºåˆ—å•Ÿå‹•å®Œæˆ')
  }

  /**
   * åˆ¤æ–·æ˜¯å¦ç‚ºé—œéµæ¨¡çµ„
   * @param {string} moduleName - æ¨¡çµ„åç¨±
   * @returns {boolean}
   * @private
   */
  isCriticalModule (moduleName) {
    const criticalModules = ['eventCoordinator', 'errorHandler']
    return criticalModules.includes(moduleName)
  }

  /**
   * æ¢å¾©ç³»çµ±ç‹€æ…‹
   * @returns {Promise<void>}
   * @private
   */
  async restoreSystemState () {
    try {
      this.logger.log('ğŸ”„ æ¢å¾©ç³»çµ±ç‹€æ…‹')

      // æª¢æŸ¥å„²å­˜çš„ç³»çµ±ç‹€æ…‹
      const systemState = await chrome.storage.local.get([
        'isEnabled',
        'extractionSettings',
        'last_extraction'
      ])

      this.logger.log('ğŸ“‹ ç³»çµ±ç‹€æ…‹:', systemState)

      // æ¢å¾©é—œéµé…ç½®
      if (systemState.isEnabled === false) {
        this.logger.warn('âš ï¸ ç³»çµ±è™•æ–¼åœç”¨ç‹€æ…‹')
      }

      // è§¸ç™¼ç‹€æ…‹æ¢å¾©äº‹ä»¶
      if (this.eventBus) {
        await this.eventBus.emit('SYSTEM.STATE.RESTORED', {
          state: systemState,
          timestamp: Date.now()
        })
      }

      this.logger.log('âœ… ç³»çµ±ç‹€æ…‹æ¢å¾©å®Œæˆ')
    } catch (error) {
      this.logger.error('âŒ æ¢å¾©ç³»çµ±ç‹€æ…‹å¤±æ•—:', error)
      // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œç¹¼çºŒå•Ÿå‹•æµç¨‹
    }
  }

  /**
   * è§¸ç™¼ç³»çµ±å°±ç·’äº‹ä»¶
   * @returns {Promise<void>}
   * @private
   */
  async emitSystemReadyEvent () {
    try {
      this.logger.log('ğŸ¯ è§¸ç™¼ç³»çµ±å°±ç·’äº‹ä»¶')

      // è¨­å®šå…¨åŸŸå•Ÿå‹•æ™‚é–“
      globalThis.backgroundStartTime = Date.now()

      // æ¨™è¨˜äº‹ä»¶ç³»çµ±å°±ç·’
      if (this.eventBus && typeof this.eventBus.markReady === 'function') {
        this.eventBus.markReady()
      }

      // è§¸ç™¼ç³»çµ±å°±ç·’äº‹ä»¶
      if (this.eventBus) {
        await this.eventBus.emit('SYSTEM.READY', {
          timestamp: Date.now(),
          version: chrome.runtime.getManifest().version,
          startupDuration: Date.now() - this.startupStartTime,
          attempt: this.startupAttempts
        })
      }

      this.logger.log('âœ… ç³»çµ±å°±ç·’äº‹ä»¶å·²è§¸ç™¼')
    } catch (error) {
      this.logger.error('âŒ è§¸ç™¼ç³»çµ±å°±ç·’äº‹ä»¶å¤±æ•—:', error)
      throw error
    }
  }

  /**
   * å˜—è©¦å¾å•Ÿå‹•å¤±æ•—ä¸­æ¢å¾©
   * @returns {Promise<void>}
   * @private
   */
  async attemptRecovery () {
    try {
      this.logger.log('ğŸ”„ å˜—è©¦å¾å•Ÿå‹•å¤±æ•—ä¸­æ¢å¾©')

      // å¦‚æœå˜—è©¦æ¬¡æ•¸ä¸å¤šï¼Œå¯ä»¥é‡è©¦
      if (this.startupAttempts < 3) {
        this.logger.log(`ğŸ”„ æº–å‚™é‡è©¦å•Ÿå‹• (${this.startupAttempts}/3)`)

        // ç­‰å¾…çŸ­æš«æ™‚é–“å¾Œé‡è©¦
        await new Promise(resolve => setTimeout(resolve, 1000))

        // éè¿´é‡è©¦
        await this.handleStartup()
      } else {
        this.logger.error('âŒ å•Ÿå‹•é‡è©¦æ¬¡æ•¸å·²é”ä¸Šé™ï¼Œå•Ÿç”¨é™ç´šæ¨¡å¼')

        // å•Ÿç”¨é™ç´šæ¨¡å¼
        await this.enableDegradedMode()
      }
    } catch (error) {
      this.logger.error('âŒ æ¢å¾©å˜—è©¦å¤±æ•—:', error)
      // æœ€å¾Œçš„éŒ¯èª¤è™•ç†
      await this.handleFinalFailure()
    }
  }

  /**
   * å•Ÿç”¨é™ç´šæ¨¡å¼
   * @returns {Promise<void>}
   * @private
   */
  async enableDegradedMode () {
    try {
      this.logger.log('âš ï¸ å•Ÿç”¨ç³»çµ±é™ç´šæ¨¡å¼')

      // åªå•Ÿå‹•æœ€åŸºæœ¬çš„åŠŸèƒ½
      if (this.eventCoordinator && typeof this.eventCoordinator.start === 'function') {
        await this.eventCoordinator.start()
      }

      if (this.errorHandler && typeof this.errorHandler.start === 'function') {
        await this.errorHandler.start()
      }

      // è§¸ç™¼é™ç´šæ¨¡å¼äº‹ä»¶
      if (this.eventBus) {
        await this.eventBus.emit('SYSTEM.DEGRADED.MODE', {
          reason: 'startup_failure',
          timestamp: Date.now()
        })
      }

      this.logger.log('âš ï¸ é™ç´šæ¨¡å¼å•Ÿç”¨å®Œæˆ')
    } catch (error) {
      this.logger.error('âŒ å•Ÿç”¨é™ç´šæ¨¡å¼å¤±æ•—:', error)
      throw error
    }
  }

  /**
   * è™•ç†æœ€çµ‚å¤±æ•—
   * @returns {Promise<void>}
   * @private
   */
  async handleFinalFailure () {
    try {
      this.logger.error('ğŸ’¥ ç³»çµ±å•Ÿå‹•æœ€çµ‚å¤±æ•—')

      // è¨˜éŒ„è©³ç´°éŒ¯èª¤è³‡è¨Š
      const errorReport = {
        attempts: this.startupAttempts,
        errors: this.startupErrors,
        timestamp: Date.now()
      }

      // å˜—è©¦å„²å­˜éŒ¯èª¤å ±å‘Š
      await chrome.storage.local.set({
        startup_failure_report: errorReport
      })

      this.logger.error('ğŸ’¥ éŒ¯èª¤å ±å‘Šå·²å„²å­˜:', errorReport)
    } catch (error) {
      this.logger.error('âŒ è™•ç†æœ€çµ‚å¤±æ•—æ™‚ç™¼ç”ŸéŒ¯èª¤:', error)
    }
  }

  /**
   * å–å¾—å•Ÿå‹•ç‹€æ…‹è³‡è¨Š
   * @returns {Object} å•Ÿå‹•ç‹€æ…‹å ±å‘Š
   */
  getStartupStatus () {
    return {
      startupInProgress: this.startupInProgress,
      startupStartTime: this.startupStartTime,
      startupDuration: this.startupDuration,
      lastStartupSuccess: this.lastStartupSuccess,
      startupAttempts: this.startupAttempts,
      startupErrors: [...this.startupErrors],
      startupSequence: [...this.startupSequence],
      timestamp: Date.now()
    }
  }

  /**
   * å–å¾—è‡ªè¨‚å¥åº·ç‹€æ…‹
   * @returns {Object} è‡ªè¨‚å¥åº·ç‹€æ…‹
   * @protected
   */
  _getCustomHealthStatus () {
    const recentErrors = this.startupErrors.filter(
      error => Date.now() - error.timestamp < 300000 // 5åˆ†é˜å…§
    ).length

    return {
      startupInProgress: this.startupInProgress,
      lastStartupSuccess: this.lastStartupSuccess,
      recentErrors,
      hasModules: !!(this.eventCoordinator || this.messageRouter || this.pageMonitor || this.errorHandler),
      health: recentErrors > 2 ? 'unhealthy' : (this.lastStartupSuccess ? 'healthy' : 'degraded')
    }
  }
}

module.exports = StartupHandler
