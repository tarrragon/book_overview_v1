# 書庫擴充分類系統用例文件

## 概述

本文件描述書庫管理系統的進階分類功能，採用**專家建議優化的簡化設計**。此功能將在Chrome Extension和APP版本1.0完成後實作，專注於實用性和易用性。

## 🔥 優化後的設計原則

### 核心簡化策略
1. **三大類來源**：digital, physical, borrowed（專家建議）
2. **保持7級重要程度**：滿足使用者具體需求
3. **單一時間戳**：使用`updated_at`簡化同步機制
4. **管理模式專用**：分類功能只在管理模式顯示，不影響簡潔模式

### 資料模型優化
- **簡化來源架構**：三主類 + 子分類查找表
- **平台關聯設計**：電子書平台獨立表格管理
- **借閱資訊整合**：borrower_name直接儲存在書籍記錄中
- **可選功能定位**：所有分類都是使用者可選使用的進階功能

---

## UC-07: 簡化書籍來源分類管理

### 基本資訊
- **用例ID**: UC-07
- **用例名稱**: 管理簡化的書籍來源分類（管理模式專用）
- **主要行為者**: 使用者（進階功能使用者）
- **前置條件**: 基礎書庫系統已建立，使用者切換到管理模式
- **成功保證**: 書籍來源分類清晰易懂，支援平台特定顯示

### 簡化來源架構

#### 三大主分類（符合專家建議）
1. **Digital（數位書籍）**
   - source_type: `digital`
   - platform_id: 關聯到platforms表格
   - 顯示：平台特定圖標（Readmoo、Kindle、Kobo等）

2. **Physical（實體書籍）**
   - source_type: `physical`  
   - platform_id: NULL
   - 顯示：「實體書」統一圖標

3. **Borrowed（借閱相關）**
   - source_type: `borrowed`
   - 詳細資訊記錄在獨立的 `book_loans` 表格中
   - 支援的借閱類型：
     - `borrowed_from`: 從圖書館或朋友借來的書
     - `lent_to`: 借給朋友的書
   - 借閱狀態管理：
     - 借閱日期 (`borrowed_date`)
     - 到期日期 (`due_date`)
     - 歸還日期 (`returned_date`) - 空值表示尚未歸還
     - 來源名稱 (`source_name`) - 圖書館名稱或借閱者姓名
     - 備註 (`notes`) - 其他相關資訊

### 平台管理系統

#### 電子書平台表格
```sql
platforms表格:
- id: 1, name: 'readmoo', display_name: 'Readmoo'
- id: 2, name: 'kindle', display_name: 'Amazon Kindle'  
- id: 3, name: 'kobo', display_name: 'Kobo'
- id: 4, name: 'google_play', display_name: 'Google Play Books'
- id: 5, name: 'apple_books', display_name: 'Apple Books'
```

### 主要成功場景

1. **設定書籍來源**
   - 使用者在書籍詳細頁面選擇「編輯來源」
   - 系統顯示來源分類選單
   - 使用者選擇正確的來源分類
   - 系統更新資料庫並重新分類展示

2. **批次來源設定**
   - 使用者選擇多本書籍
   - 點擊「批次設定來源」
   - 選擇統一的來源分類
   - 系統批量更新選中書籍

3. **來源自動識別**
   - 新增書籍時系統根據匯入方式自動判斷來源
   - Readmoo匯入 → `readmoo`
   - ISBN掃描 → `physical`
   - 手動新增 → `manual_input`

4. **來源統計展示**
   - 書庫首頁顯示各來源統計數據
   - 圓餅圖展示來源分佈比例
   - 點擊統計可快速篩選該來源書籍

### 替代流程

**1a. 來源判斷模糊**
- 1a1. 系統無法確定書籍來源
- 1a2. 標記為`unknown`並提醒使用者手動設定
- 1a3. 在書籍列表中高亮顯示待分類項目

**2a. 外借書籍期限管理**
- 2a1. 使用者選擇`library`或`borrowed`來源
- 2a2. 系統要求輸入借閱期限
- 2a3. 自動設定到期提醒通知
- 2a4. 到期前3天發送歸還提醒

### 特殊需求
- **期限提醒**: 借閱書籍支援到期提醒功能
- **統計報表**: 提供各來源書籍數量和比例統計
- **快速篩選**: 支援按來源快速篩選書庫內容

---

## UC-07.1: 借閱管理系統（重要補充功能）

### 基本資訊
- **用例ID**: UC-07.1
- **用例名稱**: 綜合借閱管理系統（支援圖書館借閱與個人借出）
- **主要行為者**: 使用者
- **前置條件**: 書籍已加入書庫，書籍來源分類為 `borrowed`
- **成功保證**: 借閱資訊完整記錄，支援到期提醒和歸還追蹤

### 借閱管理資料結構

#### book_loans 表格欄位說明（🔥 專家建議優化：簡化設計）
```sql
-- 簡化後的借閱管理表格（從10個欄位減為6個核心欄位）
CREATE TABLE book_loans (
  book_id TEXT PRIMARY KEY,                        -- 一本書同時只能有一個借閱狀態
  loan_type TEXT NOT NULL CHECK(loan_type IN ('borrowed_from', 'lent_to')), -- 借閱類型
  source_name TEXT NOT NULL,                       -- 圖書館名稱或借閱者姓名
  due_date DATE NOT NULL,                          -- 到期日期（唯一重要的期限）
  returned_date DATE,                              -- 歸還日期（NULL表示未歸還）
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,   -- 最後更新時間
  FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE
);
```

### 主要成功場景

#### 1. 圖書館借書記錄
- 使用者選擇書籍設定來源為「借閱相關」
- 選擇借閱類型：「從圖書館借來 (borrowed_from)」
- 輸入圖書館名稱（例如：台北市立圖書館、政大圖書館）
- 設定借閱日期（預設今日）和到期日期
- 可選擇新增備註（例如：館藏位置、特殊限制）
- 系統自動計算剩餘天數並設定提醒

#### 2. 個人借出書籍記錄
- 使用者選擇已有書籍設定借出狀態
- 選擇借閱類型：「借給他人 (lent_to)」
- 輸入借閱者姓名
- 設定借出日期和預計歸還日期
- 可新增備註（例如：聯絡資訊、借閱條件）
- 系統追蹤借出狀態直到標記歸還

#### 3. 借閱到期提醒管理
- 系統每日檢查所有未歸還的借閱記錄
- 到期前3天：發送提前提醒通知
- 到期當日：發送到期提醒通知
- 超過到期日：標記為逾期並持續提醒
- 使用者可設定提醒頻率和方式

#### 4. 歸還處理流程
- 使用者標記書籍已歸還
- 系統記錄實際歸還日期 (`returned_date`)
- 自動停止相關提醒通知
- 更新借閱統計資料
- 可選擇保留借閱歷史記錄或移除

### 進階管理功能

#### 1. 借閱狀態視覺化
- **待歸還圖示**：顯示在書籍封面角落
  - 紅色：已逾期
  - 黃色：即將到期（3天內）
  - 綠色：正常期限內
- **借閱資訊快覽**：滑鼠懸停顯示借閱詳情
- **批次狀態更新**：支援多本書籍同時標記歸還

#### 2. 借閱統計報表
- **圖書館借閱分析**：各圖書館借閱頻率和偏好
- **個人借出管理**：追蹤借出書籍和歸還狀況
- **逾期風險評估**：識別經常逾期的模式
- **借閱成本分析**：計算罰款或借閱費用（如果適用）

#### 3. 智慧提醒系統
- **多通道提醒**：應用內通知、桌面通知
- **個人化設定**：自訂提醒時機和頻率
- **批次操作支援**：同時處理多本到期書籍
- **提醒歷史記錄**：追蹤提醒效果和使用者回應

### 替代流程

#### 2a. 借閱延期處理
- 2a1. 使用者申請或獲得借閱延期
- 2a2. 更新到期日期並記錄延期原因
- 2a3. 重新計算提醒時程
- 2a4. 記錄延期歷史供未來參考

#### 3a. 丟失或損壞處理
- 3a1. 使用者標記書籍為丟失或損壞狀態
- 3a2. 記錄相關資訊和可能的賠償責任
- 3a3. 停止歸還提醒但保留記錄
- 3a4. 提供後續處理指引

#### 4a. 借閱糾紛記錄
- 4a1. 記錄借閱過程中的問題或糾紛
- 4a2. 提供解決方案追蹤功能
- 4a3. 建立借閱黑名單或注意清單
- 4a4. 生成借閱風險評估報告

---

## UC-08: 七級重要程度分類管理（使用者堅持保留）

### 基本資訊
- **用例ID**: UC-08
- **用例名稱**: 管理書籍七級重要程度分類（管理模式專用）
- **主要行為者**: 使用者（進階功能使用者）
- **前置條件**: 書籍已存在於書庫中，使用者在管理模式
- **成功保證**: 重要程度分類支援個人化書籍管理，為可選進階功能

### 重要程度分類定義（1-7級）

**資料庫儲存**: `importance_level INTEGER CHECK(importance_level BETWEEN 1 AND 7)`

1. **參考書** (importance_level: 1): 要常拿起來查看的工具書、手冊
2. **重讀收藏** (importance_level: 2): 因為喜愛而想重複閱讀的書籍
3. **文獻保存** (importance_level: 3): 具重要學術或文獻價值需保存的書籍
4. **推薦分享** (importance_level: 4): 想推薦給他人的優質書籍
5. **收藏價值** (importance_level: 5): 基於收藏目的擁有的書籍
6. **裝飾展示** (importance_level: 6): 主要用於家居裝飾展示的書籍
7. **可清理** (importance_level: 7): 可考慮清理或轉讓的書籍

### 使用特性
- **完全可選**：使用者可選擇是否使用此分類系統
- **管理模式專用**：只在管理模式中顯示和操作
- **視覺化呈現**：使用數字和圖標組合顯示
- **智慧建議**：系統可基於使用模式提供分類建議（後續功能）

### 主要成功場景

1. **設定重要程度**
   - 使用者在書籍詳細頁面點擊「重要程度」
   - 系統展示7個分類選項，每個附帶說明和圖標
   - 使用者選擇適合的重要程度
   - 系統保存設定並更新書籍標記

2. **重要程度視覺化**
   - 書籍封面右上角顯示重要程度圖標
   - 不同分類使用不同顏色標記：
     - 參考書：紅色星號 ⭐
     - 重讀收藏：金色愛心 💛
     - 文獻保存：藍色資料夾 📁
     - 推薦分享：綠色分享 🔗
     - 收藏價值：紫色鑽石 💎
     - 裝飾展示：橙色畫框 🖼️
     - 可清理：灰色垃圾桶 🗑️

3. **按重要程度排序和篩選**
   - 書庫列表支援按重要程度排序
   - 篩選器提供重要程度選項
   - 支援多重要程度同時篩選

4. **重要程度統計分析**
   - 提供重要程度分佈統計報表
   - 識別可能需要清理的書籍（標記為可清理超過30天）
   - 推薦書籍清單生成（標記為推薦分享的書籍）

### 替代流程

**1a. 重要程度變更**
- 1a1. 使用者重新評估書籍重要程度
- 1a2. 修改現有分類設定
- 1a3. 系統記錄變更歷史
- 1a4. 更新相關統計數據

**4a. 清理建議生成**
- 4a1. 系統分析標記為`disposable`的書籍
- 4a2. 結合閱讀進度和最後訪問時間
- 4a3. 生成個人化的清理建議清單
- 4a4. 提供批次處理選項

### 特殊功能

**智慧分類建議**
- 基於閱讀頻率和訪問模式提供重要程度建議
- 長期未訪問的非參考書建議調降重要程度
- 經常查閱的書籍建議提升為參考書

**重要程度遷移**
- 支援批次修改多本書籍的重要程度
- 提供分類遷移嚮導協助使用者整理書庫
- 匯出重要書籍清單供備份或分享

---

## UC-09: 閱讀進度分類管理

### 基本資訊
- **用例ID**: UC-09
- **用例名稱**: 管理書籍閱讀進度分類
- **主要行為者**: 使用者
- **前置條件**: 書籍已加入書庫
- **成功保證**: 閱讀進度準確追蹤，支援時間管理和提醒

### 閱讀進度分類定義

1. **準備開始** (`ready_to_start`): 計劃近期開始閱讀的書籍
2. **正在閱讀** (`currently_reading`): 目前正在閱讀中的書籍
3. **已讀完畢** (`finished`): 已經讀完的書籍
4. **暫停閱讀** (`paused`): 暫時停止但計劃繼續的書籍
5. **不想讀了** (`not_interested`): 目前不想繼續閱讀的書籍
6. **有期限書籍** (`time_limited`): 圖書館或借來有歸還期限的書籍
7. **未分類** (`unclassified`): 尚未設定閱讀狀態的書籍

### 主要成功場景

1. **設定閱讀狀態**
   - 使用者點擊書籍的「閱讀狀態」按鈕
   - 系統顯示進度選項清單
   - 使用者選擇當前狀態
   - 系統記錄狀態變更時間

2. **閱讀進度追蹤**
   - 正在閱讀的書籍可設定閱讀進度百分比
   - 支援頁數或章節進度記錄
   - 自動計算預計完成時間
   - 提供閱讀速度統計

3. **有期限書籍管理**
   - 設定為`time_limited`時要求輸入歸還日期
   - 自動計算剩餘天數
   - 期限緊急程度視覺化標示：
     - 綠色：超過7天
     - 黃色：3-7天
     - 紅色：少於3天
   - 到期提醒通知

4. **閱讀計劃管理**
   - 「準備開始」清單作為閱讀待辦事項
   - 支援拖拽排序調整閱讀優先級
   - 智慧推薦下本書（基於類型和重要程度）

### 替代流程

**2a. 進度更新**
- 2a1. 使用者更新閱讀進度
- 2a2. 系統計算閱讀速度變化
- 2a3. 調整預計完成時間
- 2a4. 更新個人閱讀統計

**3a. 期限延期處理**
- 3a1. 有期限書籍接近到期
- 3a2. 提供「申請延期」選項
- 3a3. 記錄延期歷史
- 3a4. 更新新的到期日期

**4a. 閱讀目標設定**
- 4a1. 使用者設定月度或年度閱讀目標
- 4a2. 系統追蹤目標達成進度
- 4a3. 提供智慧建議調整閱讀計劃
- 4a4. 生成個人閱讀報告

### 閱讀統計功能

**個人閱讀分析**
- 月度/年度閱讀完成數量統計
- 平均閱讀速度分析
- 閱讀類型偏好分析
- 閱讀習慣時間分佈

**進度視覺化**
- 閱讀進度環形圖
- 月度閱讀目標達成圖表
- 有期限書籍倒數計時器
- 閱讀里程碑成就系統

---

## UC-10: 標籤系統管理

### 基本資訊
- **用例ID**: UC-10
- **用例名稱**: 管理書籍標籤系統
- **主要行為者**: 使用者
- **前置條件**: 書庫系統運行正常
- **成功保證**: 標籤系統功能完整，支援靈活分類和高效搜尋

### 標籤系統設計

#### 標籤類型
- **內容標籤**: 描述書籍內容主題（科幻、歷史、自傳等）
- **情境標籤**: 描述閱讀情境（通勤閱讀、睡前讀物等）
- **難度標籤**: 描述內容難度（入門、進階、專業等）
- **語言標籤**: 標示書籍語言（中文、英文、日文等）
- **格式標籤**: 標示書籍格式（精裝、平裝、有聲書等）
- **自定義標籤**: 使用者完全自定義的標籤

#### 標籤特性
- 支援中英文標籤名稱
- 標籤可設定顏色區分
- 支援階層式標籤（父子關係）
- 標籤使用頻率統計

### 主要成功場景

1. **新增標籤**
   - 使用者在書籍詳細頁面點擊「新增標籤」
   - 輸入標籤名稱（支援中英文和符號）
   - 選擇標籤顏色（從預設色盤或自定義）
   - 可選擇父標籤建立階層關係
   - 系統保存標籤並應用到當前書籍

2. **標籤自動建議**
   - 輸入標籤名稱時顯示相似標籤建議
   - 基於書籍標題和內容智慧推薦相關標籤
   - 顯示使用者常用標籤快速選擇
   - 根據書籍類型推薦預設標籤

3. **批次標籤管理**
   - 選擇多本書籍進行批次標籤操作
   - 支援批次新增、移除、替換標籤
   - 提供標籤合併功能（將多個相似標籤合併）
   - 標籤重新命名會同步更新所有相關書籍

4. **標籤搜尋和篩選**
   - 搜尋框支援標籤名稱搜尋
   - 點擊標籤可快速篩選包含該標籤的所有書籍
   - 支援多標籤組合篩選（AND/OR邏輯）
   - 標籤雲展示使用頻率最高的標籤

### 進階標籤功能

1. **標籤統計分析**
   - 標籤使用頻率統計圖表
   - 標籤與閱讀進度關聯分析
   - 標籤與重要程度交叉分析
   - 個人標籤使用偏好報告

2. **智慧標籤推薦**
   - 基於已讀書籍推薦新書標籤
   - 分析標籤關聯性提供相關書籍推薦
   - 檢測標籤使用異常（重複、拼寫錯誤）
   - 建議標籤整理和優化方案

3. **標籤匯出分享**
   - 匯出個人標籤系統供其他裝置同步
   - 分享特定標籤的書籍清單
   - 匯入其他使用者的標籤系統
   - 社群標籤推薦和交流

### 替代流程

**1a. 標籤重複檢查**
- 1a1. 系統檢測到相似或重複標籤
- 1a2. 提示使用者：「已存在相似標籤：『xxx』」
- 1a3. 提供選項：使用現有、建立新標籤、合併標籤
- 1a4. 記錄使用者選擇偏好

**3a. 標籤衝突處理**
- 3a1. 批次操作中發現標籤衝突
- 3a2. 暫停操作並顯示衝突清單
- 3a3. 使用者逐一解決或選擇統一處理策略
- 3a4. 完成衝突解決後繼續批次操作

**4a. 搜尋優化**
- 4a1. 標籤搜尋無結果
- 4a2. 提供模糊搜尋和拼寫建議
- 4a3. 顯示相關標籤和同義詞
- 4a4. 提供「建立新標籤」快速選項

### 標籤管理介面設計

**標籤展示方式**
- 書籍卡片：顯示前3個最重要標籤
- 書籍詳細頁：完整標籤清單，支援即時編輯
- 標籤雲頁面：視覺化標籤使用頻率
- 側邊欄篩選：快速標籤篩選器

**標籤互動設計**
- 點擊標籤：快速篩選該標籤書籍
- 長按標籤：顯示編輯選單
- 拖拽標籤：在書籍間複製標籤
- 雙擊標籤：進入標籤詳細管理頁面

---

## UC-11: 多維度分類綜合展示

### 基本資訊
- **用例ID**: UC-11
- **用例名稱**: 多維度分類系統綜合展示和管理
- **主要行為者**: 使用者
- **前置條件**: 所有分類系統已設定完成
- **成功保證**: 四維度分類資訊清晰展示，支援複雜查詢和管理

### 四列式展示設計

#### 第一列：書籍來源
- 圖標展示：不同平台使用專屬圖標
- 顏色編碼：每個來源分配專屬顏色
- 借閱狀態特殊顯示：
  - **Borrowed類型額外資訊**：顯示借閱類型圖標
  - **到期提醒**：借閱書籍顯示剩餘天數和緊急程度顏色
  - **來源詳情**：滑鼠懸停顯示圖書館或借閱者姓名
- 快速篩選：點擊可篩選同來源書籍

#### 第二列：重要程度
- 星級評分：視覺化重要程度（1-7星）
- 圖標分類：每個重要程度使用專屬圖標
- 顏色梯度：重要程度使用色彩深淺區分
- 優先排序：可按重要程度排序顯示

#### 第三列：閱讀進度
- 進度條：顯示具體閱讀百分比
- 狀態圖標：不同閱讀狀態使用專屬圖標
- 時間資訊：顯示狀態變更時間
- 期限警示：有期限書籍的緊急程度標示

#### 第四列：標籤清單
- 標籤氣泡：以氣泡形式展示所有標籤
- 顏色分類：不同類型標籤使用不同顏色
- 省略顯示：超過3個標籤時顯示「+N」
- 展開檢視：點擊可展開完整標籤清單

### 主要成功場景

1. **多維度綜合檢視**
   - 書庫主頁顯示四列式分類資訊
   - 每本書籍顯示完整的四維度分類狀態
   - 支援緊湊模式和詳細模式切換
   - 響應式設計適應不同螢幕尺寸

2. **複合篩選查詢**
   - 篩選器支援四個維度同時篩選
   - 邏輯運算：AND、OR、NOT組合查詢
   - 快速篩選：預設常用篩選組合
   - 篩選歷史：記住使用者常用篩選條件

3. **批次分類管理**
   - 選擇多本書籍進行批次分類設定
   - 支援四個維度的批次修改
   - 批次操作預覽：顯示變更前後對比
   - 操作歷史：支援撤銷和重做

4. **智慧分類建議**
   - 分析使用者分類習慣提供建議
   - 檢測分類不一致的書籍
   - 推薦最佳分類組合
   - 自動標記需要關注的分類異常

### 進階展示功能

1. **分類統計儀表板**
   - 四維度分類統計圖表
   - 交叉分析：重要程度 × 閱讀進度統計
   - 趨勢分析：分類變化時間趨勢
   - 個人化洞察：基於分類數據的閱讀建議

2. **自定義檢視模式**
   - 使用者可自定義四列顯示順序
   - 支援隱藏不需要的分類列
   - 儲存多套檢視模式配置
   - 情境化檢視：不同情境使用不同配置

3. **分類資料匯出**
   - 完整分類資料匯出為CSV/Excel
   - 支援按維度分別匯出
   - 分類統計報告產生
   - 個人閱讀分析報告匯出

### 搜尋和查詢增強

1. **智慧搜尋**
   - 支援書名、作者、標籤一體化搜尋
   - 分類條件搜尋：「參考書 + 正在閱讀」
   - 自然語言查詢：「我想找推薦給朋友的科幻書」
   - 搜尋結果按相關性和分類權重排序

2. **複合查詢建構器**
   - 視覺化查詢建構介面
   - 拖拽方式組合查詢條件
   - 查詢條件儲存和重用
   - 查詢結果訂閱：條件變化時自動通知

3. **相關書籍推薦**
   - 基於分類相似性推薦書籍
   - 「相似分類」書籍發現
   - 分類缺口分析：發現可能感興趣的領域
   - 閱讀多樣性建議

---

## UC-12: 分類系統資料遷移和同步

### 基本資訊
- **用例ID**: UC-12
- **用例名稱**: 分類系統資料遷移和跨裝置同步
- **主要行為者**: 系統（自動）和使用者（手動觸發）
- **前置條件**: 基礎書庫系統和分類系統已建立
- **成功保證**: 分類資料完整遷移，跨裝置同步一致

### 資料結構擴充

#### 簡化資料庫Schema（專家建議優化）
```sql
-- 書籍表格已在app-requirements-spec.md中定義，這裡展示擴充分類欄位
-- 主要書籍表格使用簡化設計：
-- - source_type: 'digital', 'physical', 'borrowed'（三大類）
-- - platform_id: 關聯platforms表格（數位書籍用）
-- - importance_level: 1-7級重要程度（可選）
-- - reading_status: 'reading', 'finished', 'queued'（簡化版）
-- - tags: 透過book_tags關聯表管理
-- - updated_at: 單一時間戳記錄最後變更時間

-- 🔥 簡化後的借閱管理獨立表格設計（專家建議優化）
CREATE TABLE book_loans (
    book_id TEXT PRIMARY KEY,                        -- 一本書同時只能有一個借閱狀態
    loan_type TEXT NOT NULL CHECK(loan_type IN ('borrowed_from', 'lent_to')), -- 借閱類型
    source_name TEXT NOT NULL,                       -- 圖書館名稱或借閱者姓名
    due_date DATE NOT NULL,                          -- 到期日期（唯一重要的期限）
    returned_date DATE,                              -- 歸還日期（NULL表示未歸還）
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,   -- 最後更新時間
    FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE
);

-- 重要：所有分類欄位都允許NULL，代表使用者未設定（可選功能）
-- 簡潔模式只顯示：封面、書名、source_type對應的圖標
-- 管理模式顯示：完整分類資訊（如果已設定）

-- 標籤系統表格
CREATE TABLE tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    color TEXT DEFAULT '#007AFF',
    parent_tag_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    usage_count INTEGER DEFAULT 0,
    FOREIGN KEY (parent_tag_id) REFERENCES tags(id)
);

-- 書籍標籤關聯表
CREATE TABLE book_tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    book_id TEXT NOT NULL,
    tag_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (book_id) REFERENCES books(id),
    FOREIGN KEY (tag_id) REFERENCES tags(id),
    UNIQUE(book_id, tag_id)
);

-- 閱讀歷史記錄
CREATE TABLE reading_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    book_id TEXT NOT NULL,
    status_from TEXT,
    status_to TEXT NOT NULL,
    progress_from REAL,
    progress_to REAL,
    recorded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (book_id) REFERENCES books(id)
);

-- 🔥 專家建議優化：簡化觸發器設計（消除觸發器地獄）
-- 使用單一 updated_at 觸發器，簡單可靠，符合 Last-Write-Wins 策略

-- 主要表格的統一更新觸發器
CREATE TRIGGER books_update_all_timestamp 
  AFTER UPDATE ON books
  BEGIN
    UPDATE books SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
  END;

CREATE TRIGGER tags_update_all_timestamp 
  AFTER UPDATE ON tags
  BEGIN
    UPDATE tags SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
  END;

CREATE TRIGGER book_tags_update_all_timestamp 
  AFTER UPDATE ON book_tags
  BEGIN
    UPDATE book_tags SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
  END;

CREATE TRIGGER book_loans_update_all_timestamp 
  AFTER UPDATE ON book_loans
  BEGIN
    UPDATE book_loans SET updated_at = CURRENT_TIMESTAMP WHERE book_id = NEW.book_id;
  END;

-- 🔥 專家建議：資料一致性約束（確保 borrowed 類型資料完整性）
-- 當書籍設定為 borrowed 來源時，確保有對應的借閱記錄
CREATE TRIGGER ensure_borrowed_loan_consistency 
  AFTER UPDATE OF source_type ON books
  WHEN NEW.source_type = 'borrowed'
  BEGIN
    INSERT OR IGNORE INTO book_loans (book_id, loan_type, source_name, due_date) 
    VALUES (NEW.id, 'borrowed_from', 'UNKNOWN_SOURCE', date('now', '+7 days'));
  END;
```

### 資料遷移場景

1. **現有資料升級**
   - 自動檢測現有書庫資料
   - 為現有書籍設定預設分類值
   - 保留原有來源資訊映射到新分類系統
   - 生成資料遷移報告

2. **分類資料匯出**
   - 匯出完整的四維度分類資料
   - JSON格式包含所有分類資訊和標籤
   - 支援選擇性匯出特定分類維度
   - 匯出資料版本控制

3. **分類資料匯入**
   - 匯入其他裝置的分類設定
   - 智慧合併重複和衝突的分類
   - 匯入預覽和確認機制
   - 匯入失敗回滾機制

4. **跨裝置同步準備**
   - 分類變更追蹤和版本控制
   - 增量同步支援
   - 衝突偵測和解決策略
   - 同步狀態監控

### 匯出格式設計

#### 完整分類資料JSON格式
```json
{
  "export_version": "2.1",
  "export_timestamp": "2024-03-15T10:30:00Z",
  "classification_data": {
    "books": [
      {
        "id": "210327003000101",
        "title": "大腦不滿足",
        "source_type": "readmoo",
        "importance_level": "reference",
        "reading_status": "currently_reading",
        "reading_progress": 0.35,
        "tags": ["心理學", "科學", "neuroscience"],
        "due_date": null,
        "reading_start_date": "2024-03-01T00:00:00Z",
        "updated_at": "2024-03-15T09:45:30Z",
        "created_at": "2024-02-15T14:20:00Z",
        "classification_version": 3,
        "field_timestamps": {
          "source_type_updated_at": "2024-02-15T14:20:00Z",
          "importance_level_updated_at": "2024-02-28T16:30:00Z",
          "reading_status_updated_at": "2024-03-01T00:00:00Z",
          "reading_progress_updated_at": "2024-03-15T09:45:30Z",
          "tags_updated_at": "2024-03-10T11:15:20Z"
        },
        "classification_history": [
          {
            "field": "reading_status",
            "old_value": "ready_to_start",
            "new_value": "currently_reading", 
            "changed_at": "2024-03-01T00:00:00Z"
          },
          {
            "field": "importance_level",
            "old_value": "unclassified",
            "new_value": "reference", 
            "changed_at": "2024-02-28T16:30:00Z"
          }
        ]
      }
    ],
    "tags": [
      {
        "id": 1,
        "name": "心理學",
        "color": "#FF6B6B",
        "parent_tag_id": null,
        "usage_count": 15,
        "created_at": "2024-02-10T10:00:00Z",
        "updated_at": "2024-03-10T11:15:20Z"
      },
      {
        "id": 2,
        "name": "neuroscience",
        "color": "#4ECDC4", 
        "parent_tag_id": 1,
        "usage_count": 8,
        "created_at": "2024-03-10T11:15:20Z",
        "updated_at": "2024-03-10T11:15:20Z"
      }
    ],
    "classification_stats": {
      "source_distribution": {
        "readmoo": 45,
        "physical": 32,
        "kindle": 18
      },
      "importance_distribution": {
        "reference": 25,
        "reread": 30,
        "archive": 15
      },
      "reading_status_distribution": {
        "currently_reading": 8,
        "finished": 67,
        "ready_to_start": 20
      }
    }
  }
}
```

### 簡化同步衝突解決（專家建議採用）

#### 🔥 單一時間戳優先機制

1. **衝突類型（已簡化）**
   - 同書籍的分類設定差異
   - 標籤關聯不一致
   - 借閱資訊衝突

2. **自動解決策略（Last-Write-Wins）**

   **唯一策略：updated_at 時間戳比較**
   - 比較書籍記錄的 `updated_at` 欄位
   - **最新時間戳優先**：較新的記錄完全覆蓋較舊的記錄
   - **簡單可靠**：避免複雜的欄位級合併邏輯
   
   **衝突解決範例**：
   ```
   裝置A: updated_at = "2024-03-15T10:30:00Z"
   裝置B: updated_at = "2024-03-15T09:45:30Z"
   結果: 採用裝置A的完整記錄（時間較新）
   ```
   
   **優點**：
   - 實作簡單，不易出錯
   - 效能優異，同步速度快
   - 符合使用者直觀預期（最後修改生效）

3. **衝突預防機制（簡化版）**
   - **單一觸發器**：只使用 `updated_at` 自動更新觸發器
   - **即時同步**：網路可用時立即同步變更
   - **離線標記**：離線修改自動標記為待同步狀態
   - **錯誤恢復**：同步失敗時提供重試機制

4. **手動介入（極少數情況）**
   - **時間戳異常**：如果發現時間戳明顯錯誤
   - **使用者選擇**：提供「保留本地版本」或「使用雲端版本」選項
   - **簡單明確**：避免複雜的合併介面，維持使用者友善體驗

---

## UC-13: 簡化同步與後續功能規劃

### 基本資訊
- **用例ID**: UC-13
- **用例名稱**: 後續功能擴展規劃（2.0版本後）
- **設計目標**: 為未來功能預留架構空間，但維持當前系統簡潔性

### 後續功能列表

#### 智慧查詢增強
- **Amazon API備用查詢**：Google Books API失敗時的備用選項
- **台灣出版品資料庫**：本地出版品資訊查詢
- **OCR文字識別**：封面文字識別輔助書籍識別

#### 分析功能（非優先）
- **閱讀統計分析**：基於管理模式的分類資料
- **個人化推薦**：基於重要程度和標籤的書籍推薦
- **社群功能**：分類系統分享和學習

#### 進階同步功能
- **雲端儲存整合**：Google Drive、iCloud等
- **多裝置即時同步**：WebSocket實時同步
- **協作功能**：家庭成員共享書庫

### 當前版本專注點
- **核心功能**：匯入、掃描、雙模式展示
- **基本分類**：三大來源類型 + 可選7級重要程度  
- **簡單同步**：單一時間戳 + Last-Write-Wins
- **穩定可靠**：避免過度設計，專注使用者價值

---

## 系統整合和使用者體驗

### 分類系統學習曲線

#### 新手引導模式
1. **分段介紹**：分四個步驟介紹各維度分類
2. **範例展示**：使用範例書籍演示分類設定
3. **智慧預設**：為新手提供合理的預設分類建議
4. **快速設定**：提供常見分類組合快速設定

#### 進階使用者功能
- 分類系統個人化設定
- 複雜查詢和批次操作
- 分類資料分析和洞察
- 自動化分類規則設定

### 效能最佳化考量

#### 資料庫效能
- 分類欄位建立適當索引
- 複合查詢最佳化
- 標籤關聯表效能調整
- 大量資料分頁處理

#### 使用者介面效能
- 分類資訊懶載入
- 標籤雲虛擬化處理
- 搜尋結果快取機制
- 響應式載入和互動

### 未來擴展可能

#### 機器學習增強
- 自動分類建議
- 閱讀偏好學習
- 智慧標籤推薦
- 個人化分類最佳化

#### 社群功能整合
- 分類系統分享
- 標籤使用趨勢
- 社群推薦書籍
- 閱讀挑戰和成就

---

## 總結

經過專家審查和使用者反饋優化後，擴充分類系統採用**簡潔優先、功能可選**的設計理念，為書庫管理提供實用而不複雜的進階功能。

### 🔥 優化後的關鍵特色

1. **簡化的資料架構**
   - **三大來源分類**：digital, physical, borrowed（符合專家建議）
   - **單一時間戳同步**：使用`updated_at`避免複雜的同步邏輯
   - **平台關聯設計**：電子書平台透過查找表管理

2. **雙模式用戶體驗**
   - **簡潔模式預設**：只顯示封面、書名、來源圖標
   - **管理模式可選**：完整分類功能供進階使用者使用
   - **異步資料補充**：立即可用，背景完善

3. **保留重要功能**
   - **7級重要程度分類**：滿足使用者特定需求
   - **綜合借閱管理系統**：完整支援圖書館借閱和個人借出，包含到期提醒、歸還追蹤、統計分析
   - **標籤系統**：彈性的個人化分類方案

### 使用者價值

**一般使用者**：享受簡潔直觀的書庫瀏覽體驗，無需學習複雜功能
**進階使用者**：獲得強大的分類和管理工具，滿足個人化需求
**所有使用者**：受益於異步資料補充，無需等待即可開始使用

### 技術優勢

1. **簡單可靠**：Last-Write-Wins同步策略，避免複雜衝突處理
2. **效能優異**：單一觸發器，最小化資料庫負載  
3. **維護容易**：清晰的資料結構，減少技術債務
4. **擴展友善**：為後續功能預留架構空間，但不影響當前簡潔性

### 開發策略

遵循專家建議，優先開發核心功能，讓使用者能**快速找到想讀的書**，而不是維護複雜的分類系統。進階功能作為可選增強，不影響基本使用流程。

這個優化設計在技術優雅性和使用者價值之間找到了最佳平衡點。