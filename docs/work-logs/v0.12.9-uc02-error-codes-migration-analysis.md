# UC-02: 日常書籍資料提取 ErrorCodes 遷移分析報告 v0.12.9

**分析日期**: 2025-09-16  
**分析師**: sage-design-architect (TDD Phase 1)  
**任務**: 評估 UC-02 驗收資料夾需要按 ErrorCodes 系統 v5.0.0 更新的範圍

## 🎯 執行摘要

### 核心發現
UC-02 驗收資料夾目前使用了**複雜的 StandardError 分類系統**，包含 15 個詳細的錯誤代碼，需要全面遷移到新的 **15 個核心 ErrorCodes** 架構。

### 遷移必要性評估
**🚨 高度必要**: UC-02 exceptions.md 文件與新 ErrorCodes 系統 v5.0.0 存在結構性差異，必須進行系統性更新以保持一致性。

## 🔍 詳細分析

### 1. 現有 StandardError 定義分析

#### 當前 UC-02 錯誤分類 (15 個錯誤代碼)
```
DATA_ERROR 類別:
├── DATA_DUPLICATE_DETECTION_FAILED
├── DATA_INCREMENTAL_UPDATE_CONFLICT  
├── DATA_PROGRESS_VALIDATION_ERROR

DOM_ERROR 類別:
├── DOM_PAGE_STRUCTURE_CHANGED
├── DOM_INFINITE_SCROLL_DETECTION_FAILED
├── DOM_DYNAMIC_CONTENT_TIMEOUT

SYSTEM_ERROR 類別:
├── SYSTEM_INCREMENTAL_PROCESSING_OVERLOAD
├── SYSTEM_BACKGROUND_SYNC_FAILURE

NETWORK_ERROR 類別:
├── NETWORK_RATE_LIMITING_DETECTED
├── NETWORK_PARTIAL_CONNECTIVITY

PLATFORM_ERROR 類別:
├── PLATFORM_TAB_SWITCHING_INTERFERENCE
├── PLATFORM_CHROME_EXTENSION_CONFLICT
```

#### 新 ErrorCodes 系統架構 (15 個核心代碼)
```
核心 ErrorCodes:
├── VALIDATION_ERROR    (驗證相關錯誤)
├── NETWORK_ERROR      (網路相關錯誤) 
├── STORAGE_ERROR      (儲存相關錯誤)
├── READMOO_ERROR      (Readmoo 平台錯誤)
├── CHROME_ERROR       (Chrome Extension 錯誤)
├── BOOK_ERROR         (書籍處理錯誤)
├── DOM_ERROR          (DOM 操作錯誤)
├── FILE_ERROR         (檔案處理錯誤)
├── OPERATION_ERROR    (操作執行錯誤)
├── PERMISSION_ERROR   (權限相關錯誤)
├── TIMEOUT_ERROR      (逾時錯誤)
├── PARSE_ERROR        (解析錯誤)
├── CONNECTION_ERROR   (連線錯誤)
├── CONFIG_ERROR       (設定錯誤)
├── UNKNOWN_ERROR      (未知錯誤)
```

### 2. 錯誤代碼對應建議

#### 🎯 直接對應 (5 個錯誤)
| 舊 StandardError | 新 ErrorCodes | 信心度 |
|------------------|---------------|--------|
| `DATA_PROGRESS_VALIDATION_ERROR` | `VALIDATION_ERROR` | 100% |
| `DOM_PAGE_STRUCTURE_CHANGED` | `DOM_ERROR` | 100% |
| `DOM_INFINITE_SCROLL_DETECTION_FAILED` | `DOM_ERROR` | 100% |
| `DOM_DYNAMIC_CONTENT_TIMEOUT` | `TIMEOUT_ERROR` | 90% |
| `NETWORK_RATE_LIMITING_DETECTED` | `NETWORK_ERROR` | 100% |

#### 🤔 需要語意合併 (7 個錯誤)
| 舊 StandardError | 新 ErrorCodes | 語意調整說明 |
|------------------|---------------|-------------|
| `DATA_DUPLICATE_DETECTION_FAILED` | `BOOK_ERROR` | 去重邏輯屬於書籍處理流程 |
| `DATA_INCREMENTAL_UPDATE_CONFLICT` | `BOOK_ERROR` | 增量更新衝突歸類為書籍處理問題 |
| `SYSTEM_INCREMENTAL_PROCESSING_OVERLOAD` | `OPERATION_ERROR` | 處理負載問題歸類為操作執行錯誤 |
| `SYSTEM_BACKGROUND_SYNC_FAILURE` | `OPERATION_ERROR` | 背景同步歸類為操作執行錯誤 |
| `NETWORK_PARTIAL_CONNECTIVITY` | `CONNECTION_ERROR` | 部分連接問題使用更精準的連線錯誤 |
| `PLATFORM_TAB_SWITCHING_INTERFERENCE` | `CHROME_ERROR` | 分頁切換屬於 Chrome 環境問題 |
| `PLATFORM_CHROME_EXTENSION_CONFLICT` | `CHROME_ERROR` | 擴充功能衝突直接歸類 |

#### 🔄 需要重新設計 (3 個錯誤)
某些複雜的錯誤情境需要重新思考錯誤處理策略：
- 部分錯誤可能需要拆分為多個更簡單的錯誤類型
- 複雜的恢復邏輯可能需要簡化為更直觀的使用者引導

### 3. 測試覆蓋分析

#### 測試策略更新需求
```javascript
// ❌ 舊的複雜測試格式
await expect(operation()).rejects.toMatchObject({
  code: 'DATA_DUPLICATE_DETECTION_FAILED',
  severity: 'MODERATE',
  totalBooksScanned: 25,
  duplicateChecksFailed: 3
})

// ✅ 新的簡化測試格式  
expect(() => operation()).toThrow(ErrorCodes.BOOK_ERROR)
// 或帶詳細訊息
expect(() => operation()).toThrow('duplicate detection failed')
```

#### 測試遷移工作量估算
- **Unit Tests**: 需要更新 ~15-20 個測試案例
- **Integration Tests**: 需要重新設計 ~5-8 個整合測試
- **E2E Tests**: 需要調整 ~3-5 個端對端測試情境

### 4. 功能實作細節更新需求

#### 4.1 錯誤拋出方式變更
```javascript
// ❌ 舊方式 - 複雜的 StandardError
throw new StandardError('DATA_DUPLICATE_DETECTION_FAILED', '重複書籍檢測機制失敗', {
  severity: 'MODERATE',
  totalBooksScanned: 25,
  duplicateChecksFailed: 3,
  affectedBooks: [...],
  fallbackStrategy: 'manual_review'
})

// ✅ 新方式 - 簡化的原生 Error
throw new Error(`${ErrorCodes.BOOK_ERROR}: Duplicate book detection failed`)

// ✅ 需要額外資訊時
const error = new Error(`${ErrorCodes.BOOK_ERROR}: Duplicate book detection failed`)
error.details = { 
  scanned: 25, 
  failed: 3, 
  books: [...] 
}
throw error
```

#### 4.2 使用者體驗保持策略
雖然錯誤分類簡化，但**使用者體驗標準必須維持**：
- 錯誤訊息仍需清楚具體
- 恢復機制仍需完整
- 使用者引導仍需詳細

## 📋 TDD 測試策略

### Phase 1: 功能設計規範 (當前階段)
- ✅ **完成**: UC-02 錯誤代碼對應分析
- ✅ **完成**: 測試策略設計
- 🔄 **進行中**: 驗收標準制定

### Phase 2: 測試設計 (sage-test-architect)
**移交清單**：
- [ ] 15 個舊錯誤代碼 → 15 個新 ErrorCodes 對應表
- [ ] 測試案例重新設計清單 (~20 個測試)
- [ ] 使用者體驗保持驗證標準
- [ ] TDD 循環執行順序建議

### Phase 3: 實作 (thyme-extension-engineer)
**移交需求**：
- [ ] 錯誤拋出語法更新規範
- [ ] 使用者通知訊息調整指引
- [ ] 恢復機制簡化實作方案

### Phase 4: 整合驗證 (sage-test-architect)
**驗證重點**：
- [ ] 使用者體驗無退化
- [ ] 錯誤處理完整性 100%
- [ ] 效能改善確認

## 🚀 更新優先級評估

### 🔴 Critical Priority (立即更新)
1. **exceptions.md 核心錯誤對應** - 影響所有後續開發決策
2. **使用者通知訊息調整** - 直接影響使用者體驗
3. **測試案例格式更新** - 確保 TDD 循環可執行

### 🟡 High Priority (本週完成)
1. **功能實作細節文檔更新**
2. **測試覆蓋分析更新**  
3. **與其他 UC 的錯誤關聯分析**

### 🟢 Medium Priority (兩週內完成)
1. **效能提升數據收集**
2. **開發體驗改善評估**
3. **長期維護策略調整**

## 📊 工作量估算

### 文檔更新工作量
- **exceptions.md 重寫**: 4-6 小時
- **test-coverage.md 更新**: 2-3 小時
- **functional-details.md 調整**: 2-3 小時
- **總工作量**: 8-12 小時

### 測試重構工作量  
- **Unit Test 更新**: 6-8 小時
- **Integration Test 重設計**: 4-6 小時
- **E2E Test 調整**: 3-4 小時
- **總工作量**: 13-18 小時

### 實作更新工作量
- **錯誤處理邏輯更新**: 8-10 小時
- **使用者介面調整**: 4-6 小時
- **回歸測試執行**: 2-3 小時
- **總工作量**: 14-19 小時

### 總專案工作量預估
**35-49 小時** (約 1-1.5 個工作週，多人並行執行)

## 🎯 驗收標準

### 功能完整性驗收
- [ ] 15 個舊 StandardError 全部遷移完成
- [ ] 使用者體驗標準 100% 維持
- [ ] 錯誤恢復機制 100% 保留
- [ ] 測試通過率 100%

### 效能改善驗收
- [ ] 錯誤建立時間改善 > 2x
- [ ] 記憶體使用減少 > 35%
- [ ] 測試執行時間減少 > 20%

### 開發體驗驗收  
- [ ] 錯誤處理程式碼簡化 > 50%
- [ ] 新開發者學習成本降低 > 60%
- [ ] ESLint 規則兼容性 100%

## 🔄 後續行動計畫

### 立即行動 (今日)
1. **移交 sage-test-architect**: 提供錯誤對應表和測試設計要求
2. **開始 exceptions.md 重寫**: 使用新 ErrorCodes 架構
3. **準備 TDD 測試循環**: 設定第一個測試案例

### 本週行動
1. **完成所有驗收文檔更新**
2. **執行第一輪 TDD 重構循環**
3. **驗證使用者體驗保持標準**

### 風險緩解措施
- **備份策略**: 所有變更前建立完整備份
- **分階段執行**: 逐步遷移，每階段驗證完整性
- **回滾機制**: 準備快速回滾到穩定版本的方案

---

## 📝 結論

UC-02 日常書籍資料提取功能需要進行**全面的 ErrorCodes 系統遷移**，但這是一個**高收益的重構項目**：

### 主要效益
- **簡化錯誤處理**: 從複雜的 StandardError 轉向簡潔的原生 Error
- **效能提升**: 錯誤建立時間和記憶體使用顯著改善  
- **開發體驗**: 降低學習成本，提高開發效率
- **維護性**: 減少錯誤處理相關的技術債務

### 執行信心
**High (85%)** - 有清晰的遷移路徑、完整的測試策略，以及 TDD 方法學支持。

**✅ 建議立即啟動 TDD Phase 2 (測試設計階段)**

---

**Document Version**: v0.12.9  
**Next Review**: 遷移完成後  
**Stakeholders**: sage-test-architect, thyme-extension-engineer, rosemary-project-manager