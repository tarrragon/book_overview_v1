# v0.6.21 工作日誌 — 錯誤處理架構重構文件先行階段完成（TDD 循環）

## 背景與目標

- 基於 v0.6.15-v0.6.20 期間技術債務分析，啟動錯誤處理架構重構專案
- 嚴格遵循 CLAUDE.md 新增的「文件先行策略」，完成架構設計和技術規範撰寫
- 解決 HandlerRegistry 與 ErrorHandler 循環依賴問題，消除 OOM 和無限循環風險

## 負責功能

- 更新 CLAUDE.md 敏捷開發機制，新增文件先行策略（Document-First Strategy）
- 建立錯誤處理架構重構的完整設計文件體系
- 定義 ErrorCoordinator 和雙通道事件系統的詳細技術規範
- 制定三階段執行計劃和全面風險評估

## 設計考量

- **敏捷開發機制強化**：
  - 文件先行策略：任何架構變更前必須先撰寫完整設計文件
  - 最小分派最快交付：將大型重構分解成可驗證的小型階段
  - 高頻工作日誌更新：作為站立會議的替代機制
  - 協作標註與重構循環：確保文件與實作同步更新
- **架構債務零容忍**：
  - 根本問題解決：不接受臨時修復（如重入保護），要求架構層面的徹底解決
  - 循環依賴消除：ErrorHandler 透過獨立的 ErrorCoordinator 管理，不再依賴 HandlerRegistry
  - 事件通道分離：建立 BusinessEventBus 和 SystemEventBus 雙通道架構

## 處理流程（文件先行階段）

1. **CLAUDE.md 規範更新**：
   - 新增「文件先行策略」章節，明確要求設計文件優先、API 接口定義、架構決策記錄（ADR）
   - 強化敏捷開發機制，包含最小分派最快交付、高頻工作日誌更新等策略
   - 嚴禁在沒有設計文件情況下開始編碼

2. **架構設計文件撰寫**：
   - 完成 `docs/architecture/error-handling-refactoring-design.md`
   - 包含問題分析、架構設計、核心組件設計、錯誤分類策略、遷移策略等
   - 定義清楚的成功指標和風險評估

3. **技術規範文件撰寫**：
   - 完成 `docs/architecture/error-coordinator-specification.md`
   - 詳細定義 ErrorCoordinator 類別接口、雙通道事件系統實作規範
   - 包含效能考量、監控診斷、實作指導原則等

4. **執行計劃文件撰寫**：
   - 完成 `docs/architecture/refactoring-execution-plan.md`
   - 三階段執行計劃：建立新架構→逐步遷移→清理優化
   - 全面風險評估和緩解策略、監控回滾機制、執行檢查清單

## 使用情境

- **開發團隊**：依據設計文件和技術規範進行實作，確保架構一致性
- **品質保證**：依據執行計劃進行驗證和測試，確保重構品質
- **專案管理**：依據風險評估和監控指標進行專案追蹤和決策支援
- **未來維護**：設計文件作為架構理解和後續變更的權威參考

## 變更摘要

- 檔案：
  - 更新 `CLAUDE.md`
    - 新增「文件先行策略」章節
    - 強化「敏捷開發機制作業規範」
    - 更新標準工作執行流程，新增「文件撰寫階段」
  - 新增 `docs/architecture/error-handling-refactoring-design.md`
    - 完整的架構重構設計文件（4500+ 字）
    - 包含問題分析、新架構設計、核心組件設計等
  - 新增 `docs/architecture/error-coordinator-specification.md`
    - 詳細技術規範文件（6000+ 字）
    - 包含 ErrorCoordinator 和雙通道事件系統完整規範
  - 新增 `docs/architecture/refactoring-execution-plan.md`
    - 執行計劃和風險評估文件（5000+ 字）
    - 三階段計劃、風險緩解、監控回滾機制

## 文件品質驗證

- **完整性**：涵蓋架構設計、技術規範、執行計劃三大面向
- **可行性**：基於現有架構問題分析，提出可實作的解決方案
- **一致性**：所有文件間保持架構決策和技術選擇的一致性
- **可追蹤性**：每個設計決策都有明確的問題背景和理由說明

## 架構決策記錄（ADR）

### ADR-001: 採用雙通道事件系統

**決策**：建立 BusinessEventBus 和 SystemEventBus 分離業務事件和系統事件
**理由**：現有單一 EventBus 造成業務邏輯和錯誤處理混合，導致循環依賴
**替代方案**：改進現有 EventBus 添加事件類型過濾
**風險**：增加系統複雜度，可能有輕微效能開銷
**決策日期**：2025-08-10

### ADR-002: ErrorHandler 獨立於 HandlerRegistry

**決策**：ErrorHandler 透過 ErrorCoordinator 管理，不再透過 HandlerRegistry 註冊
**理由**：消除 ErrorHandler 和 HandlerRegistry 的循環依賴，避免無限遞迴
**替代方案**：在 HandlerRegistry 中添加更複雜的重入保護
**風險**：需要重構現有錯誤處理邏輯
**決策日期**：2025-08-10

### ADR-003: 三階段漸進式遷移

**決策**：採用建立新架構→逐步遷移→清理優化的三階段方式
**理由**：降低重構風險，確保每階段都可驗證和回滾
**替代方案**：一次性全面重寫錯誤處理系統
**風險**：遷移時間較長，可能需要維護臨時相容程式碼
**決策日期**：2025-08-10

## 問題發現與根因分析

- **問題**：v0.6.15-v0.6.20 期間連續遇到 OOM、RangeError、測試不穩定問題
- **表面症狀**：錯誤處理測試需要跳過、記憶體溢出、無限循環
- **根本原因**：
  - ErrorHandler 透過 HandlerRegistry 註冊造成循環依賴
  - 錯誤處理失敗時會再次觸發錯誤處理機制
  - 業務事件和系統事件使用同一通道，無法有效隔離
- **當前臨時解法**：重入保護機制（`_processingError` 旗標）
- **問題評估**：治標不治本，違反 CLAUDE.md 架構債務零容忍原則

## 驗證與影響範圍

- **文件品質驗證**：所有文件經過完整性、可行性、一致性檢查
- **架構決策驗證**：每個關鍵決策都有明確的問題背景和替代方案比較
- **風險評估完整性**：識別高、中、低三個等級的風險項目，並制定對應緩解策略
- **影響範圍**：主要影響錯誤處理相關組件，對業務邏輯影響最小

## 後續工作規劃

- **立即執行**（階段一）：建立新架構，不破壞現有功能
- **短期目標**（階段二）：逐步遷移現有錯誤處理到新架構
- **中期目標**（階段三）：清理舊架構，恢復所有錯誤處理測試

## 品質保證措施

- **文件先行策略確保**：所有實作都有對應的設計文件和技術規範
- **三階段驗證機制**：每階段都有明確的驗證標準和回滾計劃
- **監控告警機制**：實時監控系統健康指標，自動觸發回滾條件
- **100% 測試覆蓋**：要求新架構達到完整測試覆蓋率

## 風險控制措施

- **技術風險**：充分的文件設計和原型驗證
- **時程風險**：預留 20% 緩衝時間，分階段可停止執行
- **品質風險**：每階段完整驗證，嚴格的回滾條件
- **協作風險**：詳細的技術文件和使用指南

---

## 版本標記

- 小版本：v0.6.21（文件先行階段完成）
- 變更類型：Architecture/Planning（架構規劃和文件建立）
- 下一步：開始階段一實作（建立新架構基礎）
