# v0.8.6 工作日誌 — Listener Guard 與 Overview 同步

## 目標與背景
- 目標：確保 `EXTRACTION.COMPLETED` 在任何時序下都有監聽器，避免 handlersExecuted: 0 導致資料未入庫；完成 Overview 透過 `chrome.storage.onChanged` 的自動同步。
- 背景：實機觀察到事件轉發成功但 `hasListener:false`、`handlersExecuted:0`，Overview 初載為 0 筆。

## 問題發現與根因
- 症狀：`EXTRACTION.COMPLETED` emit 時無監聽器；Overview 未自動更新。
- 根因：
  1) 冷啟動/邊界時序下監聽器未就緒。
  2) Overview 缺少 `chrome.storage.onChanged` 監聽。

## 解決方案
- Listener Guard：
  - 新增 `registerCoreListenersIfNeeded()` 可重入守護，確保 `EXTRACTION.COMPLETED` 監聽存在。
  - 在背景初始化完成時與 `CONTENT.EVENT.FORWARD(EXTRACTION.COMPLETED)` 路徑前呼叫。
- Overview 同步：
  - 於 `overview-page-controller.js` 初始化註冊 `chrome.storage.onChanged`，監聽 `readmoo_books` 更新即時刷新 UI。

## 處理流程
1. Background 初始化 → 呼叫 `registerCoreListenersIfNeeded()` 確認監聽器。
2. Content Script 轉發 `EXTRACTION.COMPLETED` → emit 前再次呼叫守護補註冊。
3. Background 寫入 `chrome.storage.local.readmoo_books`。
4. Overview 監聽 storage 變更，自動載入並更新畫面。

## 變更內容
- 程式碼：
  - `src/background/background.js`：新增 Listener Guard；在轉發 `EXTRACTION.COMPLETED` 前補註冊。
  - `src/overview/overview-page-controller.js`：加入 `chrome.storage.onChanged` 監聽（前版已加）。
- 文件：
  - `docs/architecture/event-system.md`：新增「關鍵監聽器守護（Listener Guard）」章節。
  - `docs/todolist.md`：狀態更新至 v0.8.6。
  - `CHANGELOG.md`：新增 v0.8.6 條目。

## 測試
- 整合測試：全部通過（108/108）。
- 實機驗證：Overview 正確顯示 96 筆。

## 架構影響
- 正向：杜絕關鍵監聽缺失、確保資料入庫與 UI 自動更新。
- 風險：守護重入成本極小；已以 `hasListener()` 防止重複註冊。

## 後續工作（v0.8.7 提案）
- EventBus `getStats()` 文件化/測試。
- 事件優先級策略與壅塞控制（可選）。
