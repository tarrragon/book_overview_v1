# v0.12.7 測試品質審查清單

**版本**: v0.12.7  
**建立日期**: 2025-09-13  
**目的**: 確保每個測試都經過系統性的品質審查，防止測試驗證邏輯被不當放寬

## 📋 總體進度概覽

### 🎯 檢查範圍統計
- **總測試檔案數**: 153 個 ✅
  - 單元測試: 117 個
  - 整合測試: 26 個
  - 端對端測試: 10 個
- **已審查檔案數**: 1 (error-recovery-workflow.test.js)
- **發現問題檔案數**: 1
- **修復完成檔案數**: 1
- **審查完成率**: 0.65% (1/153)

### 📊 問題分類統計
- **A類 (合理調整)**: 待統計
- **B類 (可疑調整)**: 1 (已修復)
- **C類 (錯誤調整)**: 待統計

---

## 📁 測試檔案審查清單

### 🔍 審查狀態圖例
- ✅ **已審查且無問題** - 測試驗證邏輯正確
- ⚠️ **已審查但有輕微問題** - 需要關注但不影響核心功能
- 🔴 **已審查且有重大問題** - 需要立即修復
- ✅🔧 **已審查且已修復** - 問題已解決
- ⭕ **待審查** - 尚未檢查
- 🚫 **跳過審查** - 檔案不在審查範圍內（如已知穩定的檔案）

---

## 🧪 單元測試 (Unit Tests)

### 📂 src/core/errors/
- [ ] ⭕ `standard-error.test.js`
  - **重點檢查**: StandardError 規範化調整是否合理
  - **預期問題**: 字串錯誤比較 → toMatchObject() 轉換
  - **審查者**: 待分配
  - **審查日期**: 待安排

### 📂 src/background/domains/data-management/services/
- [ ] ⭕ `RetryCoordinator.test.js`
  - **重點檢查**: 重試邏輯驗證的精確性
  - **參考標準**: 此檔案作為正確 retryCount 驗證的標準
  - **審查者**: 待分配
  - **審查日期**: 待安排

- [ ] ⭕ `SynchronizationOrchestrator.test.js`
  - **重點檢查**: 同步計數和重試邏輯
  - **預期問題**: retryCount 相關驗證
  - **審查者**: 待分配
  - **審查日期**: 待安排

### 📂 src/unit/data-management/
- [ ] ⭕ `SchemaMigrationService.test.js`
  - **重點檢查**: 已知修復的字串錯誤比較
  - **修復記錄**: v0.12.6 中已將 toThrow('string') 改為 toThrowError(objectContaining)
  - **審查狀態**: 需要確認修復是否正確
  - **審查者**: 待分配
  - **審查日期**: 待安排

### 📂 src/unit/popup/
- [ ] ⭕ `popup-controller-event-system-refactor.test.js`
  - **重點檢查**: retryCount 期望值使用
  - **可疑點**: `retryCount: expect.any(Number)` - 可能過於寬鬆
  - **審查者**: 待分配
  - **審查日期**: 待安排

- [ ] ⭕ `popup-controller-extraction-integration.test.js`
  - **重點檢查**: `expect(extractionService.retryCount).toBe(2)` 的正確性
  - **對比**: 與 error-recovery-workflow 的差異
  - **審查者**: 待分配
  - **審查日期**: 待安排

- [ ] ⭕ `popup-extraction-service.test.js`
  - **重點檢查**: 重試計數驗證
  - **審查者**: 待分配
  - **審查日期**: 待安排

### 📂 src/unit/content-scripts/
- [ ] ⭕ `extractors.test.js`
  - **重點檢查**: 提取數量和計數相關的期望值調整
  - **審查者**: 待分配
  - **審查日期**: 待安排

### 📂 src/unit/core/
- [ ] ⭕ `chrome-event-bridge.test.js`
  - **重點檢查**: 已知的錯誤代碼調整 (TEST_ERROR → UNKNOWN_ERROR)
  - **修復記錄**: v0.12.6 commit 7a90ed4 修復
  - **審查狀態**: 需要確認調整是否合理
  - **審查者**: 待分配
  - **審查日期**: 待安排

---

## 🔗 整合測試 (Integration Tests)

### 📂 tests/integration/workflows/
- [x] ✅🔧 `error-recovery-workflow.test.js`
  - **審查完成**: 2025-09-13
  - **發現問題**: retryCount 驗證被不當移除
  - **修復狀態**: ✅ 已修復
  - **修復方法**: 建立強健且精確的替代驗證邏輯
  - **審查者**: Claude Code
  - **測試狀態**: ✅ 通過 (含品質監控警告)

- [ ] ⭕ `cross-device-sync-workflow.test.js`
  - **重點檢查**: 同步數量和處理計數的期望值
  - **預期問題**: processedCount 可能被改為範圍檢查
  - **審查者**: 待分配
  - **審查日期**: 待安排

### 📂 tests/integration/
- [ ] ⭕ `popup-background-integration.test.js`
  - **重點檢查**: 書籍數量計算相關的驗證
  - **修復記錄**: v0.12.6 commit 45e9f00 有重大修復
  - **重點審查**: `expect(bookCount).toBe(initialCount + 30)` 類型的精確驗證
  - **審查者**: 待分配
  - **審查日期**: 待安排

- [ ] ⭕ `readmoo-migration-integration.test.js`
  - **重點檢查**: 遷移數量和狀態驗證
  - **修復記錄**: 在多個 commit 中被修改
  - **審查者**: 待分配
  - **審查日期**: 待安排

### 📂 tests/integration/error-handling/
- [ ] ⭕ `basic-integration.test.js`
  - **重點檢查**: retryCount 和錯誤恢復相關驗證
  - **審查者**: 待分配
  - **審查日期**: 待安排

### 📂 tests/integration/chrome-apis/
- [ ] ⭕ `runtime-messaging-integration.test.js`
  - **重點檢查**: messageResult.retryCount 相關驗證
  - **可疑點**: `expect(result.retryCount).toBeGreaterThan(0)` 可能過於寬鬆
  - **審查者**: 待分配
  - **審查日期**: 待安排

---

## 🌐 端對端測試 (E2E Tests)

### 📂 tests/e2e/workflows/
- [ ] ⭕ `cross-device-sync.test.js`
  - **重點檢查**: 跨設備同步的數量驗證
  - **修復記錄**: commit 45e9f00 中有修改
  - **審查者**: 待分配
  - **審查日期**: 待安排

---

## 📋 審查檢查項目清單

### 🔍 每個測試檔案必須檢查的項目

#### 1. **數值期望值檢查**
- [ ] 是否有 `toBe(具體數字)` 被改為 `toBeGreaterThan(較小數字)`？
- [ ] 是否有精確計數被改為範圍檢查？
- [ ] 數值調整是否有合理的業務邏輯支撐？

#### 2. **重試邏輯檢查**
- [ ] 是否有 `retryCount` 相關的驗證？
- [ ] 重試驗證是否被移除或放寬？
- [ ] 重試策略配置是否被正確驗證？

#### 3. **錯誤處理檢查**
- [ ] 是否有 `toThrow('字串')` 被改為其他格式？
- [ ] 錯誤代碼期望值是否被調整？
- [ ] StandardError 使用是否符合規範？

#### 4. **狀態驗證檢查**
- [ ] 是否有詳細的狀態檢查被移除？
- [ ] 成功/失敗條件是否被簡化？
- [ ] 中間狀態的驗證是否被跳過？

#### 5. **時序相關檢查**
- [ ] 是否有時間延遲的驗證被移除？
- [ ] 順序相關的檢查是否被放寬？
- [ ] 事件時序驗證是否完整？

### 📊 問題分類標準

#### A類 - 合理調整 ✅
- 符合業務邏輯需求的調整
- 環境適配的必要調整
- 規範化修正（如 StandardError 統一）

#### B類 - 可疑調整 ⚠️
- 數值精確度降低
- 驗證條件簡化
- 需要進一步分析的調整

#### C類 - 錯誤調整 🔴
- 關鍵業務邏輯驗證被移除
- 重要品質把關被繞過
- 安全或完整性檢查被削弱

---

## 🎯 審查執行計畫

### Phase 1: 高風險檔案優先審查
**目標**: 先處理已知有問題或高風險的檔案
**期限**: 2025-09-13 - 2025-09-14

**優先檔案清單**:
1. `runtime-messaging-integration.test.js` - retryCount 相關
2. `popup-background-integration.test.js` - 書籍數量計算
3. `cross-device-sync-workflow.test.js` - 同步數量驗證
4. `chrome-event-bridge.test.js` - 錯誤代碼調整

### Phase 2: 系統性全面審查
**目標**: 完成所有測試檔案的品質審查
**期限**: 2025-09-14 - 2025-09-16

### Phase 3: 修復實施
**目標**: 修復發現的問題並驗證修復效果
**期限**: 2025-09-16 - 2025-09-18

---

## 📈 進度追蹤

### 日進度更新
**2025-09-13**:
- ✅ 建立審查清單框架
- ✅ 完成 error-recovery-workflow.test.js 審查和修復
- ✅ 建立修復方法論和模式

**待更新**:
- [ ] Phase 1 高風險檔案審查完成
- [ ] 發現問題統計和分類
- [ ] 修復進度和效果驗證

---

## 🔧 自動化支援工具

### 檢查腳本建議
```bash
# 建立自動化檢查腳本
./scripts/test-quality-audit.sh

# 功能包括：
# 1. 掃描所有測試檔案
# 2. 識別可疑的期望值模式
# 3. 產生審查報告
# 4. 追蹤審查進度
```

### Git 分析支援
```bash
# 分析測試檔案變更歷程
git log --oneline --stat v0.12.4..v0.12.6 -- "**/*.test.js"

# 檢查數值期望值變更
git diff v0.12.4 v0.12.6 -- "**/*.test.js" | grep -E "expect.*[0-9]"
```

---

**建立者**: Claude Code  
**審查者**: 待分配  
**最後更新**: 2025-09-13 11:30  
**下次更新**: 2025-09-14 09:00