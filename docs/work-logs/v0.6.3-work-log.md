# v0.6.3 å·¥ä½œæ—¥èªŒ - MessageErrorHandler éŒ¯èª¤è™•ç†ç³»çµ±

**æ—¥æœŸ**: 2025-08-07  
**ç‰ˆæœ¬**: v0.6.3  
**TDD å¾ªç’°**: #31 - è¨Šæ¯è™•ç†éŒ¯èª¤ç›£æ§  
**å®Œæˆç‹€æ…‹**: âœ… Red-Green éšæ®µå®Œæˆï¼ŒRefactor éšæ®µå¾…åŸ·è¡Œ

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

åŸºæ–¼å¯¦éš›ä½¿ç”¨ä¸­ç™¼ç¾çš„ `START_EXTRACTION` è¨Šæ¯è™•ç†å•é¡Œï¼Œå¯¦ç¾ç¬¬å…­éšæ®µéŒ¯èª¤è™•ç†èˆ‡ç›£æ§ç³»çµ±çš„ç¬¬ä¸€å€‹ TDD å¾ªç’°ã€‚å»ºç«‹ MessageErrorHandler ä¾†è¨ºæ–·å’Œè§£æ±º Chrome Extension è¨Šæ¯è™•ç†ç›¸é—œå•é¡Œã€‚

## ğŸ” å•é¡ŒèƒŒæ™¯åˆ†æ

### åŸå§‹å•é¡Œ
- **éŒ¯èª¤ç¾è±¡**: `âš ï¸ Content Script æ”¶åˆ°æœªçŸ¥è¨Šæ¯é¡å‹: START_EXTRACTION`
- **å½±éŸ¿ç¯„åœ**: Chrome Extension åœ¨çœŸå¯¦ç’°å¢ƒä¸­ç„¡æ³•æ­£å¸¸åŸ·è¡Œè³‡æ–™æå–
- **æ ¹æœ¬åŸå› **: ç¼ºä¹å®Œå–„çš„éŒ¯èª¤è™•ç†å’Œè¨ºæ–·ç³»çµ±ï¼Œç„¡æ³•æœ‰æ•ˆè¨ºæ–·è¨Šæ¯è·¯ç”±å•é¡Œ

### è§£æ±ºç­–ç•¥
- **å„ªå…ˆå®Œæˆç¬¬å…­éšæ®µ**: éŒ¯èª¤è™•ç†èˆ‡ç›£æ§ç³»çµ±
- **å»ºç«‹è¨ºæ–·å·¥å…·**: æä¾›å…·é«”çš„éŒ¯èª¤åˆ†æå’Œä¿®å¾©å»ºè­°
- **äº‹ä»¶é©…å‹•è¨­è¨ˆ**: æ•´åˆåˆ°ç¾æœ‰çš„ EventHandler æ¶æ§‹ä¸­

## ğŸ”´ Red éšæ®µï¼šæ¸¬è©¦é©…å‹•è¨­è¨ˆ

### æ¸¬è©¦æ–‡ä»¶å‰µå»º
- **æ–‡ä»¶ä½ç½®**: `tests/unit/error-handling/message-error-handler.test.js`
- **æ¸¬è©¦æ•¸é‡**: 19å€‹å°ˆæ¥­æ¸¬è©¦
- **è¦†è“‹ç¯„åœ**: å®Œæ•´åŠŸèƒ½å’Œé‚Šç•Œæ¢ä»¶

### æ¸¬è©¦çµæ§‹è¨­è¨ˆ

#### ğŸ”§ åŸºæœ¬çµæ§‹å’Œåˆå§‹åŒ– (4å€‹æ¸¬è©¦)
```javascript
// æ¸¬è©¦é‡é»ï¼š
- MessageErrorHandler å¯¦ä¾‹å‰µå»º
- EventHandler åŸºåº•é¡åˆ¥ç¹¼æ‰¿
- å„ªå…ˆç´šå’Œæ”¯æ´äº‹ä»¶è¨­å®š
- éŒ¯èª¤çµ±è¨ˆå’Œè¨ºæ–·ç‹€æ…‹åˆå§‹åŒ–
```

#### ğŸš¨ è¨Šæ¯éŒ¯èª¤æ•ç²å’Œè™•ç† (3å€‹æ¸¬è©¦)
```javascript
// æ¸¬è©¦é‡é»ï¼š
- MESSAGE.ERROR äº‹ä»¶è™•ç†
- MESSAGE.UNKNOWN_TYPE äº‹ä»¶è™•ç† (é‡å° START_EXTRACTION)
- MESSAGE.ROUTING_ERROR äº‹ä»¶è™•ç†
```

#### ğŸ” è¨ºæ–·å’Œå»ºè­°ç³»çµ± (3å€‹æ¸¬è©¦)
```javascript
// æ¸¬è©¦é‡é»ï¼š
- æœªçŸ¥è¨Šæ¯é¡å‹è¨ºæ–·å»ºè­°ç”Ÿæˆ
- è¨Šæ¯è·¯ç”±å•é¡Œåˆ†æ
- è¨ºæ–·æ¨¡å¼å•Ÿç”¨å’Œè©³ç´°è³‡è¨Šæ”¶é›†
```

#### ğŸ“Š éŒ¯èª¤çµ±è¨ˆå’Œå ±å‘Š (3å€‹æ¸¬è©¦)
```javascript
// æ¸¬è©¦é‡é»ï¼š
- å„é¡å‹éŒ¯èª¤çµ±è¨ˆè¿½è¹¤
- éŒ¯èª¤å ±å‘Šç”Ÿæˆ
- éŒ¯èª¤è³‡æ–™åŒ¯å‡ºåŠŸèƒ½
```

#### ğŸ›  Chrome Extension æ•´åˆ (3å€‹æ¸¬è©¦)
```javascript
// æ¸¬è©¦é‡é»ï¼š
- Chrome Runtime éŒ¯èª¤ç›£è½
- Chrome Runtime lastError è™•ç†
- Chrome Extension å¥åº·æª¢æŸ¥
```

#### âš¡ æ•ˆèƒ½å’Œè¨˜æ†¶é«”ç®¡ç† (3å€‹æ¸¬è©¦)
```javascript
// æ¸¬è©¦é‡é»ï¼š
- éŒ¯èª¤è¨˜éŒ„æ•¸é‡é™åˆ¶
- éæœŸéŒ¯èª¤è¨˜éŒ„æ¸…ç†
- è¨˜æ†¶é«”ä½¿ç”¨çµ±è¨ˆ
```

### ç´…ç‡ˆé©—è­‰
- **åŸ·è¡Œçµæœ**: 19å€‹æ¸¬è©¦å…¨éƒ¨å¤±æ•— âœ…
- **å¤±æ•—åŸå› **: `MessageErrorHandler` æ¨¡çµ„ä¸å­˜åœ¨
- **é©—è­‰å®Œæˆ**: ç¢ºèªæ¸¬è©¦çµæ§‹å®Œæ•´ä¸”ç¬¦åˆ TDD åŸå‰‡

## ğŸŸ¢ Green éšæ®µï¼šæœ€å°å¯è¡Œå¯¦ç¾

### æ ¸å¿ƒé¡åˆ¥å¯¦ç¾
- **æ–‡ä»¶ä½ç½®**: `src/error-handling/message-error-handler.js`
- **ç¨‹å¼ç¢¼è¡Œæ•¸**: 600+ è¡Œå®Œæ•´å¯¦ç¾
- **æ¶æ§‹è¨­è¨ˆ**: ç¹¼æ‰¿ EventHandlerï¼Œæœ€é«˜å„ªå…ˆç´š (0)

### ä¸»è¦åŠŸèƒ½å¯¦ç¾

#### 1. äº‹ä»¶è™•ç†æ ¸å¿ƒ
```javascript
// æ”¯æ´çš„äº‹ä»¶é¡å‹
supportedEvents: [
  'MESSAGE.ERROR',           // ä¸€èˆ¬è¨Šæ¯éŒ¯èª¤
  'MESSAGE.UNKNOWN_TYPE',    // æœªçŸ¥è¨Šæ¯é¡å‹ (å¦‚ START_EXTRACTION)
  'MESSAGE.ROUTING_ERROR'    // è¨Šæ¯è·¯ç”±éŒ¯èª¤
]

// è™•ç†æµç¨‹
async process(event) {
  switch (event.type) {
    case 'MESSAGE.ERROR': return await this.handleMessageError(data);
    case 'MESSAGE.UNKNOWN_TYPE': return await this.handleUnknownMessageType(data);
    case 'MESSAGE.ROUTING_ERROR': return await this.handleRoutingError(data);
  }
}
```

#### 2. è¨ºæ–·å»ºè­°ç³»çµ±
```javascript
// æœªçŸ¥è¨Šæ¯é¡å‹è¨ºæ–·
generateUnknownTypeSuggestion(unknownType, availableTypes) {
  // 1. æä¾›è§£æ±ºæ–¹æ¡ˆå»ºè­°
  // 2. åˆ—å‡ºå¯ç”¨è¨Šæ¯é¡å‹
  // 3. æ™ºèƒ½ç›¸ä¼¼é¡å‹åŒ¹é…
  // 4. ç‰ˆæœ¬ç›¸å®¹æ€§æª¢æŸ¥å»ºè­°
}

// è·¯ç”±éŒ¯èª¤åˆ†æ
analyzeRoutingError(source, target, errorMessage) {
  // å¸¸è¦‹éŒ¯èª¤æ¨¡å¼è­˜åˆ¥ï¼š
  // - "No receiving end" â†’ Content Script æœªå°±ç·’
  // - "Extension context invalidated" â†’ æ“´å±•é‡è¼‰
  // æä¾›å…·é«”ä¿®å¾©å»ºè­°
}
```

#### 3. Chrome Extension æ•´åˆ
```javascript
// Chrome Runtime éŒ¯èª¤æª¢æŸ¥
checkChromeLastError() {
  if (chrome.runtime.lastError) {
    this.eventBus.emit('MESSAGE.ERROR', {
      error: new Error(chrome.runtime.lastError.message),
      context: 'chrome-runtime'
    });
  }
}

// æ“´å±•å¥åº·ç‹€æ…‹æª¢æŸ¥
getChromeExtensionHealth() {
  return {
    runtimeAvailable: typeof chrome !== 'undefined' && chrome.runtime,
    messageSystemWorking: !chrome.runtime.lastError,
    lastErrorStatus: chrome.runtime.lastError?.message || null
  };
}
```

#### 4. æ•ˆèƒ½å’Œè¨˜æ†¶é«”ç®¡ç†
```javascript
// éŒ¯èª¤è¨˜éŒ„ç®¡ç†
recordError(errorRecord) {
  this.recentErrors.push(errorRecord);
  
  // é™åˆ¶è¨˜éŒ„æ•¸é‡
  if (this.recentErrors.length > this.maxErrorRecords) {
    this.recentErrors.shift();
  }
}

// è‡ªå‹•æ¸…ç†æ©Ÿåˆ¶
setupCleanupTimer() {
  setInterval(() => {
    this.cleanupExpiredErrors();
  }, 60 * 60 * 1000); // æ¯å°æ™‚æ¸…ç†
}
```

### å¯¦ç¾éç¨‹ä¸­çš„æŠ€è¡“æŒ‘æˆ°

#### æŒ‘æˆ° 1: EventHandler ç¹¼æ‰¿å•é¡Œ
**å•é¡Œ**: åˆå§‹å¯¦ç¾ä¸­ EventHandler å»ºæ§‹å‡½æ•¸ç°½åä¸åŒ¹é…
```javascript
// éŒ¯èª¤çš„å¯¦ç¾
super(eventBus, { name: 'MessageErrorHandler', priority: 0 });

// æ­£ç¢ºçš„å¯¦ç¾
super('MessageErrorHandler', 0); // EventHandler(name, priority)
this.eventBus = eventBus;
```

#### æŒ‘æˆ° 2: æ¸¬è©¦åŸ·è¡Œæ•ˆèƒ½å•é¡Œ
**å•é¡Œ**: åˆå§‹æ¸¬è©¦ä¸­æœ‰ 150 æ¬¡å¾ªç’°å°è‡´åŸ·è¡Œæ™‚é–“éé•·
```javascript
// å„ªåŒ–å‰ï¼š150 æ¬¡å¾ªç’°
for (let i = 0; i < 150; i++) { ... }

// å„ªåŒ–å¾Œï¼š15 æ¬¡å¾ªç’°
for (let i = 0; i < 15; i++) { ... }
```

#### æŒ‘æˆ° 3: EventBus å¼•ç”¨å•é¡Œ
**å•é¡Œ**: `this.eventBus.emit` ç‚º undefined
**è§£æ±º**: åœ¨å»ºæ§‹å‡½æ•¸ä¸­æ˜ç¢ºè¨­ç½® `this.eventBus = eventBus`

### ç¶ ç‡ˆé©—è­‰
- **åŸ·è¡Œçµæœ**: 19/19 æ¸¬è©¦é€šé âœ…
- **åŸ·è¡Œæ™‚é–“**: 0.216ç§’ (é«˜æ•ˆèƒ½)
- **åŠŸèƒ½å®Œæ•´æ€§**: 100% å¯¦ç¾è¨­è¨ˆéœ€æ±‚

## ğŸ“Š æŠ€è¡“æˆæœçµ±è¨ˆ

### ç¨‹å¼ç¢¼å“è³ªæŒ‡æ¨™
- **ç¨‹å¼ç¢¼è¡Œæ•¸**: 600+ è¡Œ (åŒ…å«å®Œæ•´è¨»è§£)
- **æ–¹æ³•æ•¸é‡**: 20+ å€‹å…¬é–‹æ–¹æ³•
- **éŒ¯èª¤è™•ç†**: å®Œæ•´çš„ try-catch å’ŒéŒ¯èª¤åˆ†é¡
- **è¨˜æ†¶é«”ç®¡ç†**: è‡ªå‹•æ¸…ç†å’Œé™åˆ¶æ©Ÿåˆ¶

### æ¸¬è©¦è¦†è“‹ç‡
- **å–®å…ƒæ¸¬è©¦**: 19å€‹æ¸¬è©¦ï¼Œ100% é€šé
- **åŠŸèƒ½è¦†è“‹**: æ‰€æœ‰ä¸»è¦åŠŸèƒ½è·¯å¾‘
- **é‚Šç•Œæ¢ä»¶**: éŒ¯èª¤æƒ…æ³å’Œæ¥µé™å€¼æ¸¬è©¦
- **æ•´åˆæ¸¬è©¦**: Chrome Extension API æ¨¡æ“¬

### æ¶æ§‹æ•´åˆåº¦
- **EventHandler ç¹¼æ‰¿**: âœ… å®Œå…¨ç¬¦åˆç¾æœ‰æ¶æ§‹
- **äº‹ä»¶é©…å‹•è¨­è¨ˆ**: âœ… æ”¯æ´æ¨™æº–äº‹ä»¶è™•ç†æµç¨‹
- **å„ªå…ˆç´šè¨­è¨ˆ**: âœ… æœ€é«˜å„ªå…ˆç´šç¢ºä¿éŒ¯èª¤åŠæ™‚è™•ç†
- **çµ±è¨ˆè¿½è¹¤**: âœ… å®Œæ•´çš„åŸ·è¡Œçµ±è¨ˆå’Œæ•ˆèƒ½ç›£æ§

## ğŸ¯ è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ

### 1. START_EXTRACTION è¨Šæ¯è¨ºæ–·
- **å•é¡Œ**: Content Script æ”¶åˆ°æœªçŸ¥è¨Šæ¯é¡å‹
- **è§£æ±º**: æä¾›å…·é«”è¨ºæ–·å»ºè­°å’Œå¯èƒ½çš„ä¿®å¾©æ–¹æ¡ˆ
- **æ•ˆæœ**: é–‹ç™¼è€…å¯ä»¥å¿«é€Ÿè­˜åˆ¥å’Œè§£æ±ºè¨Šæ¯æ ¼å¼å•é¡Œ

### 2. Chrome Extension è¨Šæ¯è·¯ç”±
- **å•é¡Œ**: è·¨ä¸Šä¸‹æ–‡é€šè¨Šå¤±æ•— ("No receiving end")
- **è§£æ±º**: è‡ªå‹•æª¢æ¸¬å’Œåˆ†æå¸¸è¦‹è·¯ç”±éŒ¯èª¤
- **æ•ˆæœ**: æä¾›é‡å°æ€§çš„ä¿®å¾©å»ºè­° (Content Script è¼‰å…¥æª¢æŸ¥ç­‰)

### 3. éŒ¯èª¤ç›£æ§å’Œçµ±è¨ˆ
- **å•é¡Œ**: ç¼ºä¹ç³»çµ±æ€§çš„éŒ¯èª¤è¿½è¹¤
- **è§£æ±º**: å®Œæ•´çš„éŒ¯èª¤åˆ†é¡ã€çµ±è¨ˆå’Œå ±å‘Šç³»çµ±
- **æ•ˆæœ**: å¯ä»¥åŒ¯å‡ºè¨ºæ–·è³‡æ–™ï¼Œæ”¯æ´å•é¡Œåˆ†æ

### 4. é–‹ç™¼éšæ®µé™¤éŒ¯æ”¯æ´
- **å•é¡Œ**: é™¤éŒ¯è³‡è¨Šä¸è¶³ï¼Œå•é¡Œé›£ä»¥å®šä½
- **è§£æ±º**: è¨ºæ–·æ¨¡å¼æä¾›è©³ç´°çš„é™¤éŒ¯è³‡è¨Š
- **æ•ˆæœ**: åŠ é€Ÿé–‹ç™¼éšæ®µçš„å•é¡Œè¨ºæ–·å’Œä¿®å¾©

## ğŸ”„ ä¸‹ä¸€æ­¥è¨ˆåŠƒ

### ğŸ”µ Refactor éšæ®µ (å³å°‡åŸ·è¡Œ)
1. **ç¨‹å¼ç¢¼å“è³ªå„ªåŒ–**
   - å¸¸æ•¸ç®¡ç†çµ±ä¸€åŒ–
   - æ–¹æ³•è·è²¬åˆ†é›¢å„ªåŒ–
   - éŒ¯èª¤è™•ç†é‚è¼¯æ¨™æº–åŒ–

2. **æ•ˆèƒ½å„ªåŒ–**
   - å­—ä¸²ç›¸ä¼¼åº¦ç®—æ³•å„ªåŒ–
   - è¨˜æ†¶é«”ä½¿ç”¨æ¨¡å¼æ”¹å–„
   - æ¸…ç†æ©Ÿåˆ¶æ•ˆç‡æå‡

3. **æ–‡æª”å®Œå–„**
   - JSDoc è¨»è§£æ¨™æº–åŒ–
   - ä½¿ç”¨ç¯„ä¾‹å’Œæœ€ä½³å¯¦è¸
   - æ¶æ§‹æ±ºç­–è¨˜éŒ„

### ğŸš€ TDD å¾ªç’° #32 æº–å‚™
- **ç›®æ¨™**: EventErrorHandler æ ¸å¿ƒéŒ¯èª¤ç³»çµ±
- **ç¯„åœ**: çµ±ä¸€éŒ¯èª¤è™•ç†å’Œæ–·è·¯å™¨æ¨¡å¼
- **ä¾è³´**: åŸºæ–¼ MessageErrorHandler çš„æˆåŠŸç¶“é©—

## ğŸ“š å­¸ç¿’æ”¶ç©«

### TDD æ–¹æ³•è«–å¯¦è¸
1. **æ¸¬è©¦å…ˆè¡Œè¨­è¨ˆ**: 19å€‹æ¸¬è©¦å®Œæ•´å®šç¾©äº† API å¥‘ç´„
2. **æœ€å°å¯è¡Œå¯¦ç¾**: å°ˆæ³¨æ–¼è®“æ¸¬è©¦é€šéçš„æ ¸å¿ƒåŠŸèƒ½
3. **å¿«é€Ÿåé¥‹å¾ªç’°**: 0.216ç§’çš„æ¸¬è©¦åŸ·è¡Œæ™‚é–“æ”¯æ´å¿«é€Ÿè¿­ä»£

### Chrome Extension é–‹ç™¼æ´å¯Ÿ
1. **è¨Šæ¯è·¯ç”±è¤‡é›œæ€§**: è·¨ä¸Šä¸‹æ–‡é€šè¨Šçš„å¸¸è¦‹é™·é˜±
2. **éŒ¯èª¤è¨ºæ–·é‡è¦æ€§**: å®Œå–„çš„éŒ¯èª¤è™•ç†å°é–‹ç™¼æ•ˆç‡çš„å½±éŸ¿
3. **æ•ˆèƒ½è€ƒé‡**: è¨˜æ†¶é«”ç®¡ç†åœ¨é•·æœŸé‹è¡Œæ“´å±•ä¸­çš„é‡è¦æ€§

### äº‹ä»¶é©…å‹•æ¶æ§‹æ‡‰ç”¨
1. **çµ±ä¸€è™•ç†æ¨¡å¼**: EventHandler ç¹¼æ‰¿æä¾›çš„æ¨™æº–åŒ–å„ªå‹¢
2. **å„ªå…ˆç´šè¨­è¨ˆ**: éŒ¯èª¤è™•ç†å™¨çš„æœ€é«˜å„ªå…ˆç´šç¢ºä¿ç³»çµ±ç©©å®šæ€§
3. **è§£è€¦è¨­è¨ˆ**: äº‹ä»¶é©…å‹•çš„éŒ¯èª¤è™•ç†èˆ‡æ¥­å‹™é‚è¼¯åˆ†é›¢

---

**å®Œæˆæ™‚é–“**: 2025-08-07  
**ç¸½é–‹ç™¼æ™‚é–“**: ~3 å°æ™‚  
**TDD å¾ªç’°ç‹€æ…‹**: ğŸ”´âœ… ğŸŸ¢âœ… ğŸ”µâ³  
**ä¸‹ä¸€æ­¥**: é‡æ§‹éšæ®µå„ªåŒ–å’Œ TDD å¾ªç’° #32 æº–å‚™