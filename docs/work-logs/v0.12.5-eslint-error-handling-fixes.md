# v0.12.5 - ESLint 錯誤處理規範大規模修正作業

**版本**: v0.12.5  
**日期**: 2025-09-11  
**類型**: 品質修正與標準化  
**狀態**: 🔄 進行中

## 🎯 任務目標

執行專案 ESLint 錯誤處理規範強制執行的大規模修正，將所有 `new Error(...)` 轉換為 `new StandardError(...)` 格式，確保符合專案的標準化錯誤處理體系。

### 背景

- 專案目前有 **819 個 ESLint 違規**，全部為錯誤處理規範違反
- ESLint 規則已啟用，禁止使用原生 `Error` 類別
- 需要統一使用 `StandardError` 或其子類 (`BookValidationError`)
- 確保所有錯誤提供結構化的錯誤代碼和詳情

### 技術規範

根據 `docs/claude/eslint-error-handling-rules.md`:

1. **禁止原生 Error**: `new Error(...)` → `new StandardError(code, message, details)`
2. **強制結構化**: 錯誤必須包含 `code`、`message` 和 `details`
3. **分類要求**: `details` 必須包含 `category` 欄位
4. **引入要求**: 檔案必須正確引入 `const { StandardError } = require('src/core/errors/StandardError')`

## 📊 影響範圍分析

### 檔案統計

```bash
# 總計需要修正的檔案和錯誤數量
new Error(...) 使用次數: 1044+ 個
影響檔案數量: 253+ 個
```

### 主要檔案類別

1. **核心服務檔案**: `src/background/`, `src/core/`
2. **匯出處理器**: `src/export/handlers/`
3. **UI 處理器**: `src/ui/handlers/`
4. **儲存處理器**: `src/storage/handlers/`
5. **內容腳本**: `src/content/`
6. **測試檔案**: `tests/`

## 🚀 修正策略

### 階段性修正流程

#### Phase 1: 核心檔案手動修正 ✅
已完成的關鍵檔案：
- ✅ `src/deployment/chrome-store-readiness.js` (12 個錯誤)
- ✅ `src/handlers/extraction-progress-handler.js` (6 個錯誤)
- ✅ `src/overview/overview.js` (1 個錯誤)
- 🔄 `src/export/export-manager.js` (進行中)

#### Phase 2: 批量修正腳本開發 🔄
- ✅ 建立 `scripts/fix-eslint-error-handling.js` 腳本
- ✅ 建立錯誤代碼映射表
- ✅ 建立分類策略
- 🔄 錯誤細節提取邏輯

#### Phase 3: 批量執行與驗證 ⭕
- ⭕ 執行批量修正腳本
- ⭕ ESLint 檢查驗證
- ⭕ 測試通過率確認
- ⭕ 功能完整性驗證

### 錯誤轉換模式

#### 標準轉換格式
```javascript
// 修正前
throw new Error('Missing required data')

// 修正後  
throw new StandardError('MISSING_REQUIRED_DATA', 'Missing required data', {
  category: 'validation',
  expectedFields: ['field1', 'field2']
})
```

#### 引入語句標準化
```javascript
// Node.js 環境
const { StandardError } = require('src/core/errors/StandardError')

// 瀏覽器環境 (overview.js 等)
if (typeof window !== 'undefined' && window.StandardError) {
  // StandardError 已在全域可用
} else if (typeof require !== 'undefined') {
  const { StandardError } = require('src/core/errors/StandardError')
  if (typeof window !== 'undefined') {
    window.StandardError = StandardError
  }
}
```

## 📋 詳細修正記錄

### ✅ 已完成檔案

#### 1. src/deployment/chrome-store-readiness.js
- **錯誤數**: 12 個
- **修正類型**: Manifest 驗證、檔案大小檢查、安全性檢查、效能驗證
- **錯誤代碼**: `MANIFEST_VERSION_INVALID`, `FILE_SIZE_EXCEEDED`, `UNSAFE_CSP_INLINE` 等
- **狀態**: ✅ 完成

#### 2. src/handlers/extraction-progress-handler.js  
- **錯誤數**: 6 個
- **修正類型**: 進度資料驗證、EventBus 配置、UI 事件處理
- **錯誤代碼**: `MISSING_PROGRESS_DATA`, `EVENTBUS_NOT_CONFIGURED` 等
- **狀態**: ✅ 完成

#### 3. src/overview/overview.js
- **錯誤數**: 1 個
- **修正類型**: 類別可用性檢查
- **錯誤代碼**: `OVERVIEW_CONTROLLER_UNAVAILABLE`
- **狀態**: ✅ 完成

### 🔄 進行中檔案

#### 4. src/export/export-manager.js
- **錯誤數**: 9 個 (預估)
- **修正類型**: EventBus 初始化、並發限制、資料驗證
- **錯誤代碼**: `EVENTBUS_REQUIRED`, `CONCURRENT_LIMIT_EXCEEDED` 等
- **狀態**: 🔄 進行中 (1/9 完成)

## 🔧 修正工具與腳本

### 批量修正腳本功能

`scripts/fix-eslint-error-handling.js` 提供以下功能：

1. **自動掃描**: 遞迴掃描 `src/` 目錄所有 `.js` 檔案
2. **模式識別**: 使用正則表達式識別 `new Error(...)` 模式
3. **智能轉換**: 根據錯誤訊息內容生成合適的錯誤代碼
4. **自動引入**: 檢查並自動添加 StandardError 引入語句
5. **分類邏輯**: 基於檔案路徑和錯誤內容自動分類

### 錯誤代碼映射策略

```javascript
const ERROR_CODE_MAPPING = {
  'required': 'REQUIRED_FIELD_MISSING',
  'invalid': 'INVALID_DATA_FORMAT', 
  'missing': 'MISSING_REQUIRED_DATA',
  'failed': 'OPERATION_FAILED',
  'not found': 'RESOURCE_NOT_FOUND',
  'exceed': 'LIMIT_EXCEEDED',
  'manifest': 'MANIFEST_VALIDATION_ERROR',
  'storage': 'STORAGE_OPERATION_FAILED',
  // ... 更多映射規則
}
```

## 📈 進度追蹤

### 修正進度統計

- **已完成檔案**: 3/253+ (1.2%)
- **已修正錯誤**: 19/1044+ (1.8%)
- **預估剩餘時間**: 需要批量修正腳本執行

### 品質驗證指標

- **ESLint 通過率**: 目標 100%
- **測試通過率**: 維持 100%
- **功能完整性**: 無破壞性變更

## 🚨 風險評估與應對

### 主要風險

1. **大規模變更風險**: 超過 1000 個錯誤修正可能引入新問題
2. **測試覆蓋風險**: 某些錯誤處理邏輯可能影響測試
3. **環境相容風險**: Chrome Extension 環境和 Node.js 環境的引入差異

### 應對策略

1. **階段性驗證**: 每批次修正後執行完整測試
2. **備份機制**: Git 提交記錄確保可回滾
3. **環境測試**: 確保 Chrome Extension 和測試環境都正常運作

## 📝 下一步行動

### 立即執行

1. **完成 export-manager.js**: 繼續手動修正剩餘錯誤
2. **驗證修正模式**: 確保修正的錯誤符合規範
3. **執行批量腳本**: 運行 `scripts/fix-eslint-error-handling.js`

### 後續驗證

1. **執行 ESLint**: `npm run lint | grep "🚨" | wc -l` 應該為 0
2. **執行測試**: `npm test` 確保通過率 100%
3. **功能測試**: 驗證 Chrome Extension 功能正常

### 文件更新

1. **更新 CHANGELOG.md**: 記錄修正內容
2. **更新規範文件**: 補充實際修正案例
3. **更新範例檔**: 新增修正前後對比範例

## 💡 經驗總結

### 修正最佳實踐

1. **錯誤代碼命名**: 使用 `OPERATION_FAILURE_TYPE` 格式
2. **分類一致性**: 根據檔案功能域進行一致分類
3. **詳情完整性**: 提供足夠的 context 資訊用於除錯
4. **環境適配**: 考慮瀏覽器和 Node.js 環境差異

### 開發效率提升

1. **批量處理**: 大規模修正使用腳本自動化
2. **模式識別**: 建立標準的錯誤轉換模式
3. **階段驗證**: 分批次執行避免大範圍影響

---

**建立時間**: 2025-09-11 14:30  
**最後更新**: 2025-09-11 14:30  
**下次更新**: 完成批量修正後