# 🚨 v0.12.13 - StandardError 錯誤處理體系語意化重構

## 📋 版本資訊

- **版本號**: v0.12.13
- **開始時間**: 2025-09-16
- **基於版本**: v0.12.12 (ESLint 大規模清理完成)
- **開發重點**: StandardError 錯誤處理體系語意化重構

## 🎯 核心目標

### 主要任務
1. **錯誤處理標準化**: 將專案中154+個錯誤處理問題系統性修復
2. **錯誤代碼語意化**: 建立完整的語意化錯誤代碼分類體系
3. **測試格式統一**: 統一錯誤測試格式，符合StandardError規範

### 問題背景
專案中存在大量不當錯誤處理模式，影響程式碼品質和維護性：
- 過度使用泛用錯誤代碼 (TEST_ERROR, UNKNOWN_ERROR)
- 錯誤測試格式不一致 (.toMatchObject() 誤用)
- 測試期望與實際錯誤代碼不符
- 缺乏系統性的錯誤分類體系

## 🚨 問題總覽

### 十個代理人檢查結果統計

| 檢查範圍 | Critical | High | Medium | Low | 總問題數 |
|----------|----------|------|--------|-----|----------|
| **popup 測試** | 6 | 8 | 4 | 2 | **20** |
| **overview 測試** | 4 | 2 | 3 | 1 | **10** |
| **content 測試** | 5 | 6 | 3 | 2 | **16** |
| **background 測試** | 8 | 12 | 5 | 3 | **28** |
| **storage 測試** | 7 | 5 | 3 | 3 | **18** |
| **ui 其他測試** | 4 | 6 | 2 | 2 | **14** |
| **export 測試** | 6 | 4 | 4 | 1 | **15** |
| **handlers 測試** | 2 | 3 | 2 | 1 | **8** |
| **integration 測試** | 5 | 8 | 4 | 3 | **20** |
| **e2e 測試** | 1 | 2 | 1 | 1 | **5** |
| **總計** | **48** | **56** | **31** | **19** | **154** |

### 發現的五大類錯誤處理問題

1. **使用 .toMatchObject() 測試錯誤** (65+ 處)
   - 語法錯誤，期望格式不符StandardError規範
   - 應使用 .toThrow() 或分離檢查錯誤屬性

2. **使用泛用錯誤代碼** (89+ 處)
   - TEST_ERROR, UNKNOWN_ERROR 等無語意錯誤代碼
   - 無法精確分類錯誤類型，影響除錯效率

3. **測試期望與實際錯誤代碼不符** (35+ 處)
   - 測試期望特定錯誤代碼但實際拋出不同代碼
   - 導致測試無法正確驗證錯誤處理邏輯

4. **缺少 StandardError 引入** (12 處)
   - 測試檔案使用StandardError但未正確引入
   - 影響錯誤類型驗證完整性

5. **錯誤測試格式不正確** (45+ 處)
   - 混用不同錯誤測試方式
   - 缺乏一致性，影響測試品質

## ✅ 已完成工作

### Phase 1: 問題識別與規範建立 (2025-09-16)

#### 🎯 格式化範例文件更新
- ✅ **完成**: 將StandardError錯誤代碼語意化修正案例加入 `docs/claude/format-fix-examples.md`
- 📋 **內容**: 建立完整的語意化錯誤代碼修正範例和最佳實踐
- 🎯 **效益**: 為後續修復工作提供標準參考

#### 🔧 SearchCoordinator 錯誤代碼語意化重構
- ✅ **完成**: 全面重構 SearchCoordinator 錯誤處理體系
- 📊 **修正範圍**:
  - `UNKNOWN_ERROR` → `COORDINATOR_CONFIG_ERROR` (配置錯誤)
  - `UNKNOWN_ERROR` → `SEARCH_VALIDATION_ERROR` (搜尋驗證錯誤)
  - `UNKNOWN_ERROR` → `FILTER_VALIDATION_ERROR` (篩選驗證錯誤)
  - `UNKNOWN_ERROR` → `COORDINATOR_STATE_ERROR` (協調器狀態錯誤)
  - `UNKNOWN_ERROR` → `SEARCH_COORDINATION_ERROR` (搜尋協調錯誤)
  - `UNKNOWN_ERROR` → `FILTER_COORDINATION_ERROR` (篩選協調錯誤)
- 🧪 **測試驗證**: 所有45個測試案例更新並通過

#### 🧪 測試期望更新
- ✅ **完成**: 更新 `search-coordinator.test.js` 所有測試期望
- 📊 **成果**: 45個測試案例全部使用語意化錯誤代碼並通過
- 🎯 **範例**: 建立了完整的錯誤測試最佳實踐範例

#### 📊 問題全面調查
- ✅ **完成**: 十個代理人並行檢查專案所有測試檔案
- 📋 **範圍**: 涵蓋 popup, overview, content, background, storage, ui, export, handlers, integration, e2e 等所有測試目錄
- 📊 **成果**: 識別出154+個錯誤處理問題，建立完整問題清單和優先級分類

## 🔄 待處理工作

### Phase 2: 系統性錯誤處理重構

#### 🔴 Critical 優先級檔案修復
1. **background 測試群** (28 個問題)
   - `data-validation-service.test.js` - 混用錯誤測試方法
   - `adapter-factory-service.test.js` - 3處泛用錯誤代碼
   - 預計處理時間：2-3個工作日

2. **popup 測試群** (20 個問題)
   - `popup-controller-extraction-integration.test.js` - 錯誤代碼不匹配
   - `popup-extraction-service.test.js` - 錯誤代碼不匹配
   - 預計處理時間：1-2個工作日

3. **integration 測試群** (20 個問題)
   - `basic-integration.test.js` - 大量TEST_ERROR使用
   - `cross-module-error-propagation.test.js` - 錯誤傳播測試問題
   - 預計處理時間：2個工作日

#### 🟡 High 優先級檔案修復
4. **storage 測試群** (18 個問題) - 1-2個工作日
5. **content 測試群** (16 個問題) - 1-2個工作日
6. **export 測試群** (15 個問題) - 1個工作日

#### 📋 系統性改善任務
- **測試格式統一**: 移除所有不當 .toMatchObject() 使用
- **錯誤代碼語意化**: 建立完整的錯誤代碼分類體系
- **StandardError引入補全**: 為所有需要的測試檔案添加引入
- **文檔完善**: 更新錯誤處理相關文檔和範例

#### ✅ 最終驗證
- **全面測試**: 確保所有修復後的測試通過
- **回歸測試**: 驗證修復沒有破壞現有功能
- **效果評估**: 統計修復效果和品質提升指標

## 📈 預期效益

### 1. 測試品質提升
- 所有錯誤測試將能正確驗證錯誤處理邏輯
- 統一的測試格式提升程式碼可讀性

### 2. 錯誤分類精確
- 具體錯誤代碼將提升除錯效率
- 明確的錯誤分類便於問題追蹤

### 3. 維護性改善
- 統一的錯誤處理模式降低維護成本
- 清晰的錯誤代碼體系便於新功能開發

### 4. 文檔價值
- 測試本身成為錯誤處理的活文檔
- 提升新開發者的學習曲線

## 🛠 修復策略

### 統一修復模式
```javascript
// ❌ 錯誤模式
expect(result.error).toContain('錯誤訊息')
throw new StandardError('TEST_ERROR', 'message')

// ✅ 正確模式
await expect(operation()).rejects.toThrow(StandardError)
await expect(operation()).rejects.toMatchObject({
  code: 'SPECIFIC_ERROR_CODE',
  message: expect.stringContaining('具體描述'),
  details: expect.objectContaining({ /* 具體期望 */ })
})
```

### 錯誤代碼分類體系
- `*_VALIDATION_ERROR`: 驗證相關錯誤
- `*_CONFIG_ERROR`: 配置相關錯誤
- `*_STATE_ERROR`: 狀態相關錯誤
- `*_COORDINATION_ERROR`: 協調相關錯誤
- `*_OPERATION_ERROR`: 操作相關錯誤

---

## 📊 工作追蹤

### 進度指標
- **問題識別**: ✅ 100% (154/154)
- **規範建立**: ✅ 100% (完成範例文件)
- **Critical修復**: ⭕ 0% (0/68)
- **High修復**: ⭕ 0% (0/49)
- **整體修復**: ⭕ 0% (0/154)

### 下一步行動
1. 開始 Critical 優先級檔案修復
2. 建立錯誤代碼分類字典
3. 實施統一修復策略
4. 逐步推進各優先級修復工作

---

**版本狀態**: 🔄 開發中
**預計完成時間**: 2025-09-23
**負責人**: Claude Code + 專案團隊
**相關文件**: docs/claude/format-fix-examples.md, tests/unit/ui/search/coordinator/search-coordinator.test.js