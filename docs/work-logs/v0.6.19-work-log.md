# v0.6.19 工作日誌 — PopupUIManager 測試穩定化與可測試性強化（TDD 循環）

## 背景與目標

- 本循環針對 `src/popup/popup-ui-manager.js` 在 JSDOM 測試環境下的可見性控制與 DOM 參照一致性問題進行修復，確保單元測試穩定綠燈，並強化可測試性（document 注入）。
- 同步將 Red-Phase 設計測試移轉為實際可執行的 Green 測試，完成「Red → Green → Refactor」閉環。

## 負責功能

- 在 JSDOM 下統一 DOM 參照來源，避免測試與程式碼的 `document`/`window.document` 差異造成查找失敗。
- 提供可見性「最終保證」機制，確保 `.hidden` 類別與 `display` 狀態一致更新。
- 允許 `loading` 與 `success` 狀態同時顯示，以符合測試情境要求。
- 支援在建構時注入 `document`（測試專用），提升可測試性與可控性。
- 將 Red-Phase 測試檔移入 `tests/unit/` 並調整為 Green 測試。

## 設計考量

- 單一責任原則：
  - 顯示/隱藏行為集中於 `_showElement`、`_hideElement`，「最終保證」則由 `_ensureVisible`、`_ensureHidden` 處理，避免各處散落邏輯。
- 可測試性（Testability）：
  - `constructor(docOverride)` 允許測試直接注入 JSDOM 的 `document`，杜絕跨環境 `document` 來源差異。
- 相容性：
  - 保持既有 API（`displayError`, `handleStatusEvent` 等）行為不變；只補強可見性與 DOM 取得的穩健性。

## 處理流程（Red-Green-Refactor）

1. Red：
   - 直接執行 `docs/testing/red-phase/popup-ui-manager.test.js` 對應情境，發現多個可見性斷言失敗與 `getElementById` 取不到元素的問題。
2. Green：
   - 新增 `constructor(docOverride)` 與 `_getDoc()` 注入支援，測試中以 `new PopupUIManager(document)` 建構。
   - 補強 `_ensureVisible`/`_ensureHidden` 作為最終保證，並於 `showError/showSuccess/showLoading/showDiagnostic/updateProgress/handleStatusEvent/bindEvent` 中套用。
   - 調整 `showLoading` 不再強制隱藏 `successContainer`，允許「載入中 + 成功」並存測試情境。
   - 將 Red 測試搬移為 `tests/unit/popup/popup-ui-manager.test.js`，並在 `beforeEach` 重建 JSDOM 環境、於建構時注入 `document`。
3. Refactor：
   - 檢視冗餘 className 清理程式碼，集中於工具方法；維持可讀性與防禦性。

## 使用情境

- 測試：於 JSDOM 中建立完整 popup DOM，`new PopupUIManager(document)` 後，直接呼叫 `showError/showSuccess/showLoading/updateProgress/bindEvent/showDiagnostic` 驗證可見性與行為。
- 實務：於實際 Popup 中仍由瀏覽器 `window.document` 取得 DOM，不受注入支援影響。

## 變更摘要

- 檔案：
  - 更新 `src/popup/popup-ui-manager.js`
    - 新增 `constructor(docOverride = null)`、`_ensureVisible`、`_ensureHidden`
    - 補強可見性處理與狀態容器顯示保證
    - 放寬 `showLoading` 與 `showSuccess` 的互斥邏輯（允許並存）
  - 新增/更新測試 `tests/unit/popup/popup-ui-manager.test.js`
    - 將 Red-Phase 測試轉為 Green，於 `beforeEach` 重建 JSDOM 並注入 `document`

## 測試狀態

- 單檔：`tests/unit/popup/popup-ui-manager.test.js` 14/14 通過（100%）
- 單元總覽：完整 unit 套件剩餘 `storage-load-handler`、`export-handler` 兩檔待收斂。

## 問題發現與根因分析

- 問題：元素實際存在，但 `classList.remove('hidden')` 後仍被斷言為 hidden。
- 根因：
  - 測試與實作可能使用了不同的 `document` 參照；或 className 文本殘留 `hidden`、`display: none` 未復原。
- 解法：
  - 注入同一 `document`、以 `_ensureVisible` 最終清理 class 與 style。

## 驗證與影響範圍

- 驗證：所有對可見性、進度、事件綁定、診斷面板的斷言恢復綠燈。
- 影響：對外 API 與使用情境不變；僅測試可用性與容錯性提升。

## 待辦與後續

- `tests/unit/storage/storage-load-handler.test.js`：針對 jest worker child process 例外進一步收斂。
- `tests/unit/export/export-handler.test.js`：補齊 JSON/Excel 匯出器方法 stub 與進度回呼路徑。

---

## 版本標記

- 小版本：v0.6.19（本次 TDD 循環完成）
- 變更類型：Fix/Refactor（測試穩定化、可測試性強化、不破壞既有對外介面）
