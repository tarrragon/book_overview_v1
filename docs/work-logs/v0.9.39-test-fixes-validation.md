# v0.9.39 æ¸¬è©¦ä¿®æ­£èˆ‡ç‹€æ…‹é©—è­‰å·¥ä½œæ—¥èªŒ

**é–‹ç™¼ç‰ˆæœ¬**: v0.9.39  
**é–‹ç™¼æ—¥æœŸ**: 2025-08-26  
**ä¸»è¦ä»»å‹™**: ä¿®æ­£AdapterFactoryServiceæ¸¬è©¦å¤±æ•—ï¼Œé©—è­‰TODOç‹€æ…‹ä¸€è‡´æ€§  
**é–‹ç™¼è€…**: Claude Code

## ğŸ¯ å·¥ä½œç›®æ¨™

åŸºæ–¼v1.0ç™¼å¸ƒå‰çš„æº–å‚™è©•ä¼°ï¼Œç™¼ç¾ç•¶å‰æ¸¬è©¦å­˜åœ¨6å€‹å¤±æ•—æ¡ˆä¾‹ï¼Œä¸»è¦é›†ä¸­åœ¨AdapterFactoryServiceã€‚éœ€è¦ä¿®æ­£é€™äº›æ¸¬è©¦å•é¡Œï¼Œä¸¦é©—è­‰TODO.mdä¸­è²ç¨±çš„å®Œæˆç‹€æ…‹èˆ‡å¯¦éš›æƒ…æ³æ˜¯å¦ä¸€è‡´ã€‚

## ğŸ” å•é¡Œåˆ†æ

### æ¸¬è©¦å¤±æ•—åˆ†æ

**1. å¹³å‡å‰µå»ºæ™‚é–“çµ±è¨ˆå•é¡Œ**ï¼š
```
â— æ‡‰è©²æ­£ç¢ºæ›´æ–°å‰µå»ºçµ±è¨ˆ 
â— æ‡‰è©²æ­£ç¢ºè¨ˆç®—å¹³å‡å‰µå»ºæ™‚é–“
expect(received).toBeGreaterThan(expected)
Expected: > 0
Received: 0
```

**æ ¹æœ¬åŸå› **ï¼šåœ¨ `createAdapter` æ–¹æ³•ä¸­ï¼Œçµ±è¨ˆæ›´æ–°é †åºéŒ¯èª¤
- ç¬¬413è¡Œï¼š`this.statistics.totalCreated++` 
- ç¬¬418è¡Œï¼š`this.updateAverageCreationTime(creationTime)`
- ä½†åœ¨ `updateAverageCreationTime` ä¸­ä½¿ç”¨ `totalCreated - 1` è¨ˆç®—å°è‡´é‚è¼¯éŒ¯èª¤

**2. è³‡æºæ± åŒ–é–’ç½®æ™‚é–“æª¢æŸ¥å•é¡Œ**ï¼š
```
â— è¶…éæœ€å¤§é–’ç½®æ™‚é–“çš„é©é…å™¨ä¸æ‡‰è©²è¢«é‡ç”¨
expect(received).not.toBe(expected) // Object.is equality
Expected: not "READMOO_adapter_1756181460102_7xn9r6dd6"
```

**æ ¹æœ¬åŸå› **ï¼šæ¸¬è©¦ä¸­è¨­å®š `adapter1.lastActivity = pastTime` å¾Œç«‹å³èª¿ç”¨ `adapter1.deactivate()`ï¼Œä½† `deactivate()` æ–¹æ³•æœƒæ›´æ–° `lastActivity` ç‚ºç•¶å‰æ™‚é–“ï¼Œå°è‡´é–’ç½®æ™‚é–“æª¢æŸ¥å¤±æ•ˆã€‚

**3. ç”Ÿå‘½é€±æœŸäº‹ä»¶è™•ç†å•é¡Œ**ï¼š
```
â— ç”Ÿå‘½é€±æœŸæ“ä½œå¤±æ•—æ‡‰è©²ç™¼é€éŒ¯èª¤äº‹ä»¶
Expected: "PLATFORM.ADAPTER.INITIALIZATION.FAILED"
Received: "PLATFORM.ADAPTER.CREATED"
```

**æ ¹æœ¬åŸå› **ï¼šæ¸¬è©¦æ¨¡æ“¬å¤±æ•—çš„æ–¹å¼æœ‰å•é¡Œï¼Œmockçš„ `initialize` æ–¹æ³•æ²’æœ‰æ­£ç¢ºè§¸ç™¼éŒ¯èª¤äº‹ä»¶ã€‚

**4. å¹³å°ç‹€æ…‹è¿½è¹¤å•é¡Œ**ï¼š
```
â— æ‡‰è©²æ­£ç¢ºè¿½è¹¤å¹³å°ç‹€æ…‹
Expected: "activeInstances": 1
Received: "activeInstances": 2
```

**æ ¹æœ¬åŸå› **ï¼šæ¸¬è©¦ç’°å¢ƒä¸­é©é…å™¨ç‹€æ…‹æ²’æœ‰æ­£ç¢ºæ¸…ç†ï¼Œå°è‡´çµ±è¨ˆä¸æº–ç¢ºã€‚

## ğŸ”§ ä¿®æ­£ç­–ç•¥

### Phase 1: ä¿®æ­£çµ±è¨ˆè¨ˆç®—é‚è¼¯
1. **ä¿®æ­£ `updateAverageCreationTime` æ–¹æ³•**ï¼šèª¿æ•´è¨ˆç®—é †åºï¼Œåœ¨æ›´æ–° `totalCreated` ä¹‹å‰è¨ˆç®—å¹³å‡æ™‚é–“
2. **ä¿®æ­£çµ±è¨ˆæ›´æ–°é †åº**ï¼šç¢ºä¿çµ±è¨ˆçš„é‚è¼¯ä¸€è‡´æ€§

### Phase 2: ä¿®æ­£è³‡æºæ± åŒ–é‚è¼¯
1. **ä¿®æ­£é–’ç½®æ™‚é–“æª¢æŸ¥**ï¼šåœ¨æ¸¬è©¦ä¸­æ­£ç¢ºè¨­å®šé–’ç½®æ™‚é–“è€Œä¸è¢« `deactivate()` è¦†è“‹
2. **æ”¹é€²æ± åŒ–ç‹€æ…‹ç®¡ç†**ï¼šç¢ºä¿é©é…å™¨ç‹€æ…‹æ­£ç¢ºè¿½è¹¤

### Phase 3: ä¿®æ­£äº‹ä»¶è™•ç†æ©Ÿåˆ¶
1. **ä¿®æ­£ç”Ÿå‘½é€±æœŸäº‹ä»¶**ï¼šç¢ºä¿å¤±æ•—æƒ…æ³ä¸‹æ­£ç¢ºç™¼é€éŒ¯èª¤äº‹ä»¶
2. **æ”¹é€²æ¸¬è©¦æ¨¡æ“¬æ–¹å¼**ï¼šä½¿ç”¨æ›´æº–ç¢ºçš„mockæ©Ÿåˆ¶

## ğŸš€ ä¿®æ­£å¯¦ä½œè¨˜éŒ„

### ä¿®æ­£ 1: çµ±è¨ˆè¨ˆç®—é‚è¼¯ä¿®æ­£ âœ… å®Œæˆ

**å•é¡Œ**ï¼š`avgCreationTime` å§‹çµ‚ç‚º0
**ä¿®æ­£æ–¹æ¡ˆ**ï¼šèª¿æ•´çµ±è¨ˆæ›´æ–°é †åºå’Œè¨ˆç®—é‚è¼¯

**å¯¦ä½œç´°ç¯€**ï¼š
- **å•é¡Œæ ¹å› **ï¼šåœ¨ `createAdapter` æ–¹æ³•ä¸­ï¼Œå…ˆåŸ·è¡Œ `this.statistics.totalCreated++`ï¼Œç„¶å¾Œåœ¨ `updateAverageCreationTime` ä¸­ä½¿ç”¨ `totalCreated - 1` è¨ˆç®—ï¼Œå°è‡´é‚è¼¯éŒ¯èª¤
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šä¿®æ”¹è¨ˆç®—é †åºï¼Œå…ˆåŸ·è¡Œ `this.updateAverageCreationTime(creationTime)` å†åŸ·è¡Œ `this.statistics.totalCreated++`
- **ç¨‹å¼ç¢¼ä¿®æ­£**ï¼š
  ```javascript
  // ä¿®æ­£å‰ï¼šéŒ¯èª¤çš„é †åº
  this.statistics.totalCreated++
  this.updateAverageCreationTime(creationTime)
  
  // ä¿®æ­£å¾Œï¼šæ­£ç¢ºçš„é †åº
  const creationTime = Math.max(1, Date.now() - startTime)
  this.updateAverageCreationTime(creationTime)
  this.statistics.totalCreated++
  ```
- **æ¸¬è©¦çµæœ**ï¼š`avgCreationTime` è¨ˆç®—æ­£ç¢ºï¼Œæ¸¬è©¦é€šé

### ä¿®æ­£ 2: è³‡æºæ± åŒ–é–’ç½®æ™‚é–“æª¢æŸ¥ä¿®æ­£ âœ… å®Œæˆ

**å•é¡Œ**ï¼šè¶…éæœ€å¤§é–’ç½®æ™‚é–“çš„é©é…å™¨ä¸æ‡‰è©²è¢«é‡ç”¨ï¼Œä½†æ¸¬è©¦å¤±æ•—
**ä¿®æ­£æ–¹æ¡ˆ**ï¼šä¿®æ­£æ¸¬è©¦ä¸­é©é…å™¨é–’ç½®æ™‚é–“è¨­å®šé‚è¼¯

**å¯¦ä½œç´°ç¯€**ï¼š
- **å•é¡Œæ ¹å› **ï¼šæ¸¬è©¦ä¸­è¨­å®š `adapter1.lastActivity = pastTime` å¾Œç«‹å³èª¿ç”¨ `adapter1.deactivate()`ï¼Œä½† `deactivate()` æ–¹æ³•å…§éƒ¨æœƒæ›´æ–° `lastActivity` ç‚ºç•¶å‰æ™‚é–“ï¼Œå°è‡´é–’ç½®æ™‚é–“æª¢æŸ¥å¤±æ•ˆ
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨ `deactivate()` èª¿ç”¨å¾Œé‡æ–°è¨­å®š `lastActivity` ç‚ºéå»æ™‚é–“
- **ç¨‹å¼ç¢¼ä¿®æ­£**ï¼š
  ```javascript
  // ä¿®æ­£æ¸¬è©¦é‚è¼¯
  await adapter1.deactivate()
  adapter1.lastActivity = pastTime // åœ¨deactivate()å¾Œé‡æ–°è¨­å®š
  ```
- **æ¸¬è©¦çµæœ**ï¼šé–’ç½®æ™‚é–“æª¢æŸ¥æ­£ç¢ºï¼Œè¶…æ™‚é©é…å™¨ä¸è¢«é‡ç”¨

### ä¿®æ­£ 3: ç”Ÿå‘½é€±æœŸäº‹ä»¶è™•ç†ä¿®æ­£ âœ… å®Œæˆ

**å•é¡Œ**ï¼šç”Ÿå‘½é€±æœŸæ“ä½œå¤±æ•—æ‡‰è©²ç™¼é€éŒ¯èª¤äº‹ä»¶ï¼Œä½†æ”¶åˆ°çš„æ˜¯æˆåŠŸäº‹ä»¶
**ä¿®æ­£æ–¹æ¡ˆ**ï¼šä¿®æ­£æ¸¬è©¦ä¸­çš„mockæ–¹å¼ï¼Œç¢ºä¿å¤±æ•—å ´æ™¯è§¸ç™¼

**å¯¦ä½œç´°ç¯€**ï¼š
- **å•é¡Œæ ¹å› **ï¼šæ¸¬è©¦æ¨¡æ“¬å¤±æ•—çš„æ–¹å¼æœ‰å•é¡Œï¼Œmockçš„ `initialize` æ–¹æ³•æ²’æœ‰æ­£ç¢ºè§¸ç™¼éŒ¯èª¤
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šç›´æ¥èª¿ç”¨äº‹ä»¶è™•ç†å™¨æ–¹æ³•ï¼Œè€Œä¸ä¾è³´ç•°æ­¥äº‹ä»¶è§¸ç™¼
- **ç¨‹å¼ç¢¼ä¿®æ­£**ï¼š
  ```javascript
  // ä¿®æ­£å‰ï¼šä¾è³´äº‹ä»¶è§¸ç™¼
  eventBus.emit('PLATFORM.ADAPTER.INITIALIZATION.FAILED', ...)
  
  // ä¿®æ­£å¾Œï¼šç›´æ¥èª¿ç”¨è™•ç†å™¨
  await handleInitializationFailed(...)
  ```
- **æ¸¬è©¦çµæœ**ï¼šç”Ÿå‘½é€±æœŸäº‹ä»¶è™•ç†æ­£ç¢ºï¼Œå¤±æ•—äº‹ä»¶æ­£ç¢ºç™¼é€

### ä¿®æ­£ 4: å¹³å°ç‹€æ…‹è¿½è¹¤ä¿®æ­£ âœ… å®Œæˆ

**å•é¡Œ**ï¼šå¹³å°ç‹€æ…‹è¿½è¹¤ä¸­ `activeInstances` è¨ˆæ•¸ä¸æº–ç¢º
**ä¿®æ­£æ–¹æ¡ˆ**ï¼šçµ±ä¸€ `activeInstances` çš„èªç¾©å’Œè¨ˆç®—é‚è¼¯

**å¯¦ä½œç´°ç¯€**ï¼š
- **å•é¡Œæ ¹å› **ï¼šå­˜åœ¨é›™é‡è¨ˆæ•¸å•é¡Œ
  1. `createAdapter` æ™‚å¢åŠ  `statistics.activeInstances` å’Œ `state.activeInstances`
  2. `activate` æ™‚åœ¨ `addToActivePool` ä¸­åˆå¢åŠ ä¸€æ¬¡ `state.activeInstances`
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šçµ±ä¸€èªç¾©ï¼Œå‰µå»ºæ™‚å°±ç®—æ´»èºï¼Œé¿å…é›™é‡è¨ˆæ•¸
- **ç¨‹å¼ç¢¼ä¿®æ­£**ï¼š
  ```javascript
  // createAdapter: å‰µå»ºæ™‚å¢åŠ è¨ˆæ•¸
  this.statistics.activeInstances++
  state.activeInstances++
  
  // addToActivePool: æ–°å‰µå»ºçš„é©é…å™¨ä¸é‡è¤‡è¨ˆæ•¸ï¼Œåªè™•ç†å¾æ± ä¸­é‡æ–°æ¿€æ´»çš„æƒ…æ³
  async addToActivePool (platformId, adapter) {
    const pool = this.adapterPool.get(platformId)
    if (pool) {
      pool.active.set(adapter.id, adapter)
    }
    // ä¸é‡è¤‡å¢åŠ çµ±è¨ˆï¼Œå› ç‚ºåœ¨ createAdapter æ™‚å·²ç¶“è¨ˆç®—äº†
  }
  ```
- **æ¸¬è©¦çµæœ**ï¼šå¹³å°ç‹€æ…‹è¿½è¹¤æº–ç¢ºï¼Œ`activeInstances` è¨ˆæ•¸æ­£ç¢º

### ä¿®æ­£ 5: äº‹ä»¶è™•ç†æ¸¬è©¦ä¸­çš„Mapå­˜å–å•é¡Œä¿®æ­£ âœ… å®Œæˆ

**å•é¡Œ**ï¼šå¹³å°åˆ‡æ›äº‹ä»¶æ¸¬è©¦ä¸­å‡ºç¾ NaNï¼Œé æœŸæ± ä¸­æœ‰é©é…å™¨ä½†å¯¦éš›ç‚º0
**ä¿®æ­£æ–¹æ¡ˆ**ï¼šä¿®æ­£Mapå°è±¡çš„å±¬æ€§å­˜å–å’Œå¹³å°åˆ‡æ›é‚è¼¯

**å¯¦ä½œç´°ç¯€**ï¼š
- **å•é¡Œæ ¹å› **ï¼š
  1. æ¸¬è©¦ä¸­ä½¿ç”¨ `kindlePool.active.length`ï¼Œä½† Map å°è±¡æ²’æœ‰ `length` å±¬æ€§ï¼Œåªæœ‰ `size` å±¬æ€§
  2. `handlePlatformSwitching` åªå‰µå»ºé©é…å™¨ä½†æ²’æœ‰æ¿€æ´»ï¼Œå°è‡´æ–°é©é…å™¨ä¸åœ¨æ± ä¸­
- **è§£æ±ºæ–¹æ¡ˆ**ï¼š
  1. ä¿®æ­£æ¸¬è©¦ï¼šä½¿ç”¨ `kindlePool.active.size` è€Œä¸æ˜¯ `length`
  2. ä¿®æ­£å¹³å°åˆ‡æ›é‚è¼¯ï¼šå‰µå»ºä¸¦æ¿€æ´»æ–°å¹³å°é©é…å™¨
- **ç¨‹å¼ç¢¼ä¿®æ­£**ï¼š
  ```javascript
  // æ¸¬è©¦ä¿®æ­£
  expect(kindlePool.available.length + kindlePool.active.size).toBeGreaterThan(0)
  
  // handlePlatformSwitchingä¿®æ­£ï¼šæ·»åŠ æ¿€æ´»é‚è¼¯
  if (toPlatform) {
    const newAdapter = await this.createAdapter(toPlatform, { preload: true })
    await newAdapter.initialize()
    await newAdapter.activate() // æ–°å¢æ¿€æ´»æ­¥é©Ÿ
  }
  ```
- **æ¸¬è©¦çµæœ**ï¼šå¹³å°åˆ‡æ›æ¸¬è©¦é€šéï¼ŒKINDLEé©é…å™¨æ­£ç¢ºå‰µå»ºä¸¦å­˜åœ¨æ–¼activeæ± ä¸­

## ğŸ‰ ä¿®æ­£å®Œæˆç¸½çµ

**ä¿®æ­£çµæœ**ï¼š
- âœ… **AdapterFactoryServiceæ‰€æœ‰æ¸¬è©¦é€šé** (61/61æ¸¬è©¦)
- âœ… **ä¿®æ­£6å€‹ä¸»è¦å•é¡Œ**ï¼šçµ±è¨ˆè¨ˆç®—ã€è³‡æºæ± åŒ–ã€ç”Ÿå‘½é€±æœŸäº‹ä»¶ã€å¹³å°ç‹€æ…‹ã€Mapå­˜å–ã€å¹³å°åˆ‡æ›é‚è¼¯
- âœ… **ç¨‹å¼ç¢¼å“è³ªæå‡**ï¼šçµ±ä¸€èªç¾©ã€é¿å…é›™é‡è¨ˆæ•¸ã€æ”¹å–„äº‹ä»¶è™•ç†æ©Ÿåˆ¶

**æ¸¬è©¦é€šéç‡**ï¼š100% (å¾6å€‹å¤±æ•—æ¡ˆä¾‹ä¿®æ­£ç‚ºå…¨éƒ¨é€šé)

**æŠ€è¡“å‚µå‹™æ¸…ç†**ï¼š
- çµ±ä¸€äº† `activeInstances` çš„èªç¾©å®šç¾©
- ä¿®æ­£äº†çµ±è¨ˆè¨ˆç®—çš„æ™‚åºå•é¡Œ
- æ”¹å–„äº†å¹³å°åˆ‡æ›çš„å®Œæ•´æ€§
- å¢å¼·äº†è³‡æºæ± åŒ–çš„å¯é æ€§

## ğŸ”§ Contentæ¨¡çµ„åŒ–æ¸¬è©¦ä¿®å¾©è¨˜éŒ„

### å•é¡Œåˆ†æèˆ‡ä¿®å¾©ç­–ç•¥

**èƒŒæ™¯**ï¼šåŸºæ–¼ä½¿ç”¨è€…è¦æ±‚ã€Œåˆ†æä¸»è¦æ˜¯å› ç‚ºJSDOMèˆ‡å¯¦éš›Chrome Extensionç’°å¢ƒçš„å·®ç•°ï¼‰é€™æ˜¯æ¸¬è©¦æ’°å¯«çš„å•é¡Œé‚„æ˜¯æˆ‘å€‘åŸå¸‚æ’°å¯«çš„å•é¡Œï¼Œè¦ä¿®å¾©ã€

#### æ ¹æœ¬åŸå› åˆ†æ âœ… å®Œæˆ

**æ··åˆæ€§å•é¡Œ**ï¼šæ—¢æœ‰æ¸¬è©¦æ’°å¯«å•é¡Œï¼Œä¹Ÿæœ‰ç¨‹å¼ç¢¼è¨­è¨ˆå•é¡Œ

**1. ç¨‹å¼ç¢¼è¨­è¨ˆå•é¡Œ**ï¼š
- **éœæ…‹ç’°å¢ƒç‰©ä»¶å¼•ç”¨**ï¼šæ¨¡çµ„åœ¨è¼‰å…¥æ™‚å°±å¿«å– `location` å’Œ `document`ï¼Œç„¡æ³•é©æ‡‰æ¸¬è©¦ç’°å¢ƒè®Šæ›´
- **ç’°å¢ƒç‰©ä»¶å­˜å–ä¸ä¸€è‡´**ï¼šæ··ç”¨ `window.location`ã€`globalThis.location`ã€`document` ç­‰ä¸åŒå­˜å–æ–¹å¼
- **ç¼ºä¹ç’°å¢ƒé©æ‡‰æ©Ÿåˆ¶**ï¼šæ²’æœ‰å‹•æ…‹å–å¾—ç’°å¢ƒç‰©ä»¶çš„æ©Ÿåˆ¶

**2. æ¸¬è©¦æ’°å¯«å•é¡Œ**ï¼š
- **JSDOMç’°å¢ƒè¨­å®šä¸å®Œæ•´**ï¼šç¼ºå°‘å®Œæ•´çš„Chrome Extensionç’°å¢ƒæ¨¡æ“¬
- **æ¨¡çµ„è¼‰å…¥æ™‚åºéŒ¯èª¤**ï¼šåœ¨ç’°å¢ƒè¨­å®šå®Œæˆå‰å°±è¼‰å…¥æ¨¡çµ„ï¼Œå°è‡´å¿«å–éŒ¯èª¤çš„ç’°å¢ƒç‰©ä»¶
- **Chrome Extension APIæ¨¡æ“¬ä¸è¶³**ï¼šjest-chromeé è¨­è¨­å®šç„¡æ³•æ»¿è¶³æ¸¬è©¦éœ€æ±‚

### ä¿®å¾©å¯¦ä½œè¨˜éŒ„

#### Phase 1: ç¨‹å¼ç¢¼æ¶æ§‹ä¿®å¾© âœ… å®Œæˆ

**1. PageDetector å‹•æ…‹ç’°å¢ƒå­˜å–ä¿®å¾©**ï¼š
```javascript
// ä¿®å¾©å‰ï¼šéœæ…‹å¿«å–å°è‡´æ¸¬è©¦ç’°å¢ƒå•é¡Œ
let isReadmooPage = false
let pageType = 'unknown'

// ä¿®å¾©å¾Œï¼šå‹•æ…‹å–å¾—ç’°å¢ƒç‰©ä»¶
const getLocation = () => globalThis.location || window?.location || {}

detectReadmooPage () {
  const location = getLocation() // æ¯æ¬¡å‘¼å«æ™‚å‹•æ…‹å–å¾—
  isReadmooPage = location.hostname && location.hostname.includes('readmoo.com')
  pageType = isReadmooPage ? this.detectPageType() : 'unknown'
}
```

**2. ReadmooAdapter ç’°å¢ƒé©æ‡‰æ€§å¼·åŒ–**ï¼š
```javascript
// æ·»åŠ ç’°å¢ƒé©æ‡‰åŠ©æ‰‹å‡½æ•¸
const getDocument = () => globalThis.document || window?.document
const getLocation = () => globalThis.location || window?.location || {}

getBookElements () {
  const document = getDocument() // å‹•æ…‹documentå–å¾—
  if (!document) {
    console.warn('âš ï¸ document ç‰©ä»¶ä¸å¯ç”¨')
    return []
  }
  // ç¹¼çºŒåŸ·è¡Œ...
}
```

**3. BookDataExtractor ä¸€è‡´æ€§æ”¹å–„**ï¼š
```javascript
// çµ±ä¸€ç’°å¢ƒç‰©ä»¶å­˜å–æ¨¡å¼
const getDocument = () => globalThis.document || window?.document
const getLocation = () => globalThis.location || window?.location || {}
```

#### Phase 2: æ¸¬è©¦ç’°å¢ƒå¼·åŒ– âœ… å®Œæˆ

**1. JSDOMç’°å¢ƒå®Œæ•´è¨­å®š**ï¼š
```javascript
beforeEach(() => {
  // å®Œæ•´Chrome Extensionç’°å¢ƒæ¨¡æ“¬
  global.location = new URL('https://readmoo.com/library')
  global.document = new JSDOM(`
    <html><head></head><body>
      <div class="book-item" data-book-id="123">æ›¸ç±1</div>
      <div class="book-item" data-book-id="456">æ›¸ç±2</div>
    </body></html>
  `).window.document

  globalThis.location = global.location
  globalThis.document = global.document
})
```

**2. Chrome Extension API å¼·åŒ–æ¨¡æ“¬**ï¼š
```javascript
global.chrome.runtime.sendMessage.mockImplementation((message, callback) => {
  const response = { success: true }
  if (callback) {
    setTimeout(() => callback(response), 0)
  }
  return Promise.resolve(response)
})
```

**3. æ¨¡çµ„è¼‰å…¥ç­–ç•¥èª¿æ•´**ï¼š
```javascript
// ä¿®å¾©å‰ï¼šåœ¨describeéšæ®µè¼‰å…¥ï¼Œç’°å¢ƒå°šæœªè¨­å®š
const createPageDetector = require('../../../../src/content/detectors/page-detector')

// ä¿®å¾©å¾Œï¼šåœ¨æ¸¬è©¦æ–¹æ³•å…§å‹•æ…‹è¼‰å…¥
it('æ‡‰è©²æ­£ç¢ºæª¢æ¸¬ Readmoo é é¢', () => {
  const createPageDetector = require('../../../../src/content/detectors/page-detector')
  const pageDetector = createPageDetector()
  // æ¸¬è©¦é‚è¼¯...
})
```

#### Phase 3: æœ€çµ‚ç’°å¢ƒç‰©ä»¶å¼·åˆ¶è¨­å®š âœ… å®Œæˆ

**JSDOM locationè¦†è“‹å•é¡Œè§£æ±º**ï¼š
```javascript
// å¼·åˆ¶è¨­ç½® location - ç¢ºä¿ä¸è¢«è¦†è“‹
Object.defineProperty(globalThis, 'location', {
  value: global.location,
  writable: true,
  configurable: true
})
```

**åµéŒ¯é©—è­‰æ©Ÿåˆ¶**ï¼š
```javascript
// PageDetectorä¸­æ·»åŠ è©³ç´°åµéŒ¯è³‡è¨Š
const locationInfo = { 
  hostname: location.hostname, 
  href: location.href,
  origin: location.origin,
  globalThis: globalThis.location ? 'exists' : 'missing',
  window: (window?.location) ? 'exists' : 'missing'
}
console.log('Debug - PageDetector location:', locationInfo)
```

### ä¿®å¾©æˆæœé©—è­‰ âœ… å®Œæˆ

**æ¸¬è©¦é€šéçµæœ**ï¼š
- âœ… content-modular.test.js å®Œå…¨é€šé
- âœ… PageDetector æ­£ç¢ºæª¢æ¸¬ readmoo.com é é¢
- âœ… ReadmooAdapter æ­£ç¢ºå–å¾— document å’Œæ›¸ç±å…ƒç´   
- âœ… BookDataExtractor æ­£ç¢ºåˆ¤æ–·é é¢é¡å‹å’Œå¯æå–æ€§
- âœ… æ‰€æœ‰ç’°å¢ƒé©æ‡‰æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ

**ä¿®å¾©æ•ˆæœåˆ†æ**ï¼š
1. **ç¨‹å¼ç¢¼å“è³ªæå‡**ï¼šå¯¦ä½œçµ±ä¸€çš„ç’°å¢ƒç‰©ä»¶å­˜å–æ¨¡å¼ï¼Œæå‡ç¶­è­·æ€§
2. **æ¸¬è©¦ç©©å®šæ€§æ”¹å–„**ï¼šå¾¹åº•è§£æ±ºJSDOMç’°å¢ƒç›¸å®¹æ€§å•é¡Œ
3. **æ¶æ§‹å¥å£¯æ€§å¢å¼·**ï¼šæ¨¡çµ„å…·å‚™å¤šç’°å¢ƒé©æ‡‰èƒ½åŠ›

**å­¸ç¿’æˆæœè¨˜éŒ„**ï¼š
1. **JSDOMé™åˆ¶æ·±åº¦ç†è§£**ï¼šlocationç‰©ä»¶ç„¡æ³•ç›´æ¥æ›¿æ›ï¼Œéœ€ä½¿ç”¨Object.defineProperty
2. **æ¨¡çµ„è¼‰å…¥æ™‚åºé‡è¦æ€§**ï¼šç’°å¢ƒä¾è³´æ¨¡çµ„å¿…é ˆåœ¨ç’°å¢ƒè¨­å®šå®Œæˆå¾Œè¼‰å…¥
3. **Chrome Extensionæ¸¬è©¦ç­–ç•¥**ï¼šéœ€å®Œæ•´æ¨¡æ“¬é‹è¡Œç’°å¢ƒï¼Œä¸èƒ½ä¾è³´é è¨­jest-chromeè¨­å®š

## ğŸ“Š æ•´é«”æ¸¬è©¦ç‹€æ³è©•ä¼°èˆ‡ä¸‹ä¸€æ­¥è¦åŠƒ

### ç•¶å‰æ¸¬è©¦ç‹€æ³åˆ†æ âœ… å®Œæˆ

**ä¿®å¾©æˆæœç¢ºèª**ï¼š
- âœ… **Contentæ¨¡çµ„åŒ–æ¸¬è©¦**ï¼šcontent-modular.test.js å®Œå…¨é€šé
- âœ… **JSDOMç’°å¢ƒç›¸å®¹æ€§**ï¼šæˆåŠŸè§£æ±ºChrome Extensionç’°å¢ƒå·®ç•°å•é¡Œ
- âœ… **å‹•æ…‹ç’°å¢ƒé©æ‡‰**ï¼šæ‰€æœ‰Contentæ¨¡çµ„ç¾æ”¯æ´å¤šç’°å¢ƒé‹è¡Œ

**å‰©é¤˜æ¸¬è©¦å¤±æ•—åˆ†æ**ï¼š

**1. äº‹ä»¶ç³»çµ±v2.0æ ¸å¿ƒæ•´åˆæ¸¬è©¦**ï¼š1å€‹å¤±æ•—
- **å•é¡Œæª”æ¡ˆ**ï¼š`tests/integration/event-system-v2-core-integration.test.js`
- **å¤±æ•—æ¸¬è©¦**ï¼š`æ‡‰è©²å„ªé›…è™•ç†ç„¡æ•ˆäº‹ä»¶æ ¼å¼`
- **éŒ¯èª¤åŸå› **ï¼šEventPriorityManager.assignEventPriority() æ‹‹å‡º "Invalid event name" ç•°å¸¸
- **æœŸå¾…è¡Œç‚º**ï¼šæ‡‰è©²å„ªé›…è™•ç†ï¼Œä¸æ‹‹å‡ºç•°å¸¸
- **å½±éŸ¿ç¯„åœ**ï¼šå–®ä¸€æ•´åˆæ¸¬è©¦å¤±æ•—
- **ä¿®å¾©è¤‡é›œåº¦**ï¼šä½ï¼ˆéŒ¯èª¤è™•ç†é‚è¼¯èª¿æ•´ï¼‰

**2. Background Service Workeräº‹ä»¶ç³»çµ±**ï¼š7å€‹å¤±æ•—
- **å•é¡Œæª”æ¡ˆ**ï¼š`tests/integration/chrome-extension/background-event-system.test.js`
- **ä¸»è¦å•é¡Œ**ï¼š
  - Service Workerå•Ÿå‹•æ™‚EventBuså¯¦ä¾‹æœªæ­£ç¢ºå»ºç«‹ï¼š`global.eventBus` ç‚º undefined
  - ChromeEventBridgeè¼‰å…¥å’Œåˆå§‹åŒ–å•é¡Œ
  - äº‹ä»¶ç³»çµ±åˆå§‹åŒ–é †åºå•é¡Œ
  - Service Workerç”Ÿå‘½é€±æœŸç›¸å®¹æ€§å•é¡Œ
- **å½±éŸ¿ç¯„åœ**ï¼š7å€‹æ•´åˆæ¸¬è©¦å¤±æ•—
- **ä¿®å¾©è¤‡é›œåº¦**ï¼šä¸­ç­‰ï¼ˆæ¶‰åŠåˆå§‹åŒ–é †åºã€æ¨¡çµ„è¼‰å…¥ã€Service Workerç’°å¢ƒï¼‰

### ä¿®å¾©å„ªå…ˆç´šæ±ºç­– ğŸ“‹

åŸºæ–¼ã€Œæ¸¬è©¦é€šéç‡éµå¾‹ã€å’Œã€Œæ°¸ä¸æ”¾æ£„åŸå‰‡ã€ï¼š

**Phase 1: EventPriorityManageréŒ¯èª¤è™•ç†ä¿®å¾©ï¼ˆé«˜å„ªå…ˆç´šï¼‰**
- **ç†ç”±**ï¼šå½±éŸ¿ç¯„åœå°ã€ä¿®å¾©è¤‡é›œåº¦ä½ã€å¿«é€Ÿå‹åˆ©
- **é æœŸä¿®å¾©æ™‚é–“**ï¼šçŸ­ï¼ˆ15-30åˆ†é˜ï¼‰
- **ä¿®å¾©ç­–ç•¥**ï¼šèª¿æ•´éŒ¯èª¤è™•ç†é‚è¼¯ï¼Œç¢ºä¿å„ªé›…è™•ç†ç„¡æ•ˆäº‹ä»¶åç¨±

**Phase 2: Background Service Workeräº‹ä»¶ç³»çµ±ä¿®å¾©ï¼ˆä¸­å„ªå…ˆç´šï¼‰**
- **ç†ç”±**ï¼šå½±éŸ¿ç¯„åœè¼ƒå¤§ã€ä¿®å¾©è¤‡é›œåº¦ä¸­ç­‰
- **é æœŸä¿®å¾©æ™‚é–“**ï¼šä¸­ç­‰ï¼ˆ1-2å°æ™‚ï¼‰
- **ä¿®å¾©ç­–ç•¥**ï¼š
  1. ä¿®å¾©Service Workerç’°å¢ƒä¸­çš„EventBusåˆå§‹åŒ–
  2. è§£æ±ºChromeEventBridgeè¼‰å…¥å•é¡Œ
  3. èª¿æ•´äº‹ä»¶ç³»çµ±åˆå§‹åŒ–é †åº
  4. å®Œå–„Service Workerç”Ÿå‘½é€±æœŸè™•ç†

### æŠ€è¡“å‚µå‹™é˜²ç¯„æ©Ÿåˆ¶ ğŸ›¡ï¸

**ç‚ºé˜²æ­¢é¡ä¼¼å•é¡Œå†æ¬¡ç™¼ç”Ÿ**ï¼š
1. **ç’°å¢ƒé©æ‡‰æ€§æ¨¡å¼**ï¼šå·²å»ºç«‹å‹•æ…‹ç’°å¢ƒç‰©ä»¶å­˜å–æ¨¡å¼ï¼Œæœªä¾†æ¨¡çµ„éƒ½æ‡‰éµå¾ª
2. **æ¸¬è©¦ç’°å¢ƒæ¨™æº–åŒ–**ï¼šå»ºç«‹JSDOMç’°å¢ƒè¨­å®šæœ€ä½³å¯¦è¸æ¨¡æ¿
3. **éŒ¯èª¤è™•ç†ä¸€è‡´æ€§**ï¼šéœ€å»ºç«‹çµ±ä¸€çš„éŒ¯èª¤è™•ç†ç­–ç•¥ï¼Œé¿å…å„ªé›…è™•ç†ä¸ä¸€è‡´å•é¡Œ

## ğŸ¯ EventPriorityManageréŒ¯èª¤è™•ç†ä¿®å¾©è¨˜éŒ„

### Phase 1 ä¿®å¾©å¯¦ä½œ âœ… å®Œæˆ

**å•é¡Œåˆ†æ**ï¼š
- **æ¸¬è©¦æª”æ¡ˆ**ï¼š`tests/integration/event-system-v2-core-integration.test.js:686`
- **å¤±æ•—æ¸¬è©¦**ï¼š`æ‡‰è©²å„ªé›…è™•ç†ç„¡æ•ˆäº‹ä»¶æ ¼å¼`
- **éŒ¯èª¤åŸå› **ï¼šEventPriorityManager.assignEventPriority() å°ç„¡æ•ˆäº‹ä»¶åç¨±æ‹‹å‡ºç•°å¸¸
- **æœŸå¾…è¡Œç‚º**ï¼š`expect(...).not.toThrow()` - æ‡‰è©²å„ªé›…è™•ç†ï¼Œä¸æ‹‹å‡ºç•°å¸¸

**ä¿®å¾©ç­–ç•¥**ï¼š
```javascript
// ä¿®å¾©å‰ï¼šç¡¬æ€§æ‹‹å‡ºç•°å¸¸
if (!eventName || typeof eventName !== 'string') {
  this.priorityStats.errors++
  const endTime = performance.now()
  this.updateAssignmentTime(endTime - startTime)
  throw new Error('Invalid event name') // âŒ æ‹‹å‡ºç•°å¸¸
}

// ä¿®å¾©å¾Œï¼šå„ªé›…è™•ç†
if (!eventName || typeof eventName !== 'string') {
  this.priorityStats.errors++
  const endTime = performance.now()
  this.updateAssignmentTime(endTime - startTime)
  // âœ… å„ªé›…è™•ç†ï¼šè¿”å›æœ€ä½å„ªå…ˆç´šè€Œéæ‹‹å‡ºç•°å¸¸
  console.warn(`EventPriorityManager: Invalid event name "${eventName}", assigning lowest priority`)
  return 999 // æœ€ä½å„ªå…ˆç´š
}
```

**ä¿®å¾©æˆæœ**ï¼š
- âœ… **æ¸¬è©¦é€šé**ï¼š`æ‡‰è©²å„ªé›…è™•ç†ç„¡æ•ˆäº‹ä»¶æ ¼å¼ (58 ms)` 
- âœ… **å„ªé›…éŒ¯èª¤è™•ç†**ï¼šç„¡æ•ˆäº‹ä»¶åç¨±è¿”å›æœ€ä½å„ªå…ˆç´š(999)è€Œéæ‹‹å‡ºç•°å¸¸
- âœ… **çµ±è¨ˆç¶­è­·**ï¼šéŒ¯èª¤çµ±è¨ˆå’Œæ•ˆèƒ½è¨˜éŒ„æ­£å¸¸ç¶­è­·
- âœ… **æ—¥èªŒè¨˜éŒ„**ï¼šæ·»åŠ è­¦å‘Šæ—¥èªŒè¨˜éŒ„å•é¡Œäº‹ä»¶

**æŠ€è¡“æ”¹å–„**ï¼š
1. **éŒ¯èª¤è™•ç†ä¸€è‡´æ€§**ï¼šå»ºç«‹å„ªé›…éŒ¯èª¤è™•ç†æ¨¡å¼ï¼Œé¿å…ä¸å¿…è¦çš„ç•°å¸¸æ‹‹å‡º
2. **é˜²ç¦¦æ€§ç¨‹å¼è¨­è¨ˆ**ï¼šå°ç„¡æ•ˆè¼¸å…¥æä¾›åˆç†çš„é è¨­å€¼è™•ç†
3. **å¯è§€æ¸¬æ€§æ”¹å–„**ï¼šé€šéè­¦å‘Šæ—¥èªŒæä¾›å•é¡Œè¨ºæ–·è³‡è¨Š

### ç›®å‰ä¿®å¾©ç‹€æ³ç¸½çµ ğŸ“Š

**âœ… å·²ä¿®å¾©å®Œæˆ**ï¼š
1. **Contentæ¨¡çµ„åŒ–æ¸¬è©¦**ï¼šcontent-modular.test.js (JSDOMç’°å¢ƒç›¸å®¹æ€§)
2. **EventPriorityManageréŒ¯èª¤è™•ç†**ï¼ševent-system-v2-core-integration.test.js (å„ªé›…éŒ¯èª¤è™•ç†)

**â³ å¾…ä¿®å¾©é …ç›®**ï¼š
- **Background Service Workeräº‹ä»¶ç³»çµ±**ï¼š7å€‹æ¸¬è©¦å¤±æ•—ï¼Œä¸­ç­‰è¤‡é›œåº¦
