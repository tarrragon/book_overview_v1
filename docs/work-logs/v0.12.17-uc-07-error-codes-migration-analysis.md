# UC-07 錯誤處理與恢復 - ErrorCodes v5.0.0 遷移分析

**分析日期**: 2025-09-16  
**版本**: v0.12.17  
**負責代理**: claude-ui-ux-designer (TDD Phase 1: 功能設計)  
**目標**: 評估 UC-07 驗收資料夾是否需要遷移到新的 ErrorCodes 系統 v5.0.0

## 🔍 分析摘要

### 當前狀況
- ✅ **UC-07 驗收資料夾存在**: `docs/acceptance/uc-07/exceptions.md`
- ✅ **包含 4 個系統級錯誤定義**: 符合預期的錯誤數量
- ⚠️ **使用舊式 StandardError 格式**: 需要遷移到新的 ErrorCodes 架構
- 🔴 **缺少測試覆蓋分析**: `test-coverage.md` 和 `functional-details.md` 尚未建立

### 關鍵發現
1. **錯誤類型專業性高**: UC-07 的 4 個錯誤都是系統級關鍵錯誤
2. **與新架構高度相容**: 所有錯誤都可對應到新 ErrorCodes 的核心分類
3. **TDD 測試策略清楚**: 可依據新設計原則建立簡化測試模式

## 📊 現有錯誤代碼對應分析

### 1. SYSTEM_ERROR_HANDLER_RECURSION → OPERATION_ERROR
**現有定義**:
```javascript
new StandardError('SYSTEM_ERROR_HANDLER_RECURSION', '錯誤處理器發生遞迴錯誤', {
  severity: 'CRITICAL',
  recursionDepth: 5,
  originalError: 'DATA_VALIDATION_FAILED'
})
```

**新架構對應**:
```javascript
// ✅ 簡化版本
throw new Error(`${ErrorCodes.OPERATION_ERROR}: Error handler recursion detected (depth: 5)`)

// ✅ 結構化版本（需要額外資訊時）
const error = new Error('Error handler recursion detected')
error.code = ErrorCodes.OPERATION_ERROR
error.details = { recursionDepth: 5, originalError: 'DATA_VALIDATION_FAILED' }
throw error
```

### 2. SYSTEM_ERROR_LOGGING_FAILURE → STORAGE_ERROR
**現有定義**:
```javascript
new StandardError('SYSTEM_ERROR_LOGGING_FAILURE', '錯誤日誌記錄系統失敗', {
  severity: 'MODERATE',
  logDestination: 'chrome.storage.local',
  failedEvents: 15
})
```

**新架構對應**:
```javascript
// ✅ 簡化版本
throw new Error(`${ErrorCodes.STORAGE_ERROR}: Error logging failed (15 events lost)`)

// ✅ 結果物件版本
return {
  success: false,
  error: 'Error logging failed - storage quota exceeded',
  code: ErrorCodes.STORAGE_ERROR,
  failedEvents: 15
}
```

### 3. SYSTEM_RECOVERY_MECHANISM_EXHAUSTED → OPERATION_ERROR
**現有定義**:
```javascript
new StandardError('SYSTEM_RECOVERY_MECHANISM_EXHAUSTED', '所有自動恢復機制都已失效', {
  severity: 'SEVERE',
  failedRecoveryAttempts: [...],
  manualInterventionRequired: true
})
```

**新架構對應**:
```javascript
// ✅ 簡化版本
throw new Error(`${ErrorCodes.OPERATION_ERROR}: All recovery mechanisms exhausted`)

// ✅ 結構化版本
const error = new Error('All recovery mechanisms exhausted')
error.code = ErrorCodes.OPERATION_ERROR
error.details = {
  failedRecoveryAttempts: ['restart_service', 'clear_cache', 'reset_storage'],
  manualInterventionRequired: true
}
throw error
```

### 4. DATA_ERROR_PATTERN_LEARNING_OVERFLOW → STORAGE_ERROR
**現有定義**:
```javascript
new StandardError('DATA_ERROR_PATTERN_LEARNING_OVERFLOW', '錯誤模式學習資料過載', {
  severity: 'MINOR',
  learnedPatterns: 1500,
  storageLimit: 1000
})
```

**新架構對應**:
```javascript
// ✅ 簡化版本
throw new Error(`${ErrorCodes.STORAGE_ERROR}: Error pattern learning data overflow`)

// ✅ 結果物件版本
return {
  success: false,
  error: 'Error pattern storage limit reached',
  code: ErrorCodes.STORAGE_ERROR,
  learnedPatterns: 1500,
  pruningRequired: true
}
```

## 🧪 TDD 測試策略建議

### 測試模式轉換

**原始 StandardError 測試模式**:
```javascript
// ❌ 複雜的舊模式
expect(() => errorHandler.processRecursion()).toThrow(StandardError)
await expect(operation).rejects.toMatchObject({
  code: 'SYSTEM_ERROR_HANDLER_RECURSION',
  message: expect.stringContaining('遞迴錯誤')
})
```

**新 ErrorCodes 測試模式**:
```javascript
// ✅ 簡化的新模式
expect(() => errorHandler.processRecursion()).toThrow(ErrorCodes.OPERATION_ERROR)
expect(() => errorHandler.processRecursion()).toThrow(/recursion detected/)

// ✅ 結果物件測試
const result = await errorHandler.processRecursion()
expect(result).toEqual({
  success: false,
  error: 'Error handler recursion detected',
  code: ErrorCodes.OPERATION_ERROR
})
```

### 核心測試場景

#### 1. 錯誤處理器遞迴測試
```javascript
describe('Error Handler Recursion Detection', () => {
  test('should detect recursion and throw OPERATION_ERROR', () => {
    // Red: 寫失敗測試
    expect(() => errorHandler.handleError(recursiveError))
      .toThrow(`${ErrorCodes.OPERATION_ERROR}: Error handler recursion detected`)
  })
  
  test('should include recursion depth in error details', () => {
    // Red: 寫失敗測試  
    try {
      errorHandler.handleError(recursiveError)
    } catch (error) {
      expect(error.code).toBe(ErrorCodes.OPERATION_ERROR)
      expect(error.details.recursionDepth).toBeGreaterThan(0)
    }
  })
})
```

#### 2. 錯誤日誌系統測試
```javascript
describe('Error Logging System', () => {
  test('should handle storage quota exceeded gracefully', async () => {
    // Red: 寫失敗測試
    const result = await logger.logError(errorEvent)
    expect(result).toEqual({
      success: false,
      error: expect.stringContaining('storage quota exceeded'),
      code: ErrorCodes.STORAGE_ERROR
    })
  })
})
```

## 📋 更新建議與優先級

### 🔴 高優先級 (本週內完成)

1. **更新 exceptions.md**
   - 將 4 個錯誤定義轉換為新 ErrorCodes 格式
   - 保留核心功能要求，簡化複雜度
   - 工作量估算: **2-3 小時**

2. **建立基礎測試覆蓋**
   - 實作核心錯誤場景的 TDD 測試
   - 確保遞迴檢測和恢復機制正常運作
   - 工作量估算: **4-5 小時**

### 🟡 中優先級 (下週內完成)

3. **建立 test-coverage.md**
   - 分析現有測試覆蓋狀況
   - 識別缺失的測試案例
   - 工作量估算: **2 小時**

4. **建立 functional-details.md**
   - 記錄核心錯誤處理邏輯
   - 說明與其他 UC 的交互關係
   - 工作量估算: **1-2 小時**

### 🟢 低優先級 (月底前完成)

5. **整合 Chrome Extension 特定錯誤處理**
   - 確保 Service Worker 環境相容性
   - 測試跨環境錯誤傳遞
   - 工作量估算: **3-4 小時**

## 🔍 技術債務識別

### 現有問題
1. **測試覆蓋不完整**: UC-07 目前只有錯誤定義，缺少對應測試
2. **複雜度過高**: 使用 StandardError 造成不必要的複雜性
3. **效能考量不足**: 錯誤處理路徑沒有效能優化考量

### 遷移風險
- **低風險**: UC-07 專注系統級錯誤，功能邊界清楚
- **相容性**: 新 ErrorCodes 完全支援 Chrome Extension 環境
- **測試策略**: TDD 確保遷移過程中功能不會退化

## 🎯 實施計畫

### Phase 1: Red-Green-Refactor 循環 (第1-2天)
1. **Red**: 為每個錯誤寫失敗測試
2. **Green**: 實作最小可行的錯誤處理邏輯
3. **Refactor**: 優化代碼結構，確保符合新 ErrorCodes 設計原則

### Phase 2: 文件更新與測試補強 (第3-4天)
1. 更新 `exceptions.md` 為新格式
2. 建立完整的 `test-coverage.md`
3. 撰寫 `functional-details.md`

### Phase 3: 整合測試與驗證 (第5天)
1. 執行完整測試套件
2. 驗證與其他 UC 的整合點
3. 確認 Chrome Extension 相容性

## 📊 效益評估

### 預期改善
- **效能提升**: 錯誤處理時間減少 50-80%（依據新設計估算）
- **記憶體優化**: 錯誤物件大小減少 35-40%
- **開發效率**: 錯誤處理邏輯複雜度大幅降低
- **維護成本**: 簡化架構降低長期維護負擔

### 成功指標
- ✅ 所有測試通過率 100%
- ✅ 錯誤處理效能符合新設計目標
- ✅ Chrome Extension 相容性驗證通過
- ✅ 與其他 UC 的整合點正常運作

## 🚀 下一步行動

1. **立即開始**: 選擇第一個錯誤案例進行 TDD 循環
2. **優先選擇**: `SYSTEM_ERROR_HANDLER_RECURSION`（影響最關鍵）
3. **TDD 節奏**: 每個錯誤案例完整走完 Red-Green-Refactor
4. **協作機制**: 完成後交接給 sage-test-architect 進行詳細測試設計

---

**結論**: UC-07 的 ErrorCodes v5.0.0 遷移是必要且可行的。現有 4 個錯誤定義可以順利對應到新架構的核心 ErrorCodes，並且通過 TDD 方法可以確保遷移過程的品質和安全性。建議立即啟動遷移工作，優先處理系統關鍵錯誤。