const { ErrorCodes } = require('src/core/errors/ErrorCodes')
/**
 * E2E Test Data Generator
 * ç”¢ç”Ÿç«¯åˆ°ç«¯æ¸¬è©¦æ‰€éœ€çš„å„ç¨®æ¸¬è©¦è³‡æ–™å’Œæ¸¬è©¦å ´æ™¯é…ç½®
 *
 * ä¸»è¦åŠŸèƒ½ï¼š
 * - ç”Ÿæˆå„ç¨®é¡å‹çš„æ›¸ç±æ¸¬è©¦è³‡æ–™
 * - å»ºç«‹ä¸åŒçš„æ¸¬è©¦å ´æ™¯é…ç½®
 * - æä¾›æ•ˆèƒ½æ¸¬è©¦è³‡æ–™é›†
 * - ç”Ÿæˆé‚Šç•Œæ¢ä»¶å’Œç•°å¸¸æƒ…æ³è³‡æ–™
 *
 * @author TDD Phase 2 - sage-test-architect
 * @date 2025-08-25
 * @version v0.9.38
 */

class E2ETestDataGenerator {
  constructor () {
    this.dataCache = new Map()
    this.scenarioTemplates = new Map()
    this.bookTemplates = {
      normal: [],
      edgeCase: [],
      performance: [],
      error: []
    }

    // åˆå§‹åŒ–åŸºæœ¬è³‡æ–™æ¨¡æ¿
    this.initializeTemplates()
  }

  /**
   * åˆå§‹åŒ–è³‡æ–™æ¨¡æ¿
   * @private
   */
  initializeTemplates () {
    this.setupBookTemplates()
    this.setupScenarioTemplates()
  }

  /**
   * è¨­ç½®æ›¸ç±è³‡æ–™æ¨¡æ¿
   * @private
   */
  setupBookTemplates () {
    // æ­£å¸¸æ›¸ç±æ¨¡æ¿
    this.bookTemplates.normal = [
      {
        title: 'æ­£å¸¸æ›¸ç±æ¨™é¡Œ',
        author: 'ä½œè€…å§“å',
        progress: 75,
        status: 'é–±è®€ä¸­',
        category: 'æ–‡å­¸å°èªª'
      },
      {
        title: 'ç§‘æŠ€è¶¨å‹¢åˆ†æ',
        author: 'ç§‘æŠ€å°ˆå®¶',
        progress: 45,
        status: 'é–±è®€ä¸­',
        category: 'å•†æ¥­ç®¡ç†'
      },
      {
        title: 'æ­·å²å›é¡§',
        author: 'æ­·å²å­¸è€…',
        progress: 100,
        status: 'å·²å®Œæˆ',
        category: 'äººæ–‡æ­·å²'
      }
    ]

    // é‚Šç•Œæ¢ä»¶æ¨¡æ¿
    this.bookTemplates.edgeCase = [
      {
        title: 'ğŸ“š é€™æ˜¯åŒ…å«emojiçš„è¶…ç´šé•·æ›¸ç±æ¨™é¡Œæ¸¬è©¦ç”¨æ›¸ç± ğŸŒŸ ç”¨æ–¼æ¸¬è©¦å„ç¨®ç‰¹æ®Šæƒ…æ³è™•ç† ğŸ“–',
        author: 'ç‰¹æ®Šå­—ç¬¦ä½œè€…åç¨± <>&"\'',
        progress: 0,
        status: 'æœªé–‹å§‹',
        category: 'æ¸¬è©¦é¡åˆ¥'
      },
      {
        title: '', // ç©ºæ¨™é¡Œ
        author: '',
        progress: null,
        status: undefined,
        category: null
      },
      {
        title: 'è¶…ç´šé•·æ¨™é¡Œ'.repeat(50),
        author: 'è¶…ç´šé•·ä½œè€…åç¨±'.repeat(20),
        progress: 101, // è¶…å‡ºç¯„åœ
        status: 'ç•°å¸¸ç‹€æ…‹',
        category: 'ç•°å¸¸é¡åˆ¥'
      }
    ]

    // æ•ˆèƒ½æ¸¬è©¦æ¨¡æ¿
    this.bookTemplates.performance = [
      {
        title: 'æ•ˆèƒ½æ¸¬è©¦æ›¸ç±',
        author: 'æ•ˆèƒ½ä½œè€…',
        progress: 50,
        status: 'é–±è®€ä¸­',
        category: 'æ•ˆèƒ½æ¸¬è©¦'
      }
    ]
  }

  /**
   * è¨­ç½®æ¸¬è©¦å ´æ™¯æ¨¡æ¿
   * @private
   */
  setupScenarioTemplates () {
    // æ­£å¸¸å·¥ä½œæµç¨‹å ´æ™¯
    this.scenarioTemplates.set('normalWorkflow', {
      type: 'normal',
      pageContext: {
        url: 'https://readmoo.com/shelf',
        bookCount: 15,
        userLoggedIn: true,
        pageLoaded: true
      },
      extensionContext: {
        installed: true,
        permissions: ['storage', 'activeTab'],
        version: '1.0.0'
      },
      expectedResults: {
        success: true,
        extractionTime: 3000,
        memoryUsage: process.memoryUsage().heapUsed // Real memory usage in bytes
      }
    })

    // äº‹ä»¶åºåˆ—æ¸¬è©¦å ´æ™¯
    this.scenarioTemplates.set('eventSequence', {
      type: 'eventTest',
      expectedEvents: [
        'POPUP.OPENED',
        'EXTRACTOR.REQUEST.STARTED',
        'CONTENT_SCRIPT.INJECTION.COMPLETED',
        'EXTRACTOR.PROGRESS.UPDATED',
        'EXTRACTOR.DATA.EXTRACTED',
        'STORAGE.SAVE.COMPLETED',
        'UI.SUCCESS.DISPLAYED'
      ]
    })

    // éŒ¯èª¤è™•ç†å ´æ™¯
    this.scenarioTemplates.set('errorHandling', {
      type: 'error',
      errorType: 'permissionDenied',
      expectedBehavior: 'gracefulFailure'
    })
  }

  /**
   * ç”Ÿæˆæ¸¬è©¦æ›¸ç±é›†åˆ
   * @param {DataGenerationConfig} config - ç”Ÿæˆé…ç½®
   * @returns {BookCollection} æ¸¬è©¦æ›¸ç±è³‡æ–™
   */
  generateBookCollection (config = {}) {
    const {
      count = 10,
      type = 'normal',
      includeEdgeCases = false,
      seed = Date.now()
    } = config

    // ä½¿ç”¨ç¨®å­ç¢ºä¿æ¸¬è©¦å¯é‡ç¾
    this.setSeed(seed)

    const books = []
    const template = this.bookTemplates[type] || this.bookTemplates.normal

    for (let i = 0; i < count; i++) {
      const baseTemplate = template[i % template.length]
      const book = this.generateSingleBook(baseTemplate, i)
      books.push(book)
    }

    // å¦‚æœéœ€è¦é‚Šç•Œæ¢ä»¶ï¼Œæ·»åŠ ç‰¹æ®Šæ›¸ç±
    if (includeEdgeCases) {
      const edgeCaseBooks = this.generateEdgeCaseBooks()
      books.push(...edgeCaseBooks)
    }

    // å¿«å–ç”Ÿæˆçš„è³‡æ–™
    const cacheKey = `books_${type}_${count}_${includeEdgeCases}`
    this.dataCache.set(cacheKey, books)

    return books
  }

  /**
   * ç”Ÿæˆå–®ä¸€æ›¸ç±è³‡æ–™
   * @param {Object} template - æ›¸ç±æ¨¡æ¿
   * @param {number} index - ç´¢å¼•
   * @returns {Object} æ›¸ç±è³‡æ–™
   * @private
   */
  generateSingleBook (template, index) {
    return {
      id: `stable-book-id-${index + 1}`,
      title: template.title || `æ¸¬è©¦æ›¸ç± ${index + 1}`,
      author: template.author || `ä½œè€… ${index + 1}`,
      cover: `https://example.com/cover-${index + 1}.jpg`,
      progress: template.progress !== undefined ? template.progress : this.randomInt(0, 100),
      status: template.status || (template.progress > 0 ? 'é–±è®€ä¸­' : 'æœªé–‹å§‹'),
      isbn: `978-986-${String(index + 1).padStart(7, '0')}`,
      publisher: template.publisher || `å‡ºç‰ˆç¤¾ ${index + 1}`,
      publishDate: template.publishDate || `2023-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-01`,
      category: template.category || 'ä¸€èˆ¬æ›¸ç±',
      description: template.description || `é€™æ˜¯æ¸¬è©¦æ›¸ç± ${index + 1} çš„æè¿°`,
      rating: this.randomInt(1, 5),
      pageCount: this.randomInt(100, 500),
      // æ¸¬è©¦ç”¨å±¬æ€§
      _testMetadata: {
        generatedAt: Date.now(),
        templateType: template._type || 'normal',
        index
      }
    }
  }

  /**
   * ç”Ÿæˆé‚Šç•Œæ¢ä»¶æ›¸ç±
   * @returns {Array} é‚Šç•Œæ¢ä»¶æ›¸ç±è³‡æ–™
   * @private
   */
  generateEdgeCaseBooks () {
    const edgeCases = [
      // Unicodeå’Œemojiæ›¸ç±
      {
        id: 'unicode-book',
        title: 'ğŸ“š Unicodeæ¸¬è©¦æ›¸ç± ğŸŒŸ åŒ…å«å„ç¨®ç‰¹æ®Šå­—ç¬¦ï¼šä¸­æ–‡ã€æ—¥æ–‡ã€éŸ“æ–‡ã€é˜¿æ‹‰ä¼¯æ–‡',
        author: 'Unicodeä½œè€… ğŸ‘¤',
        progress: 50
      },
      // é•·æ¨™é¡Œæ›¸ç±
      {
        id: 'long-title-book',
        title: 'é€™æ˜¯ä¸€å€‹éå¸¸éå¸¸é•·çš„æ›¸ç±æ¨™é¡Œï¼Œç”¨ä¾†æ¸¬è©¦ç³»çµ±å°è¶…é•·æ¨™é¡Œçš„è™•ç†èƒ½åŠ›ï¼ŒåŒ…å«å¤šç¨®æ–‡å­—å’Œæ¨™é»ç¬¦è™Ÿï¼Œä»¥åŠæ•¸å­—1234567890'.repeat(3),
        author: 'é•·åç¨±ä½œè€…'.repeat(10),
        progress: 25
      },
      // ç©ºå€¼å’Œnullå€¼æ›¸ç±
      {
        id: 'null-values-book',
        title: '',
        author: null,
        progress: null,
        cover: null,
        status: undefined
      },
      // ç‰¹æ®Šå­—ç¬¦æ›¸ç±
      {
        id: 'special-chars-book',
        title: 'ç‰¹æ®Šå­—ç¬¦æ¸¬è©¦ï¼š<>&"\'`~!@#$%^&*()_+-={}[]|\\:";\'<>?,./',
        author: 'HTML & XML ä½œè€…',
        progress: 75
      },
      // æ¥µç«¯æ•¸å€¼æ›¸ç±
      {
        id: 'extreme-values-book',
        title: 'æ¥µç«¯æ•¸å€¼æ¸¬è©¦',
        author: 'æ¥µç«¯ä½œè€…',
        progress: -1, // è² æ•¸
        rating: 10, // è¶…å‡ºç¯„åœ
        pageCount: 0 // é›¶é 
      }
    ]

    return edgeCases
  }

  /**
   * ç”Ÿæˆæ··åˆæ›¸ç±é›†åˆ
   * @param {Array} mixConfig - æ··åˆé…ç½®
   * @returns {Array} æ··åˆæ›¸ç±è³‡æ–™
   */
  generateMixedBookCollection (mixConfig) {
    const books = []

    mixConfig.forEach((config, index) => {
      const book = this.generateBookFromConfig(config, index)
      books.push(book)
    })

    return books
  }

  /**
   * æ ¹æ“šé…ç½®ç”Ÿæˆæ›¸ç±
   * @param {Object} config - é…ç½®
   * @param {number} index - ç´¢å¼•
   * @returns {Object} æ›¸ç±è³‡æ–™
   * @private
   */
  generateBookFromConfig (config, index) {
    const baseBook = {
      id: `mixed-book-${index}`,
      title: `æ··åˆæ¸¬è©¦æ›¸ç± ${index}`,
      author: `æ··åˆä½œè€… ${index}`,
      progress: 50
    }

    switch (config.type) {
      case 'unicode':
        return {
          ...baseBook,
          title: 'ğŸ“š Unicodeæ›¸ç± ğŸŒŸ',
          author: 'ğŸ‡¹ğŸ‡¼ å°ç£ä½œè€…',
          hasSpecialChars: true
        }

      case 'longTitle':
        return {
          ...baseBook,
          title: 'è¶…é•·æ¨™é¡Œæ¸¬è©¦æ›¸ç±'.repeat(20),
          isLongTitle: true
        }

      case 'missingCover':
        return {
          ...baseBook,
          cover: null,
          hasMissingData: true
        }

      default:
        return baseBook
    }
  }

  /**
   * ç”Ÿæˆæ¸¬è©¦å ´æ™¯é…ç½®
   * @param {string} scenarioType - å ´æ™¯é¡å‹
   * @returns {TestScenario} æ¸¬è©¦å ´æ™¯é…ç½®
   */
  generateTestScenario (scenarioType) {
    const template = this.scenarioTemplates.get(scenarioType)

    if (!template) {
      throw (() => { const error = new Error(TEST_ERROR; error.details = { category: 'testing' }; return error })()
    }

    // å…‹éš†æ¨¡æ¿ä¸¦æ·»åŠ å‹•æ…‹è³‡æ–™
    const scenario = JSON.parse(JSON.stringify(template))

    // æ·»åŠ å‹•æ…‹ç”Ÿæˆçš„è³‡æ–™
    scenario.id = `scenario-${scenarioType}-${Date.now()}`
    scenario.createdAt = new Date().toISOString()
    scenario.testId = `test-${this.generateUUID()}`

    // æ ¹æ“šå ´æ™¯é¡å‹æ·»åŠ ç‰¹å®šé…ç½®
    switch (scenarioType) {
      case 'normalWorkflow':
        scenario.books = this.generateBookCollection({ count: 15 })
        break

      case 'dataIntegrity':
        scenario.books = this.generateMixedBookCollection([
          { type: 'normal' },
          { type: 'unicode' },
          { type: 'longTitle' },
          { type: 'missingCover' }
        ])
        break

      case 'userFeedback':
        scenario.expectedFeedback = [
          'é–‹å§‹æå–æ›¸ç±è³‡æ–™',
          'æ­£åœ¨è™•ç†ç¬¬ 1 æœ¬æ›¸ç±',
          'æå–å®Œæˆï¼Œå…±æ‰¾åˆ° 15 æœ¬æ›¸ç±'
        ]
        break
    }

    return scenario
  }

  /**
   * ç”Ÿæˆæ•ˆèƒ½æ¸¬è©¦è³‡æ–™
   * @param {PerformanceTestConfig} config - æ•ˆèƒ½æ¸¬è©¦é…ç½®
   * @returns {PerformanceTestData} æ•ˆèƒ½æ¸¬è©¦è³‡æ–™
   */
  generatePerformanceTestData (config = {}) {
    const {
      bookCount = 100,
      complexity = 'medium',
      includeHeavyData = false
    } = config

    const testData = {
      books: [],
      expectedMetrics: {
        maxExtractionTime: this.calculateExpectedTime(bookCount),
        maxMemoryUsage: this.calculateExpectedMemory(bookCount),
        minThroughput: this.calculateMinThroughput(bookCount)
      },
      loadProfile: {
        bookCount,
        complexity,
        dataSize: 0
      }
    }

    // ç”Ÿæˆæ•ˆèƒ½æ¸¬è©¦æ›¸ç±
    for (let i = 0; i < bookCount; i++) {
      const book = this.generatePerformanceTestBook(i, complexity)
      testData.books.push(book)
    }

    // å¦‚æœéœ€è¦é‡è³‡æ–™ï¼Œæ·»åŠ å¤§å‹è³‡æ–™
    if (includeHeavyData) {
      testData.books = testData.books.map(book => ({
        ...book,
        largeDescription: 'A'.repeat(1000), // 1KB æè¿°
        metadata: this.generateLargeMetadata()
      }))
    }

    // è¨ˆç®—ç¸½è³‡æ–™å¤§å°
    testData.loadProfile.dataSize = this.estimateDataSize(testData.books)

    return testData
  }

  /**
   * ç”Ÿæˆæ•ˆèƒ½æ¸¬è©¦æ›¸ç±
   * @param {number} index - ç´¢å¼•
   * @param {string} complexity - è¤‡é›œåº¦
   * @returns {Object} æ•ˆèƒ½æ¸¬è©¦æ›¸ç±
   * @private
   */
  generatePerformanceTestBook (index, complexity) {
    const baseBook = {
      id: `perf-book-${index}`,
      title: `æ•ˆèƒ½æ¸¬è©¦æ›¸ç± ${index}`,
      author: `æ•ˆèƒ½ä½œè€… ${index}`,
      progress: this.randomInt(0, 100)
    }

    switch (complexity) {
      case 'low':
        return baseBook

      case 'medium':
        return {
          ...baseBook,
          description: `é€™æ˜¯ä¸­ç­‰è¤‡é›œåº¦çš„æ•ˆèƒ½æ¸¬è©¦æ›¸ç±æè¿° ${index}`,
          tags: [`æ¨™ç±¤${index}`, `åˆ†é¡${index % 5}`, `ä¸»é¡Œ${index % 3}`],
          metadata: {
            pageCount: this.randomInt(100, 300),
            publishYear: 2020 + (index % 4),
            language: index % 2 === 0 ? 'zh-TW' : 'en-US'
          }
        }

      case 'high':
        return {
          ...baseBook,
          title: `é«˜è¤‡é›œåº¦æ•ˆèƒ½æ¸¬è©¦æ›¸ç±æ¨™é¡ŒåŒ…å«å¾ˆå¤šæ–‡å­—å’Œç‰¹æ®Šå­—ç¬¦ ${index} ğŸ“šğŸŒŸ`,
          description: 'é«˜è¤‡é›œåº¦æ›¸ç±æè¿°'.repeat(10),
          tags: Array.from({ length: 20 }, (_, i) => `è¤‡é›œæ¨™ç±¤${i}`),
          metadata: {
            pageCount: this.randomInt(500, 1000),
            chapters: Array.from({ length: 25 }, (_, i) => `ç« ç¯€${i + 1}`),
            reviews: Array.from({ length: 50 }, (_, i) => ({
              rating: this.randomInt(1, 5),
              comment: `è©•è«–å…§å®¹${i}`,
              date: new Date(2023, i % 12, (i % 28) + 1).toISOString()
            }))
          },
          largeData: 'X'.repeat(5000) // 5KB é¡å¤–è³‡æ–™
        }

      default:
        return baseBook
    }
  }

  /**
   * ç”Ÿæˆç‰¹æ®Šå­—ç¬¦æ›¸ç±
   * @param {Object} config - é…ç½®
   * @returns {Array} ç‰¹æ®Šå­—ç¬¦æ›¸ç±
   */
  generateSpecialCharacterBooks (config = {}) {
    const {
      includeEmojis = true,
      includeUnicode = true,
      includeHtmlEntities = true,
      includeCJKCharacters = true
    } = config

    const books = []

    if (includeEmojis) {
      books.push({
        id: 'emoji-book',
        title: 'ğŸ“š Emojiæ¸¬è©¦æ›¸ç± ğŸŒŸğŸ“–âœ¨ğŸ¯ğŸ”¥ğŸ’«ğŸŒˆ',
        author: 'ğŸ˜Š Emojiä½œè€… ğŸ‘¤',
        progress: 50,
        description: 'é€™æœ¬æ›¸åŒ…å«å„ç¨®emojiè¡¨æƒ…ç¬¦è™Ÿ ğŸ‰ğŸŠğŸ'
      })
    }

    if (includeUnicode) {
      books.push({
        id: 'unicode-book',
        title: 'ä¸­æ–‡í•œê¸€ã²ã‚‰ãŒãªØ§Ù„Ø¹Ø±Ø¨ÙŠØ©Ğ ÑƒÑÑĞºĞ¸Ğ¹Î•Î»Î»Î·Î½Î¹ÎºÎ¬',
        author: 'Unicodeæ¸¬è©¦ä½œè€…',
        progress: 25,
        description: 'å¤šèªè¨€Unicodeå­—ç¬¦æ¸¬è©¦ Ã±Ã¡Ã©Ã­Ã³Ãº Ã§Ã±Ã¼ Î±Î²Î³Î´Îµ'
      })
    }

    if (includeHtmlEntities) {
      books.push({
        id: 'html-entities-book',
        title: 'HTMLå¯¦é«”æ¸¬è©¦ï¼š&lt;&gt;&amp;&quot;&apos;',
        author: 'HTML & XML å°ˆå®¶',
        progress: 75,
        description: 'åŒ…å«HTMLå¯¦é«”å­—ç¬¦çš„æ¸¬è©¦æ›¸ç±'
      })
    }

    if (includeCJKCharacters) {
      books.push({
        id: 'cjk-book',
        title: 'ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—æ¸¬è©¦ï¼šæ¼¢å­—ã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠí•œê¸€',
        author: 'CJKæ–‡å­—å°ˆå®¶',
        progress: 60,
        description: 'CJKçµ±ä¸€è¡¨æ„æ–‡å­—å’Œè¡¨éŸ³æ–‡å­—æ¸¬è©¦'
      })
    }

    return books
  }

  /**
   * ç”Ÿæˆé‚Šç•Œæ¢ä»¶æ›¸ç±
   * @param {Object} config - é…ç½®
   * @returns {Array} é‚Šç•Œæ¢ä»¶æ›¸ç±
   */
  generateEdgeCaseBooks (config = {}) {
    const {
      longTitles = true,
      missingData = true,
      corruptedData = true,
      oversizedData = true
    } = config

    const books = []

    if (longTitles) {
      books.push({
        id: 'long-title-book',
        title: 'è¶…ç´šé•·æ¨™é¡Œæ¸¬è©¦æ›¸ç±'.repeat(50),
        author: 'é•·åç¨±ä½œè€…'.repeat(10),
        progress: 30,
        isLongTitle: true
      })
    }

    if (missingData) {
      books.push(
        {
          id: 'missing-title-book',
          title: '',
          author: 'æœ‰ä½œè€…ä½†æ²’æ¨™é¡Œ',
          progress: 40
        },
        {
          id: 'missing-author-book',
          title: 'æœ‰æ¨™é¡Œä½†æ²’ä½œè€…',
          author: '',
          progress: 60
        },
        {
          id: 'null-data-book',
          title: null,
          author: null,
          progress: null,
          cover: null
        }
      )
    }

    if (corruptedData) {
      books.push({
        id: 'corrupted-book',
        title: 'JSONæ¸¬è©¦ï¼š"\\u0000\\u0001\\u0002',
        author: 'ç‰¹æ®Šæ§åˆ¶å­—ç¬¦ä½œè€…',
        progress: 'invalid', // éæ•¸å­—é€²åº¦
        invalidField: { circular: null }
      })
    }

    if (oversizedData) {
      books.push({
        id: 'oversized-book',
        title: 'è¶…å¤§è³‡æ–™æ¸¬è©¦æ›¸ç±',
        author: 'å¤§è³‡æ–™ä½œè€…',
        progress: 50,
        massiveDescription: 'A'.repeat(100000), // 100KB æè¿°
        hugeArray: Array.from({ length: 10000 }, (_, i) => `é …ç›®${i}`)
      })
    }

    return books
  }

  /**
   * ç”Ÿæˆè¤‡é›œæ›¸ç±é›†åˆ
   * @param {Object} config - é…ç½®
   * @returns {Array} è¤‡é›œæ›¸ç±é›†åˆ
   */
  generateComplexBookCollection (config = {}) {
    const {
      includeProgressVariations = true,
      includeMetadataVariations = true,
      includeFormatVariations = true
    } = config

    const books = []
    const baseCount = 20

    for (let i = 0; i < baseCount; i++) {
      const book = {
        id: `complex-book-${i}`,
        title: `è¤‡é›œæ¸¬è©¦æ›¸ç± ${i}`,
        author: `è¤‡é›œä½œè€… ${i}`,
        progress: 50
      }

      if (includeProgressVariations) {
        // å„ç¨®é€²åº¦å€¼è®ŠåŒ–
        book.progress = [0, 25, 50, 75, 100, null, -1, 101][i % 8]
        book.progressHistory = Array.from({ length: 5 }, (_, j) => ({
          date: new Date(2023, j, 1).toISOString(),
          progress: j * 20
        }))
      }

      if (includeMetadataVariations) {
        // å„ç¨®å…ƒè³‡æ–™è®ŠåŒ–
        book.metadata = {
          isbn: i % 2 === 0 ? `978-${String(i).padStart(10, '0')}` : null,
          publishYear: i % 3 === 0 ? 2020 + (i % 5) : null,
          genre: ['å°èªª', 'ç§‘æŠ€', 'æ­·å²', 'è—è¡“', null][i % 5],
          language: ['zh-TW', 'en-US', 'ja-JP', null][i % 4]
        }
      }

      if (includeFormatVariations) {
        // å„ç¨®æ ¼å¼è®ŠåŒ–
        book.formats = [
          { type: 'epub', available: i % 2 === 0 },
          { type: 'pdf', available: i % 3 === 0 },
          { type: 'audio', available: i % 5 === 0 }
        ]
      }

      books.push(book)
    }

    return books
  }

  /**
   * ç”Ÿæˆç¾æœ‰å„²å­˜è³‡æ–™
   * @param {Object} config - é…ç½®
   * @returns {Object} ç¾æœ‰å„²å­˜è³‡æ–™
   */
  generateExistingStorageData (config = {}) {
    const { count = 10 } = config

    const existingBooks = this.generateBookCollection({ count, type: 'normal' })

    return {
      books: existingBooks,
      metadata: {
        totalBooks: count,
        lastUpdate: new Date().toISOString(),
        version: '1.0.0'
      },
      userSettings: {
        autoSync: true,
        defaultView: 'grid',
        sortBy: 'title'
      }
    }
  }

  /**
   * è¨ˆç®—é æœŸè™•ç†æ™‚é–“
   * @param {number} bookCount - æ›¸ç±æ•¸é‡
   * @returns {number} é æœŸæ™‚é–“ (æ¯«ç§’)
   * @private
   */
  calculateExpectedTime (bookCount) {
    // åŸºæ–¼æ›¸ç±æ•¸é‡çš„ç·šæ€§ä¼°ç®—
    const baseTime = 1000 // 1ç§’åŸºç¤æ™‚é–“
    const perBookTime = 10 // æ¯æœ¬æ›¸10æ¯«ç§’
    return baseTime + (bookCount * perBookTime)
  }

  /**
   * è¨ˆç®—é æœŸè¨˜æ†¶é«”ä½¿ç”¨
   * @param {number} bookCount - æ›¸ç±æ•¸é‡
   * @returns {number} é æœŸè¨˜æ†¶é«” (å­—ç¯€)
   * @private
   */
  calculateExpectedMemory (bookCount) {
    const baseMemory = 10 * 1024 * 1024 // 10MB åŸºç¤è¨˜æ†¶é«”
    const perBookMemory = 1024 // æ¯æœ¬æ›¸1KB
    return baseMemory + (bookCount * perBookMemory)
  }

  /**
   * è¨ˆç®—æœ€å°ååé‡
   * @param {number} bookCount - æ›¸ç±æ•¸é‡
   * @returns {number} æœ€å°ååé‡ (books/second)
   * @private
   */
  calculateMinThroughput (bookCount) {
    return Math.max(1, bookCount / 10) // è‡³å°‘æ¯ç§’è™•ç†1æœ¬æ›¸
  }

  /**
   * ç”Ÿæˆå¤§å‹å…ƒè³‡æ–™
   * @returns {Object} å¤§å‹å…ƒè³‡æ–™
   * @private
   */
  generateLargeMetadata () {
    return {
      tags: Array.from({ length: 100 }, (_, i) => `æ¨™ç±¤${i}`),
      reviews: Array.from({ length: 200 }, (_, i) => ({
        id: i,
        rating: this.randomInt(1, 5),
        comment: `è©•è«–å…§å®¹${i}`.repeat(10),
        date: new Date(2023, i % 12, (i % 28) + 1).toISOString()
      })),
      statistics: Array.from({ length: 365 }, (_, i) => ({
        date: new Date(2023, 0, i + 1).toISOString(),
        readingTime: this.randomInt(0, 120),
        pagesRead: this.randomInt(0, 50)
      }))
    }
  }

  /**
   * ä¼°ç®—è³‡æ–™å¤§å°
   * @param {Array} data - è³‡æ–™é™£åˆ—
   * @returns {number} ä¼°ç®—å¤§å° (å­—ç¯€)
   * @private
   */
  estimateDataSize (data) {
    // ç°¡å–®ä¼°ç®—ï¼šåºåˆ—åŒ–å¾Œçš„å­—ç¬¦ä¸²é•·åº¦
    try {
      return JSON.stringify(data).length
    } catch (error) {
      return data.length * 1000 // æ¯ç­†è³‡æ–™ä¼°ç®—1KB
    }
  }

  /**
   * ç”ŸæˆUUID
   * @returns {string} UUID
   * @private
   */
  generateUUID () {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
      const r = Math.random() * 16 | 0
      const v = c === 'x' ? r : (r & 0x3 | 0x8)
      return v.toString(16)
    })
  }

  /**
   * è¨­å®šéš¨æ©Ÿç¨®å­ (ç°¡åŒ–ç‰ˆ)
   * @param {number} seed - ç¨®å­å€¼
   * @private
   */
  setSeed (seed) {
    this.randomSeed = seed
  }

  /**
   * ç”Ÿæˆéš¨æ©Ÿæ•´æ•¸
   * @param {number} min - æœ€å°å€¼
   * @param {number} max - æœ€å¤§å€¼
   * @returns {number} éš¨æ©Ÿæ•´æ•¸
   * @private
   */
  randomInt (min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min
  }

  /**
   * æ¸…é™¤è³‡æ–™å¿«å–
   */
  clearCache () {
    this.dataCache.clear()
  }

  /**
   * ç²å–å¿«å–çµ±è¨ˆ
   * @returns {Object} å¿«å–çµ±è¨ˆ
   */
  getCacheStats () {
    return {
      size: this.dataCache.size,
      keys: Array.from(this.dataCache.keys())
    }
  }
}

module.exports = E2ETestDataGenerator
